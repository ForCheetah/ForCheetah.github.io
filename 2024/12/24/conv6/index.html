<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="alternate" href="/rss.xml" title="Пусть этот камень будет более крепким, чем человек" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Пусть этот камень будет более крепким, чем человек" type="application/atom+xml"><link rel="alternate" type="application/json" title="Пусть этот камень будет более крепким, чем человек" href="https://forcheetah.github.io/feed.json"><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext" media="none" onload="this.media='all'"><link rel="stylesheet" href="/css/app.css?v=0.4.2"><link rel="modulepreload" href="/js/chunk-FJ7AJ5BW.js"><link rel="modulepreload" href="/js/chunk-MQTNP6EI.js"><link rel="modulepreload" href="/js/chunk-QAWHJ5B3.js"><link rel="modulepreload" href="/js/index.esm-SU253EAQ.js"><link rel="modulepreload" href="/js/post-SZ2V6ERD.js"><link rel="modulepreload" href="/js/quicklink-GO25OZIT.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo7.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo4.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo8.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo5.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo9.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo11.webp" as="image" fetchpriority="high"><meta name="keywords" content="conv,"><meta name="description" content="有自己的博客很帅，但是我很懒，要命！！！"><link rel="canonical" href="https://forcheetah.github.io/2024/12/24/conv6/"><title>【Gemm】内存对齐</title><meta name="generator" content="Hexo 7.0.0"></head><body itemscope="" itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">【Gemm】内存对齐</h1><div class="meta"><span class="item" title="Created: 2024-12-24 20:44:31"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">Posted on</span><time itemprop="dateCreated datePublished" datetime="2024-12-24T20:44:31+08:00">2024-12-24</time></span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i></span><span class="text">Symbols count in article</span><span>8.5k</span><span class="text">words</span></span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i></span><span class="text">Reading time</span><span>8 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">暮冬Z羡慕的博客</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo7.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo4.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo8.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo5.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo9.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo11.webp&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement="" itemscope="" itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">Home</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/%E5%8D%B7%E7%A7%AF%E5%8A%A0%E9%80%9F/" itemprop="item" rel="index" title="In卷积加速"><span itemprop="name">卷积加速<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="en"><link itemprop="mainEntityOfPage" href="https://forcheetah.github.io/2024/12/24/conv6/"><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.webp"><meta itemprop="name" content="XianMu"><meta itemprop="description" content="神经网络推理、加速、AI编译。 我必须立刻开始挣扎！, 有自己的博客很帅，但是我很懒，要命！！！"></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Пусть этот камень будет более крепким, чем человек"></span><div class="body md" itemprop="articleBody"><h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1>
<p>本篇文章梳理内存对齐的相关概念和知识，并借上一篇文章<a href="https://forcheetah.github.io/2024/12/20/conv5/">《【Gemm】Gemm 计算加速》</a> 来简单探讨一下内存排布对计算加速的重要作用。</p>
<p>本篇文章参考和引用了 <a target="_blank" rel="noopener" href="https://github.com/Tencent/ncnn">《nihui 大佬的 ncnn 工程》</a>，<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/336359747?utm_id=0">《ncnn 初探二：图解 ncnn::Mat 的内存排布》</a>，<a target="_blank" rel="noopener" href="https://github.com/Tencent/ncnn/issues/334">关于 mat 中 data 的内存排列问题</a>，<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/632640984">《Linux 内核：内存管理 —— 内存对齐》</a>等，并询问过大语言模型通义千问、文心一言等。如有不清楚的地方可以点击链接查阅。</p>
<p>作为初学者，错误在所难免，还望不吝赐教。</p>
<h1 id="处理器的对齐访问"><a class="anchor" href="#处理器的对齐访问">#</a> 处理器的对齐访问</h1>
<p>对齐访问的定义：对齐访问是指处理器在访问内存时，要求访问的起始地址是某个特定数值（通常是 2 的幂）的整数倍。这种对齐方式有助于简化内存访问的电路设计和提高访问效率。</p>
<p>例如某处理器读取 int 类型数据时，内存读取粒度为 4，只能从 0x10000， 0x10004 这种 4 的整数倍地址为起始地址读取内存。当该 int 类型数据恰好存储在这样的地址时，称为自然对齐。</p>
<p>那么，处理器只能进行对齐访问吗？大语言模型给出这样解答：</p>
<pre><code>一、处理器在访问内存时，并不总是只能进行对齐访问，这取决于处理器的具体架构和设计。
    1.某些处理器要求对齐访问：
例如，一些ARM架构的处理器在访问内存时要求对齐。如果访问的起始地址不满足对齐要求，处理器可能会产生异常或错误。
    2.复杂指令集处理器（如x86架构）的灵活性：
x86架构的处理器通常能够处理非对齐的内存访问。虽然它们可能不是一次性读出所需的数据，而是采取多次读取对齐的内存并进行数据拼接的方式来实现非对齐数据访问，但这仍然表明x86处理器在处理非对齐访问方面具有一定的灵活性。

二、处理器单次访问的对齐要求
    为了保持硬件设计的简单性和高效性，单次内存访问确实要求是对齐的。这是因为对齐访问可以确保数据在内存中的布局与处理器的数据路径相匹配，从而避免额外的处理步骤和性能损失。

</code></pre>
<p>从上面来看，处理器单次内存访问是要求对齐访问的，所谓支持的非对齐访问也是由多次对齐访问，再加上舍弃和拼接实现的。</p>
<h1 id="内存对齐"><a class="anchor" href="#内存对齐">#</a> 内存对齐</h1>
<p>内存对齐：如果一个变量的内存地址刚好位于它本身长度的整数倍，他就被称做自然对齐。</p>
<p>这里比较一下内存对齐 和 内存没有对齐的情况下， 处理器内存访问效率。</p>
<p><img loading="lazy" data-src="1735043896070.webp" alt="图1"></p>
<p>假设现在需要将四个字节的 float 数据搬到寄存器，上图的 float 数据自然对齐，位于 0x1000，那么将该 float 数据搬到寄存器只需要访问一次内存。</p>
<p>下图 float 数据没有自然对齐，位于 0x1002，那么需要将 0x1000 到 0x1003 的数据取出，留下 0x1002 到 0x1003 两个字节。再将 0x1004 到 0x1007 的数据取出，留下 0x1004 到 0x1005 两个字节，最终拼成需要的 float 数据。</p>
<p>在没有自然对齐的情况下，需要两次内存访问，还要消耗数据拼接等指令的时间。</p>
<h1 id="编译器内存对齐"><a class="anchor" href="#编译器内存对齐">#</a> 编译器内存对齐</h1>
<p>为实现高效的内存访问，编译器有一套内存对齐的规则。</p>
<p>例如下面的代码，在 64 位系统中，char 类型占 1 个字节，double 类型占 8 个字节。但是下面的结构体占用内存并不是 9 个字节，而是 16 个字节。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">char</span> a<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">double</span> ff<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">}</span> struct_elem<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    </pre></td></tr><tr><td data-num="11"></td><td><pre>    struct_elem sclass<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>struct_elem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"addr_char:%p   addr_double:%p  \n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sclass<span class="token punctuation">.</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sclass<span class="token punctuation">.</span>ff<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><pre><code>16
addr_char:0x7ffc631cdd70   addr_double:0x7ffc631cdd78 
</code></pre>
<p>打印结果如上所示，char 数据的地址是 <code>0x7ffc631cdd70</code> ，为了让 double 数据也能自然对齐，char 数据后面空出来 7 个字节，直到第 8 个字节，也就是 <code>0x7ffc631cdd78</code>  才开始存储 double。</p>
<p><img loading="lazy" data-src="1735044044909.webp" alt="图2"></p>
<p>那么，如果将上述结构体中的 char 和 double 数据调换一下位置，是不是结构体的内存占用就变成 9 字节了呢？也不是，仍然是 16 字节。这就设计到下面的结构体内存分配规则了，这里不做讨论。</p>
<pre><code>1.第一个成员在结构体变量偏移量为0 的地址处，也就是第一个成员必须从头开始。
2.以后每个成员相对于结构体首地址的 offset 都是该成员大小的整数倍，如有需要编译器会在成员之间加上填充字节。
3.结构体的总大小为 最大对齐数的整数倍（每个成员变量都有自己的对齐数），如有需要编译器会在最末一个成员之后加上填充字节。
4.如果嵌套结构体，嵌套的结构体对齐到自己的最大对齐数的整数倍处，结构体的整体大小就是所有最大对齐数（包含嵌套结构体的对齐数）的整数倍。
</code></pre>
<h1 id="ncnn-内存对齐"><a class="anchor" href="#ncnn-内存对齐">#</a> ncnn 内存对齐</h1>
<p>既然编译器帮助我们实现了内存对齐，程序员是不是就不需要再关注内存对齐了呢？</p>
<p>肯定是不行的，编译器只保证了基本自然对齐，在高性能计算、图形处理等方面，还需要程序员手动内存对齐。这里学习一下 NCNN 工程的矩阵排布方式：</p>
<p>下面是 ncnn 源码中构建三维矩阵（c,h,w），也就是通道、高度、宽度三个维度，的内存开辟函数。</p>
<p>变量的意义，来自<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/336359747?utm_id=0">《ncnn 初探二：图解 ncnn::Mat 的内存排布》</a></p>
<pre><code>data: 表示Mat分配的内存的头地址, 是一个指针类型
refcount: 表示Mat的引用计数, 是一个指针类型
allocator: 本章我们不太关系这个变量可以认为它的值始终为0, 是一个指针类型
dims: 表示数据的维度, 是一个整数类型
w: 表示数据的width, 是一个整数类型
h: 表示数据的height, 是一个整数类型
c: 表示数据的channel, 是一个整数类型
elempack: 表示有多少个数据打包在一起, 是一个整数类型
elemsize: 表示打包在一起的数据占的字节数, 是一个整数类型
cstep: 表示channel step, 即走一个channel跨过的元素个数, 是一个整数类型
</code></pre>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment">// 创建 三维矩阵（c,h,w）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">int</span> _w<span class="token punctuation">,</span> <span class="token keyword">int</span> _h<span class="token punctuation">,</span> <span class="token keyword">int</span> _c<span class="token punctuation">,</span> size_t _elemsize<span class="token punctuation">,</span> Allocator<span class="token operator">*</span> _allocator<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dims <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> w <span class="token operator">==</span> _w <span class="token operator">&amp;&amp;</span> h <span class="token operator">==</span> _h <span class="token operator">&amp;&amp;</span> c <span class="token operator">==</span> _c <span class="token operator">&amp;&amp;</span> elemsize <span class="token operator">==</span> _elemsize <span class="token operator">&amp;&amp;</span> elempack <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> allocator <span class="token operator">==</span> _allocator<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    elemsize <span class="token operator">=</span> _elemsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    elempack <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    allocator <span class="token operator">=</span> _allocator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    dims <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    w <span class="token operator">=</span> _w<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    h <span class="token operator">=</span> _h<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    d <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    c <span class="token operator">=</span> _c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    cstep <span class="token operator">=</span> <span class="token function">alignSize</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>w <span class="token operator">*</span> h <span class="token operator">*</span> elemsize<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">/</span> elemsize<span class="token punctuation">;</span>   <span class="token comment">//w*h 16 字节对齐</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    size_t totalsize <span class="token operator">=</span> <span class="token function">alignSize</span><span class="token punctuation">(</span><span class="token function">total</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> elemsize<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//c*cstep 4 字节对齐</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalsize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>allocator<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            data <span class="token operator">=</span> allocator<span class="token operator">-&gt;</span><span class="token function">fastMalloc</span><span class="token punctuation">(</span>totalsize <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>refcount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            data <span class="token operator">=</span> <span class="token function">fastMalloc</span><span class="token punctuation">(</span>totalsize <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>refcount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        refcount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> totalsize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 连接计数器，放在了 data 最后</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token operator">*</span>refcount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>再看一下  <code>alignSize</code>  函数：其用于返回不小于 <code>sz</code>  的 <code>n</code>  的最小倍数。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">alignSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> sz<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>sz <span class="token operator">+</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">-</span>n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>那么上述创建 三维矩阵（c,h,w）</p>
<p>我们以（c,h,w）：（4,2,3）为例，通道为 4，高为 2，宽为 3，开辟的内存及数据存放如下图所示：</p>
<pre><code>   0        1        2         3          4        5        6       7
c0h0w0    c0h0w1    c0h0w2    c0h1w0    c0h1w1    c0h1w2    pad    pad
c1h0w0    c1h0w1    c1h0w2    c1h1w0    c1h1w1    c1h1w2    pad    pad
c2h0w0    c2h0w1    c2h0w2    c2h1w0    c2h1w1    c2h1w2    pad    pad
c3h0w0    c3h0w1    c3h0w2    c3h1w0    c3h1w1    c3h1w2    pad    pad
</code></pre>
<p>高乘宽 h<em>w，长度为 6， <code>alignSize((size_t)w * h * elemsize, 16) / elemsize;</code>  按照 16 字节对齐，会分配 8 个元素的空间，当前 h</em>w 只占了六个元素的空间，其余两个空间 pad 补零。  <code>cstep</code>  为 8，而不是 6。</p>
<p>访问：</p>
<pre><code>mat.data -&gt; address of c0h0w0
mat.row(1) -&gt; address of c0h1w0
mat.channel(0).row(1) -&gt; address of c0h1w0
mat.channel(1).row(1) -&gt; address of c1h1w0

</code></pre>
<p>所以 ncnn 的 16 字节对齐是每个通道 16 字节对齐。<br>
访问每一个通道时，mat.channel (0)，所有 16 字节的数据，也就是 128bit 数据，能够一次内存访问加载到 SSE2 等 128 位寄存器中。</p>
<p>采用 16 字节对齐有哪些优势呢？大语言模型的回答：</p>
<ol>
<li>提高数据访问效率</li>
</ol>
<ul>
<li>SIMD 指令集优化：现代 CPU 支持单指令多数据（SIMD）指令集，如 SSE、AVX 等。这些指令可以在一个周期内处理多个数据点，但要求操作数在内存中是连续且对齐的。16 字节对齐确保了当使用 128 位宽的 SIMD 寄存器（例如 SSE 指令）时，数据可以直接加载到寄存器中而无需额外调整，从而提高了指令执行速度。</li>
<li>缓存行利用：大多数 CPU 的缓存行大小为 64 字节或更大，16 字节对齐有助于更好地匹配缓存行边界，减少缓存未命中率，进而提升内存访问效率。</li>
</ul>
<ol start="2">
<li>减少内存访问延迟</li>
</ol>
<ul>
<li>避免跨页访问：如果数据跨越了不同的内存页面，操作系统需要额外的时间来处理页面错误和更新页表。通过保持 16 字节对齐，可以降低这种跨页访问的可能性，特别是在处理大量小型数据结构时。</li>
</ul>
<h1 id="gemm内存对齐的好处"><a class="anchor" href="#gemm内存对齐的好处">#</a> gemm 内存对齐的好处</h1>
<p>以<a href="https://forcheetah.github.io/2024/12/20/conv5/">《【Gemm】Gemm 计算加速》</a> 中的 《6. 使用 SIMD 指令》为例，如果矩阵 B（K*N）在宽度 N 方向进行 16 字节对齐（将 N pad 到 16 字节的倍数），那么算法最内存循环中的 <code>__m128 b_reg = _mm_loadu_ps(&amp;B(p, 0));</code> ，将会避免非对齐访问问题，在任何情况下读取的 16 字节数据都是自然对齐的。同时也避免了算法在矩阵 B 中的越界问题。</p>
<p><img loading="lazy" data-src="1735044231568.webp" alt="3333"></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;emmintrin.h&gt;</span> <span class="token comment">// SSE2</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">A</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span> a<span class="token punctuation">[</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>lda <span class="token operator">+</span> <span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token punctuation">]</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">B</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span> b<span class="token punctuation">[</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>ldb <span class="token operator">+</span> <span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token punctuation">]</span></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">C</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">,</span>j<span class="token punctuation">)</span> c<span class="token punctuation">[</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>ldc <span class="token operator">+</span> <span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token punctuation">]</span></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/* Routine for computing C = A * B + C */</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">void</span> <span class="token function">AddDot4x4_SSE2</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> lda<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">int</span> ldb<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> ldc<span class="token punctuation">)</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/* Point to the current elements in the four rows of A */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">float</span> <span class="token operator">*</span>a_0p_pntr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">float</span> <span class="token operator">*</span>a_1p_pntr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">float</span> <span class="token operator">*</span>a_2p_pntr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">float</span> <span class="token operator">*</span>a_3p_pntr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    __m128 c_p0_sum <span class="token operator">=</span> <span class="token function">_mm_setzero_ps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    __m128 c_p1_sum <span class="token operator">=</span> <span class="token function">_mm_setzero_ps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    __m128 c_p2_sum <span class="token operator">=</span> <span class="token function">_mm_setzero_ps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    __m128 c_p3_sum <span class="token operator">=</span> <span class="token function">_mm_setzero_ps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">register</span> <span class="token keyword">float</span> a_0p_reg<span class="token punctuation">,</span> a_1p_reg<span class="token punctuation">,</span> a_2p_reg<span class="token punctuation">,</span> a_3p_reg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> k<span class="token punctuation">;</span> <span class="token operator">++</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        __m128 b_reg <span class="token operator">=</span> <span class="token function">_mm_loadu_ps</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token function">B</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 没有 16 字节对齐的情况下，可能会出现非对齐访问</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        a_0p_reg <span class="token operator">=</span> <span class="token operator">*</span>a_0p_pntr<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        a_1p_reg <span class="token operator">=</span> <span class="token operator">*</span>a_1p_pntr<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        a_2p_reg <span class="token operator">=</span> <span class="token operator">*</span>a_2p_pntr<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        a_3p_reg <span class="token operator">=</span> <span class="token operator">*</span>a_3p_pntr<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        __m128 a_0p_vec <span class="token operator">=</span> <span class="token function">_mm_set_ps1</span><span class="token punctuation">(</span>a_0p_reg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        __m128 a_1p_vec <span class="token operator">=</span> <span class="token function">_mm_set_ps1</span><span class="token punctuation">(</span>a_1p_reg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        __m128 a_2p_vec <span class="token operator">=</span> <span class="token function">_mm_set_ps1</span><span class="token punctuation">(</span>a_2p_reg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        __m128 a_3p_vec <span class="token operator">=</span> <span class="token function">_mm_set_ps1</span><span class="token punctuation">(</span>a_3p_reg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        c_p0_sum <span class="token operator">=</span> <span class="token function">_mm_add_ps</span><span class="token punctuation">(</span>c_p0_sum<span class="token punctuation">,</span> <span class="token function">_mm_mul_ps</span><span class="token punctuation">(</span>b_reg<span class="token punctuation">,</span> a_0p_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        c_p1_sum <span class="token operator">=</span> <span class="token function">_mm_add_ps</span><span class="token punctuation">(</span>c_p1_sum<span class="token punctuation">,</span> <span class="token function">_mm_mul_ps</span><span class="token punctuation">(</span>b_reg<span class="token punctuation">,</span> a_1p_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        c_p2_sum <span class="token operator">=</span> <span class="token function">_mm_add_ps</span><span class="token punctuation">(</span>c_p2_sum<span class="token punctuation">,</span> <span class="token function">_mm_mul_ps</span><span class="token punctuation">(</span>b_reg<span class="token punctuation">,</span> a_2p_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        c_p3_sum <span class="token operator">=</span> <span class="token function">_mm_add_ps</span><span class="token punctuation">(</span>c_p3_sum<span class="token punctuation">,</span> <span class="token function">_mm_mul_ps</span><span class="token punctuation">(</span>b_reg<span class="token punctuation">,</span> a_3p_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">float</span> <span class="token operator">*</span>c_pntr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    __m128 c_reg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    c_pntr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    c_reg <span class="token operator">=</span> <span class="token function">_mm_loadu_ps</span><span class="token punctuation">(</span>c_pntr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    c_reg <span class="token operator">=</span> <span class="token function">_mm_add_ps</span><span class="token punctuation">(</span>c_reg<span class="token punctuation">,</span> c_p0_sum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token function">_mm_storeu_ps</span><span class="token punctuation">(</span>c_pntr<span class="token punctuation">,</span> c_reg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    c_pntr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    c_reg <span class="token operator">=</span> <span class="token function">_mm_loadu_ps</span><span class="token punctuation">(</span>c_pntr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    c_reg <span class="token operator">=</span> <span class="token function">_mm_add_ps</span><span class="token punctuation">(</span>c_reg<span class="token punctuation">,</span> c_p1_sum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token function">_mm_storeu_ps</span><span class="token punctuation">(</span>c_pntr<span class="token punctuation">,</span> c_reg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    c_pntr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    c_reg <span class="token operator">=</span> <span class="token function">_mm_loadu_ps</span><span class="token punctuation">(</span>c_pntr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    c_reg <span class="token operator">=</span> <span class="token function">_mm_add_ps</span><span class="token punctuation">(</span>c_reg<span class="token punctuation">,</span> c_p2_sum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token function">_mm_storeu_ps</span><span class="token punctuation">(</span>c_pntr<span class="token punctuation">,</span> c_reg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>    c_pntr <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">C</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    c_reg <span class="token operator">=</span> <span class="token function">_mm_loadu_ps</span><span class="token punctuation">(</span>c_pntr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    c_reg <span class="token operator">=</span> <span class="token function">_mm_add_ps</span><span class="token punctuation">(</span>c_reg<span class="token punctuation">,</span> c_p3_sum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token function">_mm_storeu_ps</span><span class="token punctuation">(</span>c_pntr<span class="token punctuation">,</span> c_reg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token keyword">void</span> <span class="token function">MY_MMult_4x4_10</span><span class="token punctuation">(</span><span class="token keyword">int</span> m<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> lda<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">int</span> ldb<span class="token punctuation">,</span> <span class="token keyword">float</span> <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> ldc<span class="token punctuation">)</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> j <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">/* Loop over the columns of C, unrolled by 4 */</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/* Loop over the rows of C */</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            <span class="token function">AddDot4x4_SSE2</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token function">A</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lda<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token function">B</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span> ldb<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token function">C</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span> ldc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre><span class="token keyword">void</span> <span class="token function">GemmAccelerateSimd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">int</span> M <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">int</span> K <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">int</span> N <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">float</span><span class="token operator">*</span> MatriA <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token operator">*</span> M<span class="token operator">*</span>K<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">float</span><span class="token operator">*</span> MatriB <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token operator">*</span> K<span class="token operator">*</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">float</span><span class="token operator">*</span> MatriC <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token operator">*</span> M<span class="token operator">*</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> index<span class="token operator">&lt;</span>M<span class="token operator">*</span>K<span class="token punctuation">;</span> index<span class="token operator">&lt;</span>M<span class="token operator">*</span>K<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        MatriA<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> index<span class="token operator">&lt;</span>K<span class="token operator">*</span>N<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        MatriB<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token function">MY_MMult_4x4_10</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span>N<span class="token punctuation">,</span>K<span class="token punctuation">,</span>MatriA<span class="token punctuation">,</span>K<span class="token punctuation">,</span>MatriB<span class="token punctuation">,</span>N<span class="token punctuation">,</span>MatriC<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><h1 id="后记"><a class="anchor" href="#后记">#</a> 后记</h1>
<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a target="_blank" rel="noopener" href="https://github.com/ForCheetah/ForCheetah.github.io">github 项目</a> 或随便一个项目下提出 issue，或者<a target="_blank" rel="noopener" href="https://www.zhihu.com/people/guai-dao-ji-de-3-50">知乎</a> 私信，并指明哪一篇博客，我看到一定及时回复，感激不尽！</p>
<div class="tags"><a href="/tags/conv/" rel="tag"><i class="ic i-tag"></i>conv</a><a href="/tags/gemm/" rel="tag"><i class="ic i-tag"></i>gemm</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">Edited on</span><time title="Modified: 2024-12-24 20:44:43" itemprop="dateModified" datetime="2024-12-24T20:44:43+08:00">2024-12-24</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.webp" alt="XianMu WeChat Pay"><p>WeChat Pay</p></div><div><img loading="lazy" data-src="/assets/alipay.webp" alt="XianMu Alipay"><p>Alipay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>XianMu<i class="ic i-at"><em>@</em></i>Пусть этот камень будет более крепким, чем человек</li><li class="link"><strong>Post link: </strong><a href="https://forcheetah.github.io/2024/12/24/conv6/" title="【Gemm】内存对齐">https://forcheetah.github.io/2024/12/24/conv6/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2024/12/20/conv5/" rel="prev" itemprop="url" data-background-image="https://forcheetah.github.io/assets/girl.webp" title="【gemm】Gemm计算加速"><span class="type">Previous Post</span><span class="category"><i class="ic i-flag"></i>卷积加速</span><h3>【gemm】Gemm计算加速</h3></a></div><div class="item right"><a href="/2025/01/03/quanti01/" rel="next" itemprop="url" data-background-image="https://forcheetah.github.io/assets/lunbo3.webp" title="【量化】连续卷积层首尾量化的可行性"><span class="type">Next Post</span><span class="category"><i class="ic i-flag"></i>量化</span><h3>【量化】连续卷积层首尾量化的可行性</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E5%AF%B9%E9%BD%90%E8%AE%BF%E9%97%AE"><span class="toc-number">2.</span> <span class="toc-text"> 处理器的对齐访问</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="toc-number">3.</span> <span class="toc-text"> 内存对齐</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="toc-number">4.</span> <span class="toc-text"> 编译器内存对齐</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ncnn-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="toc-number">5.</span> <span class="toc-text"> ncnn 内存对齐</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gemm%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-number">6.</span> <span class="toc-text"> gemm 内存对齐的好处</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">7.</span> <span class="toc-text"> 后记</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2024/05/23/conv1/" rel="bookmark" title="【Im2Col】卷积加速算法【1】 NCHW">【Im2Col】卷积加速算法【1】 NCHW</a></li><li><a href="/2024/05/23/conv2/" rel="bookmark" title="【Im2Col】卷积加速算法【2】NHWC">【Im2Col】卷积加速算法【2】NHWC</a></li><li><a href="/2024/06/27/conv3_/" rel="bookmark" title="【im2col】AScend conv accelerate">【im2col】AScend conv accelerate</a></li><li><a href="/2024/07/07/conv4/" rel="bookmark" title="【Winograd】卷积加速算法原理及实现">【Winograd】卷积加速算法原理及实现</a></li><li><a href="/2024/12/20/conv5/" rel="bookmark" title="【gemm】Gemm计算加速">【gemm】Gemm计算加速</a></li><li class="active"><a href="/2024/12/24/conv6/" rel="bookmark" title="【Gemm】内存对齐">【Gemm】内存对齐</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="XianMu" src="/assets/avatar.webp"><p class="name" itemprop="name">XianMu</p><div class="description" itemprop="description">有自己的博客很帅，但是我很懒，要命！！！</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">42</span><span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">16</span><span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">21</span><span class="name">tags</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/ForCheetah" class="item github" title="https://github.com/ForCheetah"><i class="ic i-github"></i></a><a target="_blank" rel="noopener" href="https://www.zhihu.com/people/guai-dao-ji-de-3-50" class="item zhihu" title="https://www.zhihu.com/people/guai-dao-ji-de-3-50"><i class="ic i-zhihu"></i></a><a href="/huasen.w@foxmail.com" class="item email" title="huasen.w@foxmail.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2025/01/03/quanti01/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2024/12/20/conv5/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E6%9D%82%E8%B0%88/" title="In杂谈">杂谈</a></div><span><a href="/2025/05/04/zatanNoval3/">【感想】写作进度报告3</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/tvm/" title="Intvm">tvm</a></div><span><a href="/2024/10/10/tvm01/">【TVM】通过代码学习编译流程【1】必要知识</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%8D%B7%E7%A7%AF%E5%8A%A0%E9%80%9F/" title="In卷积加速">卷积加速</a></div><span><a href="/2024/05/23/conv1/">【Im2Col】卷积加速算法【1】 NCHW</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" title="In常见问题">常见问题</a></div><span><a href="/2024/05/14/cpplib/">C语言工程调用Cpp库解决方案</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/tvm/" title="Intvm">tvm</a></div><span><a href="/2024/10/13/tvm02/">【TVM】通过代码学习编译流程【2】模型转换</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/compile/" title="Incompile">compile</a></div><span><a href="/2025/01/15/aicompile03/">【AI编译】layer-group之后如何tiling</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%9D%82%E8%B0%88/" title="In杂谈">杂谈</a></div><span><a href="/2025/01/21/zatanNoval2/">【感想】写作进度报告2</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/tvm/" title="Intvm">tvm</a></div><span><a href="/2024/10/25/tvm06/">【TVM】通过代码学习编译流程【6】CodeGen</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/tvm/" title="Intvm">tvm</a></div><span><a href="/2024/06/18/deployTVMPython/">【TVM】Python脚本实现模型编译和保存</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Tengine/" title="InTengine">Tengine</a></div><span><a href="/2025/04/24/Tengine01/">【Tengine】推理流程脑图【1】</a></span></li></ul></div><div class="rpost pjax"><h2>Recent Comments</h2></div></div><div class="status"><div class="copyright">© 2010 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">XianMu @ 暮冬Z羡慕的博客</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="Symbols count total">295k words</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="Reading time total">4:28</span></div><div class="powered-by">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> &amp; Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config="" type="text/javascript">var LOCAL = {
    ispost: true,
        path: `2024/12/24/conv6/`,
        favicon: {
        show: `(●´3｀●) Here we go again.`,
        hide: `(´Д｀) It's a disaster!`
    },
    search: {
        placeholder: "Search for Posts",
        empty: "We didn't find any results for the search: ${query}",
        stats: "${hits} results found in ${time} ms"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: {},
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">Article Timeliness Alert</span><br>This is an article published {{publish}} days ago and last updated {{updated}} days ago. Some information may have changed, so please be careful to screen it.</p></div>`,
    quiz: {
        choice: `Multiple Choice`,
        multiple: `Multiple Answer`,
        true_false: `True/False`,
        essay: `Questions`,
        gap_fill: `Gap Filling`,
        mistake: `Wrong Answer`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.2.4/pace.min.js" async=""></script><script src="/js/siteInit.js?v=0.4.2" type="module" fetchpriority="high" defer=""></script></body></html>