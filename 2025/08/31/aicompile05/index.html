<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="alternate" href="/rss.xml" title="Пусть этот камень будет более крепким, чем человек" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Пусть этот камень будет более крепким, чем человек" type="application/atom+xml"><link rel="alternate" type="application/json" title="Пусть этот камень будет более крепким, чем человек" href="https://forcheetah.github.io/feed.json"><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"><link rel="preconnect" href="https://at.alicdn.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext" media="none" onload="this.media='all'"><link rel="stylesheet" href="/css/app.css?v=0.4.2"><link rel="modulepreload" href="/js/chunk-FJ7AJ5BW.js"><link rel="modulepreload" href="/js/chunk-MQTNP6EI.js"><link rel="modulepreload" href="/js/chunk-QAWHJ5B3.js"><link rel="modulepreload" href="/js/index.esm-SU253EAQ.js"><link rel="modulepreload" href="/js/post-SZ2V6ERD.js"><link rel="modulepreload" href="/js/quicklink-GO25OZIT.js"><link rel="modulepreload" href="/js/siteInit.js"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo6.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo12.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo11.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo2.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/gamersky.webp" as="image" fetchpriority="high"><link rel="preload" href="https://forcheetah.github.io/assets/lunbo9.webp" as="image" fetchpriority="high"><meta name="keywords" content="compile,"><meta name="description" content="有自己的博客很帅，但是我很懒，要命！！！"><link rel="canonical" href="https://forcheetah.github.io/2025/08/31/aicompile05/"><title>【AI编译】张量生命周期管理</title><meta name="generator" content="Hexo 7.0.0"></head><body itemscope="" itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">【AI编译】张量生命周期管理</h1><div class="meta"><span class="item" title="Created: 2025-08-31 10:20:00"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">Posted on</span><time itemprop="dateCreated datePublished" datetime="2025-08-31T10:20:00+08:00">2025-08-31</time></span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i></span><span class="text">Symbols count in article</span><span>4.8k</span><span class="text">words</span></span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i></span><span class="text">Reading time</span><span>4 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">暮冬Z羡慕的博客</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo6.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo12.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo11.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo2.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/gamersky.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://forcheetah.github.io/assets/lunbo9.webp&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement="" itemscope="" itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">Home</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/categories/compile/" itemprop="item" rel="index" title="Incompile"><span itemprop="name">compile<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="en"><link itemprop="mainEntityOfPage" href="https://forcheetah.github.io/2025/08/31/aicompile05/"><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.webp"><meta itemprop="name" content="XianMu"><meta itemprop="description" content="神经网络推理、加速、AI编译。 我必须立刻开始挣扎！, 有自己的博客很帅，但是我很懒，要命！！！"></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Пусть этот камень будет более крепким, чем человек"></span><div class="body md" itemprop="articleBody"><h1 id="前言"><a class="anchor" href="#前言">#</a> 前言</h1>
<p>本篇文章总结【张量生命周期优化】算法。</p>
<p>作为初学者，错误在所难免，还望不吝赐教。</p>
<h1 id="介绍"><a class="anchor" href="#介绍">#</a> 介绍</h1>
<p>AI 编译器设计中用于神经网络模型推理的内存管理模块， 通常被称为内存分配规划 或 张量生命周期优化。<br>
为了减少内存占用，提高内存利用率，对 Tensor 的内存分配和生命周期的管理必不可少。</p>
<p>内存分配就像是个拼图游戏，在二维坐标中，横轴是时间，纵轴是内容空间，然后将神经网络模型推理过程中需要用到的内存块， 拼到这个二维坐标中。</p>
<p>神经网络模型推理主要涉及三部分 Tensor 内存占用：输入输出 tensor、权重 tensor、临时中间 tensor。将这些 tensor 拼接到如下的坐标轴中，横轴是内存空间，纵轴是周期 TimeStep，合理分配，以最大化内存利用率。</p>
<p>如下图</p>
<p><img loading="lazy" data-src="1756606612420.webp" alt="算能无切分情况的分配"></p>
<p><a target="_blank" rel="noopener" href="https://tpumlir.org/developer_manual_zh/10_layergroup.html">图源 - 无切分情况的分配</a></p>
<p>按照神经网络的执行顺序（拓扑顺序）来划分周期，以下面一个网络结构为例，周期可以如下划分。</p>
<p><img loading="lazy" data-src="1756606687361.webp" alt="算能LMEM的ID分配"></p>
<p><a target="_blank" rel="noopener" href="https://tpumlir.org/developer_manual_zh/10_layergroup.html">图源 - LMEM 的 ID 分配</a></p>
<p><img loading="lazy" data-src="1756606703569.webp" alt="算能TimeStep分配"></p>
<p><a target="_blank" rel="noopener" href="https://tpumlir.org/developer_manual_zh/10_layergroup.html">图源 - TimeStep 分配</a></p>
<h1 id="算法"><a class="anchor" href="#算法">#</a> 算法</h1>
<p>只考虑静态内存分配。动态内存分配的 tensor 大小不固定、形状不固定，可能需要在推理过程中边推理边分配内存。但是静态情况下，需要开辟的空间时已知的。</p>
<h2 id="贪心算法"><a class="anchor" href="#贪心算法">#</a> 贪心算法</h2>
<p>贪心算法的 “贪心” 体现在：在为当前要分配的张量做决策时，算法只着眼于 “当前这一步” 所能找到的最优解（即最能节省当前内存空间的放置位置），而不会为了全局最优（整个推理过程的绝对最低峰值内存）去考虑未来的张量该如何分配。这是一种局部最优（Local Optimal）策略，期望通过每一步的局部最优选择，最终得到一个接近全局最优的可行解。<br>
1. 生命周期分析：首先，遍历计算图，为每个张量（Tensor）确定其 “出生时间”（定义或计算完成时）和 “死亡时间”（最后一次被使用时）。<br>
2. 排序：将所有的张量按照其 “出生时间” 排序。<br>
3. 分配：模拟一个从低地址到高地址的内存空间，可以用一个链表来存放。初始情况下链表中只有一个拥有所有空间、未占用的内存块。按顺序处理每个张量：检查当前所有未分配内存块，找到一个足够大的空闲内存块来存放新张量。张量生命周期结束时，即使释放对应的内存块，如果释放时前后内存连续，可以将其融合为一个大的内存块。<br>
寻找空闲块的策略：</p>
<ul>
<li>首次适应（First-Fit）：从低地址开始扫描，找到第一个足够大的空闲块就分配。</li>
<li>最佳适应（Best-Fit）：扫描所有空闲块，找到能满足需求且大小最接近的空闲块进行分配，以减少内存碎片。</li>
<li>最坏适应（Worst-Fit）：总是选择最大的空闲块进行分配，试图避免产生非常小的碎片。</li>
</ul>
<p>贪心算法的优点：<br>
高效：它的决策非常快，通常是 O (n) 或 O (n log n) 的复杂度，适合在编译器中快速完成内存规划。</p>
<p>有效：对于大多数神经网络计算图，张量的生命周期分布使得这种 “短视” 的策略能得出一个非常不错、甚至是最优的解。</p>
<p>实现简单：逻辑清晰，易于实现和调试。</p>
<p>贪心的局限性：</p>
<p>局部最优：由于缺乏全局视野，它无法保证结果一定是全局最优（峰值内存最低）的。在某些特定的张量生命周期和大小分布下，它可能会产生碎片或做出次优的决策。</p>
<p>受分配策略影响：使用 First-Fit, Best-Fit, 还是 Worst-Fit，会得到不同的结果，需要根据实际情况进行选择。</p>
<p>比如贪心算法会造成左图的情况，其显然不如右侧的分配方式好。</p>
<p><img loading="lazy" data-src="1756606721334.webp" alt="分配示例"></p>
<h2 id="束搜索算法"><a class="anchor" href="#束搜索算法">#</a> 束搜索算法</h2>
<p>束搜索是贪心算法的一种优雅扩展，它在 “每一步的局部最优” 和 “穷举搜索的全局最优” 之间找到了一个非常好的平衡点。</p>
<ul>
<li>贪心算法：在每一步，只选择当前看起来最好的一个选项，然后走下去，永不回头。它没有前瞻性。</li>
<li>穷举搜索：考虑所有可能的路径，最终一定能找到全局最优解，但计算成本无法承受。</li>
<li>束搜索：是两者的折中。它在每一步不是只保留 1 个候选解，而是保留最好的 k 个候选解（k 称为束宽）。这个 k 是一个可调的参数，k=1 时就是贪心算法，k=∞ 时就是穷举搜索。</li>
<li></li>
</ul>
<p>假设我们按张量的开始时间排序后，得到一个待分配序列 [T1, T2, T3, ..., Tn]，束宽为 k。</p>
<p>1. 初始化：</p>
<ul>
<li>创建一个集合  <code>beam</code> ，它代表当前代的候选状态。初始时，它只包含一个状态：空的内存空间，峰值内存为 0，下一个要分配的是 T1。</li>
<li>beam = [initial_state]<br>
 2. 循环（对于每一个要分配的张量）：</li>
</ul>
<p>a. 生成候选：对于  <code>beam</code>  中的每一个当前状态，生成所有可能分配下一个张量的方式。每个方式都会产生一个新的后继状态。</p>
<ul>
<li>例如，从当前状态 S 出发，分配 Ti 可能有 3 种方式：放入空闲块 A、放入空闲块 B、放到堆顶。这会生成 3 个新的状态 S_A, S_B, S_C。<br>
b. 排序与剪枝：</li>
<li>将所有新生成的后继状态（来自  <code>beam</code>  中所有父状态）合并到一个大列表中。</li>
<li>根据评估函数（即当前的峰值内存）对这个大列表进行排序，选出最好的 k 个状态。</li>
<li>丢弃掉所有其他状态。</li>
<li>更新  <code>beam</code>  为这 k 个最好的后继状态。<br>
c. 前进：处理下一个张量 T (i+1)。<br>
3. 终止：</li>
<li>当所有张量都分配完毕后， <code>beam</code>  集合中的 k 个状态就代表了 k 个完整的内存分配方案。</li>
<li>从中选择峰值内存最小的那个方案作为最终结果。</li>
</ul>
<h2 id="总结"><a class="anchor" href="#总结">#</a> 总结：</h2>
<p>还有很多其他的算法，总结如下：</p>
<p><img loading="lazy" data-src="1756606772058.webp" alt="算法总结"></p>
<h1 id="绘图"><a class="anchor" href="#绘图">#</a> 绘图</h1>
<p>可以通过绘制甘特图来检查 Tensor 生命周期的分配情况。可以将信息输出为以下 .csv 文件：</p>
<figure class="highlight txt"><figcaption data-lang="txt"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>tensor_name,size,offset,start_time,end_time</pre></td></tr><tr><td data-num="2"></td><td><pre>conv1_weight,102400,0,1,10</pre></td></tr><tr><td data-num="3"></td><td><pre>layer1_activation,204800,102400,5,15</pre></td></tr><tr><td data-num="4"></td><td><pre>pool1_output,102400,102400,16,25</pre></td></tr><tr><td data-num="5"></td><td><pre>conv2_weight,204800,0,11,30</pre></td></tr><tr><td data-num="6"></td><td><pre>layer2_activation,409600,204800,20,35</pre></td></tr><tr><td data-num="7"></td><td><pre>output,102400,614400,36,40</pre></td></tr></tbody></table></figure><p>使用 Python 库来绘制甘特图，如下代码已经将数据进行归一化。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>patches <span class="token keyword">as</span> patches</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 读取 CSV</span></pre></td></tr><tr><td data-num="7"></td><td><pre>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'memory_plan.csv'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 计算相对比例</span></pre></td></tr><tr><td data-num="10"></td><td><pre>max_time <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'end_time'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>max_memory <span class="token operator">=</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'offset'</span><span class="token punctuation">]</span> <span class="token operator">+</span> df<span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 归一化到 [0, 1] 范围</span></pre></td></tr><tr><td data-num="14"></td><td><pre>df<span class="token punctuation">[</span><span class="token string">'norm_start'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'start_time'</span><span class="token punctuation">]</span> <span class="token operator">/</span> max_time</pre></td></tr><tr><td data-num="15"></td><td><pre>df<span class="token punctuation">[</span><span class="token string">'norm_end'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'end_time'</span><span class="token punctuation">]</span> <span class="token operator">/</span> max_time</pre></td></tr><tr><td data-num="16"></td><td><pre>df<span class="token punctuation">[</span><span class="token string">'norm_offset'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'offset'</span><span class="token punctuation">]</span> <span class="token operator">/</span> max_memory</pre></td></tr><tr><td data-num="17"></td><td><pre>df<span class="token punctuation">[</span><span class="token string">'norm_size'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span> <span class="token operator">/</span> max_memory</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 调整画布大小</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment"># 为每个 Tensor 绘制一个水平矩形条</span></pre></td></tr><tr><td data-num="22"></td><td><pre>colors <span class="token operator">=</span> plt<span class="token punctuation">.</span>cm<span class="token punctuation">.</span>tab10<span class="token punctuation">(</span>np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">for</span> i<span class="token punctuation">,</span> row <span class="token keyword">in</span> df<span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    rect <span class="token operator">=</span> patches<span class="token punctuation">.</span>Rectangle<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'norm_start'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token string">'norm_offset'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># (x, y) 左下角坐标</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        row<span class="token punctuation">[</span><span class="token string">'norm_end'</span><span class="token punctuation">]</span> <span class="token operator">-</span> row<span class="token punctuation">[</span><span class="token string">'norm_start'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token comment"># 宽度</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        row<span class="token punctuation">[</span><span class="token string">'norm_size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                         <span class="token comment"># 高度</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        linewidth<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'black'</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span>colors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        label<span class="token operator">=</span>row<span class="token punctuation">[</span><span class="token string">'tensor_name'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    ax<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>rect<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    </pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment"># 在矩形中部添加 Tensor 名称</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    ax<span class="token punctuation">.</span>text<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">'norm_start'</span><span class="token punctuation">]</span> <span class="token operator">+</span> row<span class="token punctuation">[</span><span class="token string">'norm_end'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        row<span class="token punctuation">[</span><span class="token string">'norm_offset'</span><span class="token punctuation">]</span> <span class="token operator">+</span> row<span class="token punctuation">[</span><span class="token string">'norm_size'</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        row<span class="token punctuation">[</span><span class="token string">'tensor_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="39"></td><td><pre>        ha<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="40"></td><td><pre>        va<span class="token operator">=</span><span class="token string">'center'</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="41"></td><td><pre>        fontsize<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        bbox<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>boxstyle<span class="token operator">=</span><span class="token string">"round,pad=0.3"</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span><span class="token string">"white"</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># 设置图表属性</span></pre></td></tr><tr><td data-num="46"></td><td><pre>ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'Normalized Time Step'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Normalized Memory Address'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Neural Network Memory Allocation Timeline\nPeak Memory: {:,} Bytes'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>max_memory<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment"># 添加网格</span></pre></td></tr><tr><td data-num="51"></td><td><pre>ax<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'--'</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment"># 添加图例</span></pre></td></tr><tr><td data-num="54"></td><td><pre>ax<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>bbox_to_anchor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1.05</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loc<span class="token operator">=</span><span class="token string">'upper left'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment"># 调整布局</span></pre></td></tr><tr><td data-num="57"></td><td><pre>plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token comment"># 保存和显示</span></pre></td></tr><tr><td data-num="60"></td><td><pre>plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'memory_timeline_normalized.png'</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">150</span><span class="token punctuation">,</span> bbox_inches<span class="token operator">=</span><span class="token string">'tight'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><h1 id="后记"><a class="anchor" href="#后记">#</a> 后记</h1>
<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a target="_blank" rel="noopener" href="https://github.com/ForCheetah/ForCheetah.github.io">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>
<div class="tags"><a href="/tags/compile/" rel="tag"><i class="ic i-tag"></i>compile</a><a href="/tags/AI/" rel="tag"><i class="ic i-tag"></i>AI</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">Edited on</span><time title="Modified: 2025-11-02 09:58:47" itemprop="dateModified" datetime="2025-11-02T09:58:47+08:00">2025-11-02</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.webp" alt="XianMu WeChat Pay"><p>WeChat Pay</p></div><div><img loading="lazy" data-src="/assets/alipay.webp" alt="XianMu Alipay"><p>Alipay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>XianMu<i class="ic i-at"><em>@</em></i>Пусть этот камень будет более крепким, чем человек</li><li class="link"><strong>Post link: </strong><a href="https://forcheetah.github.io/2025/08/31/aicompile05/" title="【AI编译】张量生命周期管理">https://forcheetah.github.io/2025/08/31/aicompile05/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2025/08/23/problem4/" rel="prev" itemprop="url" data-background-image="https://forcheetah.github.io/assets/lunbo1.webp" title="SystemC 用寄存器同步建模方法"><span class="type">Previous Post</span><span class="category"><i class="ic i-flag"></i>问题解决</span><h3>SystemC 用寄存器同步建模方法</h3></a></div><div class="item right"><a href="/2025/09/15/Article01/" rel="next" itemprop="url" data-background-image="https://forcheetah.github.io/assets/lunbo10.webp" title="【转载】北大中文男足战报1"><span class="type">Next Post</span><span class="category"><i class="ic i-flag"></i>转载</span><h3>【转载】北大中文男足战报1</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text"> 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%97%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text"> 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%AA%E5%BF%83%E7%AE%97%E6%B3%95"><span class="toc-number">3.1.</span> <span class="toc-text"> 贪心算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%9F%E6%90%9C%E7%B4%A2%E7%AE%97%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text"> 束搜索算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.3.</span> <span class="toc-text"> 总结：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%98%E5%9B%BE"><span class="toc-number">4.</span> <span class="toc-text"> 绘图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">5.</span> <span class="toc-text"> 后记</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2024/10/18/aicompile01/" rel="bookmark" title="【AI编译】Tiling操作能优化什么时间">【AI编译】Tiling操作能优化什么时间</a></li><li><a href="/2025/01/14/aicompile02/" rel="bookmark" title="【AI编译】如何进行layer-group">【AI编译】如何进行layer-group</a></li><li><a href="/2025/01/15/aicompile03/" rel="bookmark" title="【AI编译】layer-group之后如何tiling">【AI编译】layer-group之后如何tiling</a></li><li><a href="/2025/02/05/aicompile04/" rel="bookmark" title="【AI编译】如何进行内存分配">【AI编译】如何进行内存分配</a></li><li><a href="/2025/05/11/tvmByoc01/" rel="bookmark" title="【BYOC】TVM添加自定义编译器 ccompiler">【BYOC】TVM添加自定义编译器 ccompiler</a></li><li class="active"><a href="/2025/08/31/aicompile05/" rel="bookmark" title="【AI编译】张量生命周期管理">【AI编译】张量生命周期管理</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="XianMu" src="/assets/avatar.webp"><p class="name" itemprop="name">XianMu</p><div class="description" itemprop="description">有自己的博客很帅，但是我很懒，要命！！！</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">49</span><span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">19</span><span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">22</span><span class="name">tags</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/ForCheetah" class="item github" title="https://github.com/ForCheetah"><i class="ic i-github"></i></a><a href="/huasen.w@foxmail.com" class="item email" title="huasen.w@foxmail.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2025/09/15/Article01/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2025/08/23/problem4/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E7%BC%96%E8%AF%91%E5%99%A8/" title="In编译器">编译器</a></div><span><a href="/2025/03/13/compile01/">【编译器】使用llvm编译自定义语言【1】构建AST</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%BC%96%E8%AF%91%E5%99%A8/" title="In编译器">编译器</a></div><span><a href="/2025/03/28/compile03/">【编译器】使用llvm编译自定义语言【3】编译 object</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E9%87%8F%E5%8C%96/" title="In量化">量化</a></div><span><a href="/2025/01/03/quanti01/">【量化】连续卷积层首尾量化的可行性</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%8E%A8%E7%90%86%E5%BC%95%E6%93%8E/" title="In推理引擎">推理引擎</a></div><span><a href="/2024/06/16/engine2/">【推理引擎】常见AI推理框架</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/compile/" title="Incompile">compile</a></div><span><a href="/2025/08/31/aicompile05/">【AI编译】张量生命周期管理</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" title="In问题解决">问题解决</a></div><span><a href="/2025/08/23/problem4/">SystemC 用寄存器同步建模方法</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" title="In常见问题">常见问题</a></div><span><a href="/2024/05/14/cpplib/">C语言工程调用Cpp库解决方案</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/compile/" title="Incompile">compile</a></div><span><a href="/2024/10/18/aicompile01/">【AI编译】Tiling操作能优化什么时间</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/tvm/" title="Intvm">tvm</a></div><span><a href="/2024/10/13/tvm02/">【TVM】通过代码学习编译流程【2】模型转换</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%9D%82%E8%B0%88/" title="In杂谈">杂谈</a></div><span><a href="/2025/01/21/zatanNoval2/">【感想】写作进度报告2</a></span></li></ul></div><div class="rpost pjax"><h2>Recent Comments</h2></div></div><div class="status"><div class="copyright">© 2010 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">XianMu @ 暮冬Z羡慕的博客</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="Symbols count total">319k words</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="Reading time total">4:50</span></div><div class="powered-by">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> &amp; Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config="" type="text/javascript">var LOCAL = {
    ispost: true,
        path: `2025/08/31/aicompile05/`,
        favicon: {
        show: `(●´3｀●) Here we go again.`,
        hide: `(´Д｀) It's a disaster!`
    },
    search: {
        placeholder: "Search for Posts",
        empty: "We didn't find any results for the search: ${query}",
        stats: "${hits} results found in ${time} ms"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: {},
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">Article Timeliness Alert</span><br>This is an article published {{publish}} days ago and last updated {{updated}} days ago. Some information may have changed, so please be careful to screen it.</p></div>`,
    quiz: {
        choice: `Multiple Choice`,
        multiple: `Multiple Answer`,
        true_false: `True/False`,
        essay: `Questions`,
        gap_fill: `Gap Filling`,
        mistake: `Wrong Answer`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.2.4/pace.min.js" async=""></script><script src="/js/siteInit.js?v=0.4.2" type="module" fetchpriority="high" defer=""></script></body></html>