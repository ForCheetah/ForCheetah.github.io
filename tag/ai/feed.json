{
    "version": "https://jsonfeed.org/version/1",
    "title": "Пусть этот камень будет более крепким, чем человек • All posts by \"ai\" tag",
    "description": "有自己的博客很帅，但是我很懒，要命！！！",
    "home_page_url": "https://forcheetah.github.io",
    "items": [
        {
            "id": "https://forcheetah.github.io/2026/02/01/CUDA03/",
            "url": "https://forcheetah.github.io/2026/02/01/CUDA03/",
            "title": "【CUDA C++】GPU内存使用【3】",
            "date_published": "2026-02-01T13:47:17.043Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇介绍 GPU 的内存使用，主要是全局内存的合并内存访问，和共享内存的 bank 冲突。资料来源于 <a href=\"https://docs.nvidia.com/cuda/cuda-programming-guide/contents.html\">官网 CUDA Programming Guide</a>。本文会比官网教程简洁一些，去掉一些我不太感兴趣的内容（任性）。</p>\n<p>参考  <a href=\"https://docs.nvidia.com/cuda/cuda-programming-guide/contents.html\">官网 CUDA Programming Guide</a>。</p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"gpu合并内存访问\"><a class=\"anchor\" href=\"#gpu合并内存访问\">#</a> GPU 合并内存访问</h1>\n<p>GPU 的全局内存 Global Memory (GPU  Dram, 常见的显卡 8GB、12GB)，是通过 32-byte memory transactions 进行访问的。<br>\n当一个 CUDA 线程从全局内存中请求一个数据字节时，相关的 thread warp 会将该 thread warp 中所有线程的内存请求合并成满足该请求所需的内存交易数量，具体数量取决于每个线程访问的数据字节的大小以及内存地址在各线程中的分布情况。<br>\n例如，如果一个线程请求一个 4 字节的数据字节，那么该 Thread warp（包含 32 个 Thread）向全局内存发出的实际内存交易总量将是 32 字节。如果同一 warp 的其他 31 个线程并不需要这 32 字节中的数据，那么数据的利用率很低。而如果一个线程从全局内存中请求一个 4 字节的数据字节，并且交易大小为 32 字节，如果该 Thread warp 中的其他线程可以从这个 32 字节的请求中使用其他 4 字节的数据字节，它们可以在同一个请求中获取所需的数据（合并内存访问）。<br>\n举一个简单的例子，如果在 warp 请求中连续的线程在内存中请求连续的 4 个字节的数据，那么该 warp 将合并他们的请求，共请求 128 个字节的内存，而这 128 个字节的数据将通过四次 32 字节的内存操作来获取。这就实现了内存系统的 100% 利用率。也就是说，warp 利用了 100% 的内存流量。下图展示了这种完全协同的内存访问示例：</p>\n<p><img loading=\"lazy\" data-src=\"1769953213349.jpg\" alt=\"线程合并访存\"></p>\n<p>与之相反的，最糟糕的情况是，连续的线程（同一个 warp 中的线程）在同一内存位置上访问的数据元素之间相隔至少 32 个字节。在这种情况下，Thread warp 将被迫为每个线程执行一次 32 字节的内存操作，那么内存传输的总字节数将为 32 字节 * 32 Thread = 1024 字节。然而，实际使用的内存量仅为 128 字节（每个 warp 中的每个线程使用 4 字节），因此内存利用率仅为 128 / 1024 = 12.5%。这是对内存系统的极大浪费。下图展示了这种未合并的内存访问示例：</p>\n<p><img loading=\"lazy\" data-src=\"1769953274901.jpg\" alt=\"未能实现线程合并访存\"></p>\n<p>实现合并内存访问最直接的方法是让连续的线程依次访问内存中的连续元素。<br>\n例如，对于使用 1D thread block 启动的 kernal，以下的 VecAdd 内核将实现合并内存访问。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>__global__ <span class=\"token keyword\">void</span> <span class=\"token function\">vecAdd</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span><span class=\"token operator\">*</span> A<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token operator\">*</span> B<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token operator\">*</span> C<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> vectorLength<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">int</span> workIndex <span class=\"token operator\">=</span> threadIdx<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> blockIdx<span class=\"token punctuation\">.</span>x<span class=\"token operator\">*</span>blockDim<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>workIndex <span class=\"token operator\">&lt;</span> vectorLength<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        C<span class=\"token punctuation\">[</span>workIndex<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> A<span class=\"token punctuation\">[</span>workIndex<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> B<span class=\"token punctuation\">[</span>workIndex<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>值得注意的是，并不存在这样的规定，即连续的线程必须访问内存中的连续元素才能实现协同式内存访问，这只是实现协同式访问的常见方式而已。只要线程组中的所有线程以某种线性或置换的方式访问来自相同 32 字节内存段的元素，就会发生协同式内存访问。换句话说，实现协同式内存访问的最佳方式是将使用的字节数与传输的字节数的比例最大化。<br>\n确保全局内存访问的正确合并是编写高效 CUDA 内核时最重要的性能考量之一。应用程序必须尽可能高效地利用内存系统。</p>\n<p>矩阵转置例子 合并内存访问</p>\n<p>将一个  <code>N*N</code>  的 float 型外部矩阵，从 A 转置为 C，这个例子使用 2D grid，并假设使用 32<em>32 线程的 2D 线程块，因此  <code>blockDim.x = 32</code> ， <code>blockDim.y = 32</code> ，每个线程块要操作 32</em>32 的矩阵切块。每个线程都只对矩阵中的一个特定元素进行处理，因此无需对线程进行显式的同步操作。图 12 展示了这一矩阵转置操作。内核源代码与该图相对应。</p>\n<p><img loading=\"lazy\" data-src=\"1769953336088.jpg\" alt=\"矩阵置换示意图\"></p>\n<p>每个矩阵顶部和左侧的标签分别是二维线程块的索引，也可以视为分块索引，其中每个小方块代表矩阵中将由二维线程块处理的一个分块。在这个例子中，分块大小为 32 x 32 个元素，因此每个小方块代表矩阵的一个 32 x 32 的分块。绿色阴影方块显示了一个示例分块在转置操作前后的位置。<br>\n注分块矩阵转置，块的位置转置（即行列互换）每个块自身也转置。：<br>\n<img loading=\"lazy\" data-src=\"1769953350197.jpg\" alt=\"分块矩阵转置\"></p>\n<p>此外，提前介绍一下 CUDA C++ 代码中关于线程用到的参数变量：<br>\n<img loading=\"lazy\" data-src=\"1769953364342.jpg\" alt=\"参数示意图\"></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* macro to index a 1D memory array with 2D indices in row-major order */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/* ld is the leading dimension, i.e. the number of columns in the matrix     */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">INDX</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> row<span class=\"token punctuation\">,</span> col<span class=\"token punctuation\">,</span> ld <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>ld<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>col<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">/* CUDA kernel for naive matrix transpose */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>__global__ <span class=\"token keyword\">void</span> <span class=\"token function\">naive_cuda_transpose</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> m<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>a<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>c <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">int</span> myCol <span class=\"token operator\">=</span> blockDim<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> blockIdx<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">int</span> myRow <span class=\"token operator\">=</span> blockDim<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> blockIdx<span class=\"token punctuation\">.</span>y <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> myRow <span class=\"token operator\">&lt;</span> m <span class=\"token operator\">&amp;&amp;</span> myCol <span class=\"token operator\">&lt;</span> m <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        c<span class=\"token punctuation\">[</span><span class=\"token function\">INDX</span><span class=\"token punctuation\">(</span> myCol<span class=\"token punctuation\">,</span> myRow<span class=\"token punctuation\">,</span> m <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a<span class=\"token punctuation\">[</span><span class=\"token function\">INDX</span><span class=\"token punctuation\">(</span> myRow<span class=\"token punctuation\">,</span> myCol<span class=\"token punctuation\">,</span> m <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">/* end if */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">/* end naive_cuda_transpose */</span></pre></td></tr></table></figure><p>以上代码：</p>\n<ul>\n<li>每个 CUDA 线程通过自己的 (blockIdx, threadIdx) 计算出它在逻辑二维网格中的位置 (myRow, myCol)。</li>\n<li>这个位置直接对应输入矩阵 a 中的一个元素：a [myRow][myCol]。<br>\n有对应的位置，线程 (myRow, myCol) 负责读取 a [myRow][myCol]，并将其写入 c [myCol][myRow]<br>\n 假设位于 global memory 中的待转置矩阵是按照行主序连续存放的（一般都是这样），那么由以上代码可知，取数据阶段，同一 warp 中的 32 个线程所需的数据是连续的，因此可以合并访存，效率很高，如下图所示：</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"1769953414177.jpg\" alt=\"合并访存示意图\"></p>\n<p>而这 32 个线程在存储结果的时候，相互之间数据间隔超过 32 个字节，无法合并访存，效率很低。</p>\n<h1 id=\"共享内存访问\"><a class=\"anchor\" href=\"#共享内存访问\">#</a> 共享内存访问</h1>\n<p>共享内存有 32 个存储单元，其组织方式是：连续的 32 位数据会映射到连续的存储单元上。每个存储单元的带宽为每时钟周期 32 位。<br>\n当同一线程 warp 中的多个线程试图访问同一缓存区中的不同元素时，就会发生缓存冲突。在这种情况下，对该缓存区中的数据的访问将被串行化处理，直到所有请求该数据的线程都获取到该数据为止。这种访问的串行化会导致性能下降。<br>\n这种情况的两个例外情况发生在同一 warp 中的多个线程同时访问（无论是读取还是写入）同一个共享内存位置时。对于读取操作，数据会被广播给请求的线程。对于写入操作，每个共享内存地址仅由其中的一个线程进行写入（哪个线程执行写入操作是不确定的）。<br>\n下图展示了一些分段访问的示例。内存 bank 内的红色方框表示共享内存中的一个特定位置。图中，左边和右边示例都没有访问冲突，但是中间示例有两路访问冲突。</p>\n<p><img loading=\"lazy\" data-src=\"1769953435830.jpg\" alt=\"bank访问示意图\"></p>\n<p>另一个示例，如下图所示：<br>\n左图：通过随机排列实现无冲突访问。<br>\n中图：由于线程 3、4、6、7 和 9 都访问了同一存储单元中的第 5 个存储器组，所以实现了无冲突访问。<br>\n右图：无冲突广播访问（同 warp 内的线程访问同一存储单元）。<br>\n<img loading=\"lazy\" data-src=\"1769953452832.jpg\" alt=\"bank访问示意图\"></p>\n<h1 id=\"矩阵转置例子-使用共享内存\"><a class=\"anchor\" href=\"#矩阵转置例子-使用共享内存\">#</a> 矩阵转置例子 使用共享内存</h1>\n<p>在上一个 “使用全局内存的矩阵转置示例” 中，展并未针对全局内存的高效使用进行优化，因为 c 矩阵的写入操作没有得到恰当的合并。在本示例中，共享内存将被视为用户管理的缓存，用于在全局内存中进行加载和存储操作，从而实现矩阵转置例子的读和写操作的全局内存合并访问。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* definitions of thread block size in X and Y directions */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">THREADS_PER_BLOCK_X</span> <span class=\"token expression\"><span class=\"token number\">32</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">THREADS_PER_BLOCK_Y</span> <span class=\"token expression\"><span class=\"token number\">32</span></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">/* macro to index a 1D memory array with 2D indices in column-major order */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/* ld is the leading dimension, i.e. the number of rows in the matrix     */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">INDX</span><span class=\"token expression\"><span class=\"token punctuation\">(</span> row<span class=\"token punctuation\">,</span> col<span class=\"token punctuation\">,</span> ld <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">(</span>col<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>ld<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">/* CUDA kernel for shared memory matrix transpose */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>__global__ <span class=\"token keyword\">void</span> <span class=\"token function\">smem_cuda_transpose</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> m<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                                    <span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>a<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                                    <span class=\"token keyword\">float</span> <span class=\"token operator\">*</span>c <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">/* declare a statically allocated shared memory array */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    __shared__ <span class=\"token keyword\">float</span> smemArray<span class=\"token punctuation\">[</span>THREADS_PER_BLOCK_X<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>THREADS_PER_BLOCK_Y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">/* determine my row and column indices for the error checking code */</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> myRow <span class=\"token operator\">=</span> blockDim<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> blockIdx<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> myCol <span class=\"token operator\">=</span> blockDim<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> blockIdx<span class=\"token punctuation\">.</span>y <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">/* determine my row tile and column tile index */</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> tileX <span class=\"token operator\">=</span> blockDim<span class=\"token punctuation\">.</span>x <span class=\"token operator\">*</span> blockIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> tileY <span class=\"token operator\">=</span> blockDim<span class=\"token punctuation\">.</span>y <span class=\"token operator\">*</span> blockIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> myRow <span class=\"token operator\">&lt;</span> m <span class=\"token operator\">&amp;&amp;</span> myCol <span class=\"token operator\">&lt;</span> m <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token comment\">/* read from global memory into shared memory array */</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        smemArray<span class=\"token punctuation\">[</span>threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a<span class=\"token punctuation\">[</span><span class=\"token function\">INDX</span><span class=\"token punctuation\">(</span> tileX <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> tileY <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> m <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">/* end if */</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">/* synchronize the threads in the thread block */</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token function\">__syncthreads</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> myRow <span class=\"token operator\">&lt;</span> m <span class=\"token operator\">&amp;&amp;</span> myCol <span class=\"token operator\">&lt;</span> m <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token comment\">/* write the result from shared memory to global memory */</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        c<span class=\"token punctuation\">[</span><span class=\"token function\">INDX</span><span class=\"token punctuation\">(</span> tileY <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> tileX <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> m <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> smemArray<span class=\"token punctuation\">[</span>threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">/* end if */</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\">/* end smem_cuda_transpose */</span></pre></td></tr></table></figure><p>上述代码，第一步  <code>smemArray[threadIdx.x][threadIdx.y] = a[INDX( tileX + threadIdx.x, tileY + threadIdx.y, m )];</code>  将 global memory 中的数据保存至共享内存中，这个过程已经完成了 Tile 块内的数据转置。读取全局内存的过程中， <code>threadIdx.x</code>  经 <code>INDX( row, col, ld ) ( ( (col) * (ld) ) + (row) )</code>  映射后，地址连续变化，所以在读取内存中，已经合并内存访问。<br>\n第二步  <code>c[INDX( tileY + threadIdx.x, tileX + threadIdx.y, m )] = smemArray[threadIdx.y][threadIdx.x];</code> ，将共享内存中的数据搬到 global memory 中的指定位置。同样的，在存储过程中， <code>threadIdx.x</code>  连续变化，C [] 地址也连续变化，也实现了合并访存。</p>\n<p>这段代码展示了共享内存的两种常见用途。<br>\n共享内存用于将数据从全局内存中转移出来，以确保对全局内存的读取和写入操作都能得到正确地合并处理。<br>\n共享内存用于使同一线程块中的各个线程能够相互共享数据。</p>\n<p>但上述代码存在共享内存的 bank 冲突。<br>\nGPU 的 share memory 有 32 个 bank，每个 bank 的 cache line 长度为 4 字节（32bit），并采用低位交叉的地址映射方式。当我们申请 <code>__shared__ float smemArray[32][32]</code>  的共享内存空间时，第一行 32 个 32float 将分散到 32 个 bank 中。<br>\n下图中，同样的颜色属于同一 bank，数字代表 warp。比如草绿色这一列全部是 bank0，数字 0 是 warp0.</p>\n<p><img loading=\"lazy\" data-src=\"1769953518248.jpg\" alt=\"bank示意图\"></p>\n<p>回到刚才的矩阵砖石例子中，我们可以通过检查共享内存的使用情况来判断是否存在 bank 冲突。共享内存的首次使用情况是将全局内存中的数据存储到共享内存中：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>smemArray<span class=\"token punctuation\">[</span>threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a<span class=\"token punctuation\">[</span><span class=\"token function\">INDX</span><span class=\"token punctuation\">(</span> tileX <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> tileY <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> m <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>因为 C++ 数组是按行优先顺序存储的，所以同一 warp 中的连续线程（由连续的 threadIdx.x 值表示），由于 threadIdx.x 是共享内存数组的第一个索引，因此会以 32 个元素的步长访问 smemArray。这会导致 32 路 bank 冲突，如上图 的左图所示。<br>\n共享内存的第二种使用方式是将来自共享内存的数据写回全局内存：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>c<span class=\"token punctuation\">[</span><span class=\"token function\">INDX</span><span class=\"token punctuation\">(</span> tileY <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> tileX <span class=\"token operator\">+</span> threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> m <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> smemArray<span class=\"token punctuation\">[</span>threadIdx<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>threadIdx<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在这种情况下，由于 threadIdx.x 是 smemArray 数组中的第二个索引，同一线程组中的连续线程将以 1 个元素的步长访问 smemArray。这避免了存取冲突，如上图右侧。<br>\n如何避免 bank 冲突呢？常见方法是通过在数组的列维度上增加 1 来填充共享内存，具体操作如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>__shared__ <span class=\"token keyword\">float</span> smemArray<span class=\"token punctuation\">[</span>THREADS_PER_BLOCK_X<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>THREADS_PER_BLOCK_Y<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"1769953621010.jpg\" alt=\"bank避免冲突示意图\"></p>\n<p>这种方式，可使得共享内存存储和读取的时候，都不会有 bank 冲突。</p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，看到一定及时回复！</p>\n",
            "tags": [
                "AI",
                "CUDA"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2026/01/25/Cache01/",
            "url": "https://forcheetah.github.io/2026/01/25/Cache01/",
            "title": "【AI编译】Cache缓存地址映射",
            "date_published": "2026-01-25T11:36:40.111Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>软件离不开硬件，硬件也离不开软件啊。作为 “根本不了解硬件” 的我，也不得不去了解和学习硬件的基本概念。本篇文章 Cache 缓存设计的相关内容。</p>\n<p>内容和图源自书籍《AI 处理器硬件架构设计》，请参考。</p>\n<p>错误在所难免，还望不吝赐教。</p>\n<h1 id=\"cache\"><a class=\"anchor\" href=\"#cache\">#</a> Cache</h1>\n<p>NPU 的 Cache 设计与其通用 CPU/GPU 的 Cache 有很大不同，核心目标是满足高吞吐、可预测的流式数据访问，而非处理通用计算的随机访问。<br>\nNPU L2 Cache 的定位：</p>\n<ul>\n<li>1. 容量大，带宽极高：作为片上 “数据水库”，为多个计算核心（Tensor Core/Matrix Unit）或向量单元提供数据。8MB 是一个常见且合理的尺寸。</li>\n<li>2. 服务于规律的数据搬运：NPU 的计算模式通常是 “权重加载 + 输入数据滑动窗口” 或 “大型矩阵分块计算”。数据访问模式在编译期就可高度预测。</li>\n<li>3.Bank 冲突是主要敌人：并行计算单元（例如 256x256 的矩阵乘）会同时请求海量数据（如一整行或一整列）。如果 Bank 规划不当，多个请求落在同一个 Bank，就会造成严重的排队延迟，极大降低算力利用率。</li>\n<li>4. 简化控制逻辑：相较于 CPU Cache 复杂的替换算法（如 LRU），NPU L2 的替换策略更直接，常由编译器进行显式管理</li>\n</ul>\n<h1 id=\"cache主要有三种映射方式\"><a class=\"anchor\" href=\"#cache主要有三种映射方式\">#</a> Cache 主要有三种映射方式</h1>\n<h2 id=\"1高位交叉high-order-interleaving\"><a class=\"anchor\" href=\"#1高位交叉high-order-interleaving\">#</a> 1. 高位交叉（High-Order Interleaving）</h2>\n<p>现代 NPU/GPU 中的 Cache（如 L2 Cache）在物理上通常被组织为一个由多个独立存储体（Bank）组成的阵列，每个 Bank 拥有自己的地址解码、数据读写端口和控制逻辑，Bank 之间可以并行工作。每个 Bank 在每个时钟周期内，都能完成对其内部一整行（即一个 Cache Line）数据的读取或写入。</p>\n<p><img loading=\"lazy\" data-src=\"1769340499746.jpg\" alt=\"图 8-5\"></p>\n<p>上图是高位交叉的地址映射示意图。</p>\n<p>地址可以分为 3 个域段： 最低域段为 Offset 域段， 用于指示 Bank 每行内地址偏移； 中间域段为 RAM Address 域段，用于指示 RAM 的行数； 最高域段为 Bank 域段， 指示访问的是哪个 Bank。</p>\n<p>这种映射方式，是将数据地址的高位来生成 Bank ID，而数据一般是连续的，所以数据倾向于存储在同一个 Bank 中。</p>\n<p>这种映射逻辑下，同一个 Bank 内的地址是连续的：</p>\n<p><img loading=\"lazy\" data-src=\"1769340572358.jpg\" alt=\"bank 内连续\"></p>\n<p>可以很容易联想到：如果程序访问一段连续数据（如一个张量），所有请求都打到同一个 Bank- 其他 Bank 闲置，会造成很大的带宽浪费。</p>\n<h2 id=\"2低位交叉low-order-interleaving\"><a class=\"anchor\" href=\"#2低位交叉low-order-interleaving\">#</a> 2. 低位交叉（Low-order Interleaving）</h2>\n<p><img loading=\"lazy\" data-src=\"1769340615438.jpg\" alt=\"图 8-6\"></p>\n<p>上图是低位交叉的地址映射示意图。</p>\n<p>这种映射方式是 取地址中间的几位（通常是行内偏移 Offset 之上的几位）作为 Bank ID。如 Bank ID = addr [13:8]。</p>\n<p>地址可以分为 3 个域段： 最低域段为 Offset 域段， 用于指示 Bank 每行内地址偏移；中间域段为 Bank 域段， 指示访问的是哪个 Bank； 最高域段为 RAM Address 域段， 用于指示 RAM 的行数。<br>\n这时候一段连续的数据，其低位地址时连续变化的，因此倾向于被映射到 Cache 的同一行的不同 bank 中。</p>\n<p>这种映射逻辑下，相邻 Bank 间同一行的 Cache line 的地址是连续的，跨 bank 连续  ：</p>\n<p><img loading=\"lazy\" data-src=\"1769340675460.jpg\" alt=\"跨bank连续\"></p>\n<p>可以很容易联想到：如果这时候程序访问一段连续数据（如一个张量），请求会分散到多个 bank 中，访问效率会高很多。</p>\n<p>再进一步探讨下低位交叉：</p>\n<p><strong>低位交叉的 bank 冲突</strong></p>\n<p>为方便说明，假设每个访问源每个时钟周期只访问一个字节。 假设每列数据都在同一个 Bank 中， 整系统共 4 个 Bank， 每个 Bank 的宽度为 1B。source0 的起始地址为 1， 访问长度为 9B， source1 的起始地址为 12， 访问长度为 8B， source2 的起始地址为 22， 访问长度为 8B。</p>\n<p><img loading=\"lazy\" data-src=\"1769340743227.jpg\" alt=\"图 8-8\"></p>\n<p>假设 source0～ source2 同时发起访存请求， 由于它们的起始地址在不同的 Bank 中， 因此三者之间可进行无冲突的并行访问。</p>\n<p><img loading=\"lazy\" data-src=\"1769340757198.jpg\" alt=\"图 8-9\"></p>\n<p>假设 3 个访问源的起始地址都落在了同一个 Bank 中， 并且 3 个访问源是同时发起访存请求的， 则首个访问请求出现了 Bank 冲突。</p>\n<p>这种情况下，假设轮询仲裁器的轮询顺序是 source0→source1→source2， 则 source1 会被反压一个时钟周期， source2 会被反压两个时钟周期。</p>\n<p>但一般来说，这种访问的数据量都比较大，只在首次访问时进行的几个时钟周期的反压对整体的性能影响较小。</p>\n<p><strong>Bank 划分粒度对访存效率的影响</strong></p>\n<p><img loading=\"lazy\" data-src=\"1769340795630.jpg\" alt=\"图 8-11\"></p>\n<p>上图左边，假设整个地址空间分为两个 Bank， Bank 宽度为 2B，而右边，整个地址空间分为 4 个 Bank， Bank 宽度为 1B。有一个指令，希望读取 Cache 中的 2、 4、 11 和 13 四个地址。</p>\n<p>由于第一种划分方式，Bank0 中的 4 和 13 不在同一行，需要两个周期才能访问。Bank1 中的 2 和 11 也需要两个周期才能访问得到。而 bank0 和 bank1 能够并行，所以整体需要两个周期。</p>\n<p>第二种划分方式，四个 bank 都能并行，所以能够一个周期，将所有数据访问到。</p>\n<p>所以，划分更多 bank 能够有更高的访问效率，但是 bank 更多也会带来布线、面积、成本上的困难。</p>\n<p><img loading=\"lazy\" data-src=\"1769340818036.jpg\" alt=\"图 8-12\"></p>\n<p>上图是一个新的例子，有两个请求，source a 和 source b，分别访问 [14-21] 和 [38-45] 的数据，也不难分析，第一种划分方式，需要两个周期，而第二种方式，只需要一个周期。</p>\n<h2 id=\"3混合交叉\"><a class=\"anchor\" href=\"#3混合交叉\">#</a> 3. 混合交叉</h2>\n<p>混合交叉的主流方案是 Bank Group（存储体分组）</p>\n<p>混合交叉顾名思义，就是结合了高位交叉和低位交叉。</p>\n<p><img loading=\"lazy\" data-src=\"1769340850133.jpg\" alt=\"图 8-10\"></p>\n<p>上图所示为混合交叉的地址映射示意图。<br>\n混合交叉将 Bank 划分为组（group），图中的每一列都是一组，组和组之间采用低位交叉，组内采用高位交叉。</p>\n<p>例如假设有 64 个 bank，将其中 8 个 bank 划分成一组，那么就是 8 group * 8 bank。此时一段连续的数据，倾向于这样映射：第一块 128B 数据映射到 group0，第二块 128B 数据映射到 group1…… 第九块 128B 数据又映射到 group0 。而最终映射到 group0 的若干块数据，倾向于映射到同一个 bank，比如 bank5（每个 group 8 个 bank）。</p>\n<p>将低位交叉改进为混合交叉，可能有以下原因：</p>\n<p>1. 两级地址映射，减少排线复杂度和面积占用。（不懂硬件，我也不清楚）<br>\n2. 将冲突区域从全局变成局域。<br>\n纯低位交叉，所有的数据都会分散到 64 个 bank 中，当许多请求来访问各自的数据的时候，他们之间都会出现互相干扰，导致所有请求都无法及时完成，冲突域是全局的。而混合交叉，会将各个冲突域限制在所有 group 的某个 bank 中，比如这些请求都在访问所有 group 的第 2 个 bank，group 中的其他 bank 仍然处于可用状态。<br>\n就像一个大型体育馆被分成了 8 个独立的区域，一场骚乱最多只能让每个区域的一个入口堵塞，其他 7 个入口和区域内部的大部分空间仍然可用，从而保证了系统在最坏情况下仍有基本的通行能力和吞吐量。</p>\n<h1 id=\"npu-cache设计选择\"><a class=\"anchor\" href=\"#npu-cache设计选择\">#</a> NPU Cache 设计选择</h1>\n<h2 id=\"高位交叉相比低位交叉的缺点\"><a class=\"anchor\" href=\"#高位交叉相比低位交叉的缺点\">#</a> 高位交叉相比低位交叉的缺点</h2>\n<p>1. 通用性与编程复杂度<br>\n高位交叉需要显式管理 Bank 分配，低位交叉能够自动分散。<br>\nNVIDIA CUDA、Google TensorFlow 等框架开发者更倾向于透明管理的方案。</p>\n<p>2. 负载不均衡<br>\n高位交叉，运行过程中只有某个或某几个 bank 处于活跃状态，其他 bank 都未利用。<br>\n低位交叉，所有 bank 都处于活跃状态。</p>\n<p>3. 动态调度困难<br>\n现代 NPU/GPU 支持：动态并行（Dynamic Parallelism）抢占式多任务（Preemptive Multitasking）实时推理（Real-time Inference）等<br>\n比如多模型并发执行： 基本没法为多个模型共同分配不冲突的 bank。<br>\n时间片 0：运行 ResNet-50（按高位交叉分配 Bank 0-31）<br>\n时间片 1：需要运行 BERT（但理想 Bank 0-31 被占用）<br>\n解决方案：要么等待，要么接受次优分配</p>\n<p>4. 内存碎片化<br>\n高位交叉会导致严重的内部碎片</p>\n<h2 id=\"选择\"><a class=\"anchor\" href=\"#选择\">#</a> 选择</h2>\n<p>从以上分析来开看，在通用、硬件自动管理的 GPU/NPU 缓存设计中，高位交叉是低效的。</p>\n<p>但是！但是！而对于追求极致效率与确定性的专用 NPU 来说，类似高位交叉的内存管理可能更适用。</p>\n<p>因为其核心不是传统缓存，而是一个可以由软件显式管理的统一缓冲区。<br>\n神经网络的计算图在编译时是完全已知、静态的。计算图和数据流在编译期完全确定、可预测。</p>\n<p>“访存” 不是一个被动的、随机的读取过程，而是一个由编译器主动编排的、与计算精确同步的 “数据供给流水线”。</p>\n<p>这种情况下，NPU 编译器要在神经网络模型编译的过程中，就要将可能存在并行的 Tensor 安排进不会产生冲突的 Bank 中。将数据连续存放在同一个 bank 中，就不再是效率瓶颈，而是通过微指令的流水线，获取可靠和稳定的数据供给，让数据搬出、计算同时、结果存储进行。这时候即使将 Tensor 分散在不同的 bank 中，也不会明显增加执行速度，还可能因为访存的潜在冲突和不确定性，拖累整个执行速度。</p>\n<p>至于以上 “高位交叉相对于低位交叉的缺点” 中的其他问题，我也不清楚如何解决。也许，车到山前必有路呢？</p>\n<p><strong>一条大河波浪宽</strong><br>\n<strong>风吹稻花香两岸</strong><br>\n<strong>我家就在这岸上住</strong><br>\n<strong>听惯了艄公的号子</strong><br>\n<strong>看惯了船上的白帆</strong></p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>我也不清楚以上内容有多少错误，有哪些不足，不过这些东西总会在前行的道路上逐渐出现，并得以解决。</p>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2026/01/16/CUDA02/",
            "url": "https://forcheetah.github.io/2026/01/16/CUDA02/",
            "title": "【CUDA C++】GPU存储【2】",
            "date_published": "2026-01-16T14:19:44.696Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇是介绍 GPU 的存储硬件。资料来源于 <a href=\"https://docs.nvidia.com/cuda/cuda-programming-guide/contents.html\">官网 CUDA Programming Guide</a>。本文会比官网教程简洁一些，去掉一些我不太感兴趣的内容（任性）。</p>\n<p>参考  <a href=\"https://docs.nvidia.com/cuda/cuda-programming-guide/contents.html\">官网 CUDA Programming Guide</a>。</p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"gpu-memory\"><a class=\"anchor\" href=\"#gpu-memory\">#</a> GPU Memory</h1>\n<p>在现代计算系统中，有效利用内存与最大限度地利用执行计算的逻辑单元同样重要。异构系统拥有多个内存空间，而图形处理器（GPU）除了缓存之外，还包含多种类型的可编程片上内存。</p>\n<p><img loading=\"lazy\" data-src=\"1768573069898.jpg\" alt=\"CPU 存储\"></p>\n<h1 id=\"global-memory全局内存\"><a class=\"anchor\" href=\"#global-memory全局内存\">#</a> Global Memory（全局内存）</h1>\n<ul>\n<li>物理本质：GPU 芯片外的 DRAM 芯片（即显存，VRAM）</li>\n<li>别名：GPU DRAM、Device Memory</li>\n<li>访问范围：所有 SM（Streaming Multiprocessors）均可访问</li>\n<li>特点：</li>\n<li>容量大（如 8GB–24GB）</li>\n<li>延迟高，但带宽极高（通过宽总线）</li>\n<li>在 CUDA 编程中通过 cudaMalloc () 分配</li>\n<li>在架构图中的位置</li>\n<li>位于 GPU 芯片外部，通过 Memory Controller 连接到 GPU 核心，通常标注为 &quot;GPU DRAM&quot; 或 &quot;Global Memory&quot;。</li>\n</ul>\n<h1 id=\"system-memory-host-memory系统内存-主机内存\"><a class=\"anchor\" href=\"#system-memory-host-memory系统内存-主机内存\">#</a> System Memory / Host Memory（系统内存 / 主机内存）</h1>\n<ul>\n<li>物理本质：CPU 旁边的 DDR4/DDR5 内存条</li>\n<li>访问者：CPU 可直接访问；GPU 需通过 PCIe 或 NVLink 访问（速度慢）</li>\n<li>在统一虚拟地址空间下：与 GPU 全局内存共用一个地址空间，但物理分离</li>\n<li>在架构图中的位置：<br>\n位于 CPU 一侧，通过 PCIe/NVLink 总线连接到 GPU，通常标注为 &quot;SYSTEM DRAM&quot; 或 &quot;Host Memory&quot;。</li>\n</ul>\n<h1 id=\"on-chip-memory片上内存属于每个-sm\"><a class=\"anchor\" href=\"#on-chip-memory片上内存属于每个-sm\">#</a> On-Chip Memory（片上内存）—— 属于每个 SM</h1>\n<h2 id=\"a-register-file寄存器文件\"><a class=\"anchor\" href=\"#a-register-file寄存器文件\">#</a> (a) Register File（寄存器文件）</h2>\n<ul>\n<li>归属：每个 SM 独有</li>\n<li>分配单位：每个线程（thread）</li>\n<li>用途：存储线程的局部变量（由编译器自动分配）</li>\n<li>特点：</li>\n<li>速度最快（零延迟访问）</li>\n<li>容量有限（如每个 SM 有 65536 个 32-bit 寄存器）</li>\n<li>线程块能否被调度到 SM，取决于寄存器是否够用</li>\n<li>在架构图中的位置：<br>\n位于 每个 SM 内部，紧邻 CUDA Core / FP32 ALU，通常标为 &quot;Register File&quot;。</li>\n</ul>\n<h2 id=\"b-shared-memory共享内存\"><a class=\"anchor\" href=\"#b-shared-memory共享内存\">#</a> (b) Shared Memory（共享内存）</h2>\n<ul>\n<li>归属：每个 SM 独有</li>\n<li>分配单位：每个线程块（thread block）</li>\n<li>用途：线程块内线程间通信、数据重用（如矩阵分块）</li>\n<li>特点：</li>\n<li>速度极快（接近寄存器）</li>\n<li>容量小（通常 64KB–164KB per SM），可与 L1 缓存动态划分</li>\n<li>程序员显式管理（ <code>__shared__</code>  关键字）</li>\n<li>在架构图中的位置：<br>\n位于 SM 内部，与 Register File 并列，常标为 &quot;Shared Memory&quot; 或包含在 &quot;Unified Data Cache&quot; 模块中（因与 L1 共享物理存储）。</li>\n</ul>\n<h1 id=\"caches缓存\"><a class=\"anchor\" href=\"#caches缓存\">#</a> Caches（缓存）</h1>\n<h2 id=\"a-l1-cache一级缓存\"><a class=\"anchor\" href=\"#a-l1-cache一级缓存\">#</a> (a) L1 Cache（一级缓存）</h2>\n<ul>\n<li>归属：每个 SM 独有</li>\n<li>物理实现：与 Shared Memory 共享同一块 SRAM（称为 Unified Data Cache）</li>\n<li>用途：缓存 global memory 的数据（可配置为更多 L1 或更多 Shared Memory）</li>\n<li>在架构图中的位置：<br>\n通常与 Shared Memory 合并表示为 &quot;Unified Data Cache&quot; 或 &quot;L1/Shared Memory&quot; 模块，位于 SM 内部。</li>\n</ul>\n<h2 id=\"b-l2-cache二级缓存\"><a class=\"anchor\" href=\"#b-l2-cache二级缓存\">#</a> (b) L2 Cache（二级缓存）</h2>\n<ul>\n<li>归属：整个 GPU 共享</li>\n<li>用途：缓存所有 SM 对 global memory 的访问，减少 DRAM 访问次数</li>\n<li>容量：几 MB 到几十 MB（如 RTX 4090 有 72MB L2）</li>\n<li>在架构图中的位置：<br>\n位于 所有 SM 之外、GPU DRAM 之前，通常画成一个大的 &quot;L2 Cache&quot; 模块，连接所有 SM 和 Memory Controller。</li>\n</ul>\n<h2 id=\"c-constant-cache常量缓存\"><a class=\"anchor\" href=\"#c-constant-cache常量缓存\">#</a> (c) Constant Cache（常量缓存）</h2>\n<ul>\n<li>归属：每个 SM 独有</li>\n<li>用途：缓存标记为  <code>__constant__</code>  的只读数据（如 kernel 参数）</li>\n<li>特点：小容量、广播式访问、低延迟</li>\n<li>在架构图中的位置：<br>\n通常在 SM 内部单独标出，或作为 L1 之外的一个小模块，标为 &quot;Constant Cache&quot;。</li>\n</ul>\n<h1 id=\"unified-memory统一内存\"><a class=\"anchor\" href=\"#unified-memory统一内存\">#</a> Unified Memory（统一内存）</h1>\n<ul>\n<li>注意：这不是一种 “物理内存”，而是一种编程模型 + 硬件 / 运行时支持机制</li>\n<li>作用：让 CPU 和 GPU 使用同一个指针访问数据，系统自动迁移数据</li>\n<li>底层仍使用：System Memory + Global Memory（物理上仍是两块）</li>\n<li>在架构图中：不对应具体硬件模块，但依赖 统一虚拟地址空间（Unified Virtual Addressing, UVA） 和 页迁移引擎（Page Migration Engine），这些通常由 MMU（内存管理单元） 和 IOMMU 支持，在高级架构图中可能不显式画出。</li>\n</ul>\n<h1 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结：</h1>\n<p><img loading=\"lazy\" data-src=\"1768573153283.jpg\" alt=\"总结图\"></p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，看到一定及时回复！</p>\n",
            "tags": [
                "AI",
                "CUDA"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2026/01/16/CUDA01/",
            "url": "https://forcheetah.github.io/2026/01/16/CUDA01/",
            "title": "【CUDA C++】GPU基本介绍【1】",
            "date_published": "2026-01-16T14:14:58.167Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇是介绍 CUDA C++ 的第一篇。资料来源于 <a href=\"https://docs.nvidia.com/cuda/cuda-programming-guide/contents.html\">官网 CUDA Programming Guide</a>。本文会比官网教程简洁一些，去掉一些我不太感兴趣的内容（任性）。</p>\n<p>参考  <a href=\"https://docs.nvidia.com/cuda/cuda-programming-guide/contents.html\">官网 CUDA Programming Guide</a>。</p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"gpu-和-cpu-对比\"><a class=\"anchor\" href=\"#gpu-和-cpu-对比\">#</a> GPU 和 CPU 对比</h1>\n<p>在相同的价格和功耗范围内，GPU 的指令处理量和内存带宽都远高于 CPU。许多应用程序利用这些特性，在 GPU 上运行的速度要比在 CPU 上快得多（详见 “GPU 应用” 部分）。其他计算设备，如 FPGA，同样具有很高的能效，但相比 GPU，其编程灵活性要低得多。</p>\n<p>图形处理器（GPU）和中央处理器（CPU）的设计目标各不相同。CPU 的设计初衷是尽可能快速地执行一系列连续的操作（称为 “线程”），并且能够并行执行几十个这样的线程；而 GPU 则旨在并行执行数千个线程，以牺牲单线程性能为代价来实现更高的总吞吐量。</p>\n<p>图形处理器（GPU）专用于高度并行的计算，并在数据处理单元上投入更多晶体管，而中央处理器（CPU）则在数据缓存和流程控制方面投入更多晶体管。下图 展示了 CPU 与 GPU 在芯片资源分配方面的示例情况。</p>\n<p><img loading=\"lazy\" data-src=\"1768572721571.jpg\" alt=\"CPU 与 GPU\"></p>\n<p>利用 GPU 提供的计算能力有多种方法。本指南介绍了使用 C++ 等高级语言在 CUDA GPU 平台上进行编程的方法。然而，在不需要直接编写 GPU 代码的应用程序中，也有许多利用 GPU 的方式。</p>\n<p>通过专门的库，可以获取来自不同领域的不断增多的算法和程序集。当某个库已经实现（尤其是由 NVIDIA 提供的那些）时，使用该库通常比从头开始重新实现算法更具效率和性能。像 cuBLAS、cuFFT、cuDNN 和 CUTLASS 这样的库只是帮助开发人员避免重新实现成熟算法的几个例子。这些库还有一个额外的好处，即针对每种 GPU 架构进行了优化，从而提供了高效性、性能和可移植性的理想组合。</p>\n<p>此外，还有一些框架（尤其是那些用于人工智能的框架）提供了基于 GPU 加速的构建模块。这些框架的加速功能是通过利用上述提到的 GPU 加速库来实现的。</p>\n<p>此外，诸如 NVIDIA 的 Warp 或 OpenAI 的 Triton 这类特定领域的语言（DSL）能够编译并直接在 CUDA 平台上运行。这为对 GPU 进行编程提供了一种比本指南中所涵盖的高级语言更高层次的方法。</p>\n<h1 id=\"异构系统\"><a class=\"anchor\" href=\"#异构系统\">#</a> 异构系统</h1>\n<p>CUDA 编程模型假定存在一种异构计算系统，即包含图形处理器（GPU）和中央处理器（CPU）的系统。与 CPU 直接相连的内存被称为主机和主机内存。与 GPU 直接相连的内存则被称为设备和设备内存。在某些片上系统（SoC）中，这些可能共用一个封装。在更大的系统中，可能会有多个 CPU 或 GPU。</p>\n<p>CUDA 应用程序会在 GPU 上执行其部分代码，但应用程序总是从 CPU 开始执行。主机代码（即在 CPU 上运行的代码）可以使用 CUDA API 在主机内存和设备内存之间复制数据、启动在 GPU 上执行的代码，并等待数据复制或 GPU 代码完成。CPU 和 GPU 可以同时执行代码，并且通常通过最大限度地利用 CPU 和 GPU 的利用率来获得最佳性能。</p>\n<p>应用程序在 GPU 上执行的代码被称为设备代码，而用于在 GPU 上执行的函数则由于历史原因被称为内核。启动一个内核运行的过程被称为启动内核。内核启动可以理解为在 GPU 上同时启动许多执行内核代码的线程。内核启动类似于 CPU 上的线程，不过在正确性和性能方面存在一些重要差异。</p>\n<h1 id=\"gpu-硬件模型\"><a class=\"anchor\" href=\"#gpu-硬件模型\">#</a> GPU 硬件模型</h1>\n<p>与任何编程模型一样，CUDA 也依赖于对底层硬件的某种概念性模型。对于 CUDA 编程而言，GPU 可以被视为一组流式多处理器 Streaming Multiprocessors（SM），这些 SM 以称为图形处理集群 Graphics Processing Clusters（GPC）的组形式组织在一起。每个 SM 都包含一个本地寄存器文件 local register file、一个统一的数据缓存 unified data cache，以及执行计算的若干功能单元。统一的数据缓存为共享内存和 L1 缓存提供了物理资源。统一数据缓存的分配到 L1 和共享内存可以在运行时进行配置。不同类型的内存的大小以及每个 SM 内部的功能单元的数量在不同的 GPU 架构中可能会有所不同。</p>\n<p><img loading=\"lazy\" data-src=\"1768572794775.jpg\" alt=\"硬件模型\"></p>\n<p>上图是 CPU 和 GPU 的硬件架构对比图，可以看到总体结构类似。CPU 有主机内存 System DRAM，个人电脑常见的运行内存 8G、 16G、 32G。GPU 有他的显存 GPU DRAM，常见的 8G、12G 等，与主机内存处于同一水平，但是 GPU 显存带宽更高，速度更快。CPU 有三个缓存层级，L1 → L2 → L3，逐级变大变慢。而 GPU 为两层，L1 + 共享内存 → L2，没有 L3。CPU 有少量的核心数量，少（比如 4～16 个核心）。而 GPU 有大量的核心，成百上千个，这些核心被组织成 warp、block、cluster、grid、SM、GPC 等，后续会介绍到。</p>\n<h2 id=\"thread-blocks-和-grids\"><a class=\"anchor\" href=\"#thread-blocks-和-grids\">#</a> Thread Blocks 和 Grids</h2>\n<p>当一个应用程序启动内核时，它会使用大量线程，通常多达数百万个线程。这些线程被组织成不同的 block——Thread Block。Thread Block 被组织成一个 grid。grid 中的所有 Thread Block 都具有相同的大小和尺寸。</p>\n<p><img loading=\"lazy\" data-src=\"1768572820238.jpg\" alt=\"grid\"></p>\n<p>通过使用内置变量，每个执行内核的线程都能够确定其所在所在的包含 Block 的位置，以及其所在的包含 Grid 中的位置。线程还可以利用这些内置变量来确定 Thread Block 的尺寸以及内核被启动时所在的 grid 的尺寸。这使得每个线程在运行内核的所有线程中都具有独特的身份。这种身份通常用于确定某个线程负责处理哪些数据或执行哪些操作。</p>\n<p>一个 Thread Block 中的所有线程都在一个单一的 SM 中执行。这使得 Thread Block 内的线程能够高效地进行通信和同步。Thread Block 内的所有线程都能访问片上共享内存，该内存可用于 Thread Block 内各线程之间的信息交换。</p>\n<p>一个 grid 可能由数百万个 Thread Block 组成，而执行该 Grid 的 GPU 只可能拥有几十或几百个 SM（流处理器）。一个 Thread Block 中的所有线程都由一个单独的 SM 执行，并且在大多数情况下，这些线程会在该 SM 上完成运行。Thread Block 之间没有调度保证，因此一个 Thread Block 不能依赖其他 Thread Block 的结果，因为这些结果可能要等到该 Thread Block 完成之后才能被调度。下图展示了 grid 中的 Thread Block 如何被分配到一个 SM 上的示例。</p>\n<p><img loading=\"lazy\" data-src=\"1768572836438.jpg\" alt=\"SM\"></p>\n<p>每个 SM 中都有一个或多个活跃的 Thread Block。在本示例中，每个 SM 同时调度了三个 Thread Block。对于 Grid 中的 Thread Block 分配到 SM 的顺序，并没有任何保证。</p>\n<p>除了线程块之外，具有 compute capability 9.0  及更高版本的 GPU 还有一种可选的分组方式，称为 “Cluster”。Cluster 是由一组 Thread Block 组成的，与 Thread Block 和 Grid 一样，可以以 1 维、2 维或 3 维的形式排列。图 5 展示了一个网格化的 Thread Block，它被组织成了 Cluster。指定 Cluster 并不会改变 Grid 的尺寸或 Grid 内 Thread Block 的索引。</p>\n<p><img loading=\"lazy\" data-src=\"1768572854711.jpg\" alt=\"Cluster\"></p>\n<p>将相邻的 Thread Block 划分成 clusters ，并在 clusters 级别提供了更多的同步和通信机会。具体而言，一个 clusters 中的所有线程块都在单个 GPC 中执行。图 6 展示了在指定 clusters 时，Thread Block 如何在 GPC 中被分配到 SM 上。由于 Thread Block 是同时在单个 GPC 中进行调度的，因此同一 cluster 内的不同 Thread Block 中的线程可以使用由协作组提供的软件接口进行通信和同步。Cluster 中的线程可以访问 Cluster 中所有 Thread Block 的共享内存，这被称为分布式共享内存。Cluster 的最大大小取决于硬件，并且在不同的设备中有所不同。</p>\n<p><img loading=\"lazy\" data-src=\"1768572868342.jpg\" alt=\"SM cluster\"></p>\n<h2 id=\"warps-和-simt\"><a class=\"anchor\" href=\"#warps-和-simt\">#</a> Warps 和 SIMT</h2>\n<p>在一个线程块内，线程被组织成由 32 个线程组成的组，这些组被称为 “warps”。一个 warp 按照 “单指令多线程”（SIMT）模式执行内核代码。在 SIMT 模式中，warp 中的所有线程都在执行相同的内核代码，但每个线程可能会根据不同的分支路径来执行代码。也就是说，尽管程序的所有线程都执行相同的代码，但这些线程并不需要遵循相同的执行路径。</p>\n<p>当线程由一个 warp 执行时，它们会被分配一个线程组通道 warp lane。warp lane 的编号范围为 0 到 31，而来自一个线程块的线程会按照硬件多线程中所详述的可预测方式分配到 warp 中。</p>\n<p>在 warp 中的所有线程会同时执行相同的指令。如果一个 warp 中的某些线程在执行过程中遵循了控制流分支，而其他线程没有这样做，那么不遵循分支的线程将会被屏蔽掉，而遵循分支的线程则会被执行。例如，如果一个条件仅在 warp 中的半数线程中为真，那么另一半织线中的线程将会被屏蔽掉，而活跃的线程则会执行那些指令。这种情况如下图所示。当一个 warp 中的不同线程遵循不同的代码路径时，这有时被称为 warp 分歧。因此，当 warp 中的线程遵循相同的控制流路径时，GPU 的利用率会达到最大化。</p>\n<p><img loading=\"lazy\" data-src=\"1768572880609.jpg\" alt=\"warp lanes\"></p>\n<p>在 SIMT 模型中，同一线程 warp 中的所有线程会同步地在内核中执行。硬件执行方式可能有所不同。有关此区别在何处重要的更多信息，请参阅 “独立线程执行” 部分。利用了解线程 warp 实际映射到实际硬件的方式的知识是不被提倡的。CUDA 编程模型和 SIMT 表示，同一线程 warp 中的所有线程会一起执行代码。只要遵循编程模型，硬件就可以以对程序不可见的方式优化掩码通道。如果程序违反了这个模型，这可能会导致未定义的行为，且这种行为在不同的 GPU 硬件上可能有所不同。</p>\n<p>虽然在编写 CUDA 代码时无需考虑线程组（warp）的问题，但了解线程组的执行模型有助于理解诸如全局内存协同和共享内存 bank 访问模式等概念。一些高级编程技术会利用线程块内线程 warp 的特化来限制线程的分歧并最大限度地提高利用率。这些以及其他优化措施都利用了在执行时线程会被分组为线程 warp 这一事实。</p>\n<p>线程执行的一个影响是，线程块的最佳设定应使其总线程数为 32 的倍数。可以使用任意数量的线程，但当总数不是 32 的倍数时，线程块的最后一组线程在执行过程中会有部分线程处于未使用状态。这很可能会导致该线程 warp 的功能单元利用率和内存访问效率降低。</p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，看到一定及时回复！</p>\n",
            "tags": [
                "AI",
                "CUDA"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2025/11/15/halide2/",
            "url": "https://forcheetah.github.io/2025/11/15/halide2/",
            "title": "【Halide】调度优化【2】",
            "date_published": "2025-11-15T04:00:44.194Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇文章介绍 Halide 多级流水线调度优化策略。</p>\n<p>本文来自于<a href=\"https://halide-lang.org/tutorials/tutorial_lesson_08_scheduling_2.html\">《Halide 官方教程》</a>，读者可以去阅读原文。所以看本文的价值在于？呃…… 是中文的？（但原文肯定更准确）更简洁？（也许是缺点）画图更清楚？（假的，因为官网图更好，还是动图，我不想画了）。所以我也不知道为啥一定要看这篇文章而不是原文，唯一好处是我挑出了重点？官方教程文章太多，我只挑其中几篇重点，这是第一篇，全当自己记录了。</p>\n<p>仍然建议看原文。</p>\n<p>Halide 这篇教程的多级流水线（multi-stage pipelines）指的是多个计算步骤，第一个计算步骤的结果是第二个计算步骤的输入，怎样的流水线调度才能在空间占用、计算复杂度两个方面达到好的效率。这种场景和神经网络推理非常相似，神经网络是一个拓扑结构图，后续节点的输入来自前序节点的输出。所以本节对神经网络的推理优化也有借鉴意义。</p>\n<p>参考链接：<a href=\"https://halide-lang.org/tutorials/tutorial_lesson_08_scheduling_2.html\">《Halide 官方教程》</a></p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"halide\"><a class=\"anchor\" href=\"#halide\">#</a> Halide</h1>\n<p>Halide 是一种专门设计的领域特定语言（DSL），主要用于编写高性能的图像处理和数组计算程序。它由 MIT 和 Adobe Research 的研究人员于 2010 年左右开发，并因其在优化复杂图像处理流水线方面的卓越能力而受到广泛关注。Halide 的核心创新在于将算法（What to compute）与调度（How and when to compute it）明确分离。</p>\n<p>Halide 通常作为 C++ 的嵌入式 DSL 使用。你用 C++ 编写程序，在其中定义 Halide 的函数和调度。</p>\n<p>Halide 编译器会将 Halide 代码（算法 + 调度）编译成高效的 C++ 或 GPU 代码（如 CUDA, OpenCL, Metal），然后链接到你的主程序中。</p>\n<p>它拥有一个强大的 JIT（即时编译）和 AOT（提前编译）编译系统。</p>\n<h1 id=\"多级流水线调度\"><a class=\"anchor\" href=\"#多级流水线调度\">#</a> 多级流水线调度</h1>\n<p>Halide 这篇教程的多级流水线（multi-stage pipelines）指的是多个计算步骤，第一个计算步骤的结果是第二个计算步骤的输入，怎样的流水线调度才能在空间占用、计算复杂度两个方面达到好的效率。这种场景和神经网络推理非常相似，神经网络是一个拓扑结构图，后续节点的输入来自前序节点的输出。所以本节对神经网络的推理优化也有借鉴意义。</p>\n<h2 id=\"两级流水线默认调度\"><a class=\"anchor\" href=\"#两级流水线默认调度\">#</a> 两级流水线默认调度</h2>\n<p>官网给的例子是  <code>producer</code>  和  <code>consumer</code> ，函数   <code>producer</code>  的输出数据作为  <code>consumer</code>  的输入。简单如下所示：</p>\n<p><img loading=\"lazy\" data-src=\"1763179216730.jpg\" alt=\"两级流水线\"></p>\n<p>用以下代码来构建这个默认的例子：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Var <span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"y\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                          <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                          <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                          <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>经过编译之后，等效的 C 代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">float</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        result<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                        <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                        <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                        <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>可以看到代码中间   <code>producer</code>  的位置已经全部替换为其函数内容，即默认的多级调度情况下，Halide 会将  <code>producer</code>  全部内联到  <code>consumer</code>  中。</p>\n<h2 id=\"root-调度\"><a class=\"anchor\" href=\"#root-调度\">#</a> Root 调度</h2>\n<p>所有  <code>producer</code>  计算完毕之后，再计算   <code>consumer</code>  ，官方例子中叫它 root 调度。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"producer_root\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"consumer_root\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">compute_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// 增加该指令</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// Turn on tracing.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>和默认调度的差异是，增加了 <code>compute_root()</code>  这条指令。</p>\n<p>动图展示为：（动图中黄色方块代表存储 [store]，即计算完毕之后存储下来；蓝色方块代表加载 [load]，即读取暂存数据，用于下一步计算。）</p>\n<p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_08_compute_root.gif\" alt=\"root调度运行示例\"></p>\n<p>等效的 C 代码如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">float</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// Allocate some temporary storage for the producer.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">float</span> producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// Compute the producer.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        producer_storage<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// Compute the consumer. Skip the prints this time.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        result<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>producer_storage<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>值得注意的是，由于  <code>consumer</code>  和 <code>producer</code>  的特点，中间 Data  <code>producer_storage</code>  是  <code>5*5</code>  的矩阵，最后输出 <code>result</code>  是  <code>4*4</code>  的矩阵。</p>\n<p>从上方结果来看， <code>compute_root()</code>  使得代码走向 全部内联的反面，所有的 <code>producer</code>  结果都提前计算完成，然后由 <code>consumer</code>  读取中间结果，进行计算。</p>\n<p>比较一下 “全部内联的默认调度” 和 “Root 调度” 两种算法的表现：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Full inlining (the default schedule):</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// - Temporary memory allocated: 0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// - Loads: 0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// - Stores: 16</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// - Calls to sin: 64</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// producer.compute_root():</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// - Temporary memory allocated: 25 floats</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// - Loads: 64</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">// - Stores: 41</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// - Calls to sin: 25</span></pre></td></tr></table></figure><p>1. 内联方式，没有中间结果的临时存储，因此临时内存分配为 0；root 调度方式，中间存储了 <code>5*5</code>  的中间结果，所以临时内存分配为 25 floats<br>\n2. 内联方式，没有中间结果，所以也不需要 load； root 调度方式，输出的 <code>4*4</code>  个结果，每个都需要读取 4 个中间数据，所以 loads 有 64 次（可能忽略掉了两种方式都需要的、对 Input 数据的加载）<br>\n3. 内联方式只存储最终结果  <code>4*4</code> ；root 调度方式，还需要存储中间结果的 <code>5*5</code> ，所以是 41.<br>\n4. 内联方式，调用 Sin 函数达 64 次；而 root 调度方式，只需要调用 25 次。<br>\n两种方法各有优劣，全内联方式使用了最小的临时空间和内存带宽，但是在昂贵的复杂计算上花费了更多时间；root 调度方式正好相反。选择哪一种调度方法，需要取决于目标应用场景到底对什么更敏感，是空间存储，还是计算耗时。</p>\n<h2 id=\"每当足够计算一行y时计算y\"><a class=\"anchor\" href=\"#每当足够计算一行y时计算y\">#</a> 每当足够计算一行 y 时，计算 y</h2>\n<p>全内联和 root 调度两种方式的中间选择。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"producer_y\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"consumer_y\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// Tell Halide to evaluate producer as needed per y coordinate of the consumer:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">compute_at</span><span class=\"token punctuation\">(</span>consumer<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// Turn on tracing.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>动图结果：</p>\n<p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_08_compute_y.gif\" alt=\"compute_at运行示例\"></p>\n<p>等效 C 表示：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">float</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// There's an outer loop over scanlines of consumer:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// Allocate space and compute enough of the producer to</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// satisfy this single scanline of the consumer. This</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// means a 5x2 box of the producer.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">float</span> producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> py <span class=\"token operator\">=</span> y<span class=\"token punctuation\">;</span> py <span class=\"token operator\">&lt;</span> y <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> py<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> px <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> px <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> px<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            producer_storage<span class=\"token punctuation\">[</span>py <span class=\"token operator\">-</span> y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>px<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>px <span class=\"token operator\">*</span> py<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// Compute a scanline of the consumer.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        result<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>compute_at()</code>  指令使得算法先算完能够计算一行  <code>consumer</code>  数据的中间结果，然后算一行 <code>consumer</code> 。下一步计算第二行需要的中间结果，之后计算第二行 <code>consumer</code> 。可以看到计算第二行 Y 所需要的中间结果时，第一行 Y 所需要的中间结果并没有保留，这导致一部分 <code>producer</code>  的重复计算。</p>\n<p>该调度形式的表现：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// producer.compute_at(consumer, y):</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// - Temporary memory allocated: 10 floats</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// - Loads: 64</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// - Stores: 56</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// - Calls to sin: 40</span></pre></td></tr></table></figure><p>从上述分析看，所需要的临时存储空间，只有计算一行 Y 所需要的 10 个 floats 。多于全内联方式，但少于 root 调度方式，其复杂计算 sin 的计算次数也在两者之间。</p>\n<h2 id=\"存储中间变量\"><a class=\"anchor\" href=\"#存储中间变量\">#</a> 存储中间变量</h2>\n<p>上一小节中只用了 10 个 floats 的临时存储空间，尽管相邻两行 Y 所需要的 Sin 函数有重复，但还是进行了重复计算。</p>\n<p>本节通过 <code>producer.store_root()</code>  告知 Halide 存储所有中间变量。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"producer_root_y\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"consumer_root_y\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// Tell Halide to make a buffer to store all of producer at</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// the outermost level:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">store_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// ... but compute it as needed per y coordinate of the consumer.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">compute_at</span><span class=\"token punctuation\">(</span>consumer<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nEvaluating producer.store_root().compute_at(consumer, y)\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>动图示例：</p>\n<p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_08_store_root_compute_y.gif\" alt=\"store_root运行示例\"></p>\n<p>等效 C 代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">float</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// producer.store_root() implies that storage goes here:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">float</span> producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// There's an outer loop over scanlines of consumer:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// Compute enough of the producer to satisfy this scanline</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// of the consumer.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> py <span class=\"token operator\">=</span> y<span class=\"token punctuation\">;</span> py <span class=\"token operator\">&lt;</span> y <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> py<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// Skip over rows of producer that we've already</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// computed in a previous iteration.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> py <span class=\"token operator\">==</span> y<span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> px <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> px <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> px<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            producer_storage<span class=\"token punctuation\">[</span>py<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>px<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>px <span class=\"token operator\">*</span> py<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// Compute a scanline of the consumer.</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        result<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>producer_storage<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>从结果可看， <code>5*5</code>  的中间结果全部保留下来。最初计算一行 Y，需要 <code>5*2</code>  的 producer 结果，之后每计算 <code>5*1</code>  的 producer 结果，都可以计算一行 Y。重复计算就没有了。</p>\n<p>该算法的表现：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// producer.store_root().compute_at(consumer, y):</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// - Temporary memory allocated: 10 floats</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// - Loads: 64</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// - Stores: 41</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// - Calls to sin: 25</span></pre></td></tr></table></figure><p>观察该算法的表现数据，发现 <code>Temporary memory allocated: 10 floats</code>  存在问题，不应该是 25 个吗？</p>\n<p>官网解释说：Halide 做了进一步优化，将两行中间中间结果的存储空间做成了环形缓冲区，因此只需要 10 个 floats 的空间。</p>\n<p>因此实际的 C 等效代码为：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Actually store 2 scanlines instead of 5</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">float</span> producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> py <span class=\"token operator\">=</span> y<span class=\"token punctuation\">;</span> py <span class=\"token operator\">&lt;</span> y <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> py<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> py <span class=\"token operator\">==</span> y<span class=\"token punctuation\">)</span> <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> px <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> px <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> px<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token comment\">// Stores to producer_storage have their y coordinate bit-masked.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            producer_storage<span class=\"token punctuation\">[</span>py <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>px<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>px <span class=\"token operator\">*</span> py<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// Compute a scanline of the consumer.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// Loads from producer_storage have their y coordinate bit-masked.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        result<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"最外层存储最内层计算\"><a class=\"anchor\" href=\"#最外层存储最内层计算\">#</a> 最外层存储，最内层计算</h2>\n<p>使用 Halide 的  <code>compute_at(consumer, x)</code> （异于前述的 <code>compute_at(consumer, y)</code> ）。那么它的表述意思就是 <code>consumer</code>  每得到能够计算一个结果的中间数据，即计算 <code>consumer</code> 。（异于前述的 <code>compute_at(consumer, y)</code>  为 <code>consumer</code>  每得到能够一行结果的中间数据，即计算 <code>consumer</code> ）</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"producer_root_x\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"consumer_root_x\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// Store outermost, compute innermost.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">store_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">compute_at</span><span class=\"token punctuation\">(</span>consumer<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nEvaluating producer.store_root().compute_at(consumer, x)\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>动图示例：</p>\n<p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_08_store_root_compute_x.gif\" alt=\"computex运行示例\"></p>\n<p>等效 C 代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">float</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// producer.store_root() implies that storage goes here, but</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// we can fold it down into a circular buffer of two</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// scanlines:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">float</span> producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// For every pixel of the consumer:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// Compute enough of the producer to satisfy this</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// pixel of the consumer, but skip values that we've</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// already computed:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> x <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            producer_storage<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        producer_storage<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        result<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                        producer_storage<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>从动图中可以看到，中间数据的计算顺序和 <code>compute_at(consumer, y)</code>  情况下也不一样了。其首先得到四个中间结果，之后立即计算  <code>producer</code> 。</p>\n<p>该算法的表现：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// producer.store_root().compute_at(consumer, x):</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// - Temporary memory allocated: 10 floats</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// - Loads: 48</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// - Stores: 41</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// - Calls to sin: 25</span></pre></td></tr></table></figure><p>当前的算法算是迄今表现最好的。其中 Loads 的操作数为 48，而不是  <code>16*4=64</code> ，官方文档解释说：每 4 个需要的 <code>producer</code>  值中，有一个可能仍然存在于寄存器中，不会将其视为加载，所以只需要加载其余 3 个，是  <code>16*3=48</code> 。 我也不太懂在运行过程中哪个中间值存在于寄存器中，但结果就是加载 48 次（先接受这个设定好了）。</p>\n<p>既然现在的算法是表现最好的，那么为什么不在任何情况下都采用  <code>producer.store_root().compute_at(consumer, x)</code>  呢？原因是并行性，上述把空间利用到极限的情况下，并行就无法实现了。<br>\n在前面的两种策略中，我们都假设在之前的迭代中计算的值可以重用。这需要假定先前的 x 或 y 值发生在较早的时间并且已经完成。如果并行化或向量化任一循环，则不成立。如果并行化，Halide 将不会注入那些在 store_at 层和 compute_at 层之间存在并行循环时跳过已经完成的工作的优化，并且也不会将存储折叠到一个循环缓冲区中，这使得我们的 store_root 变得毫无意义。</p>\n<h2 id=\"综合应用\"><a class=\"anchor\" href=\"#综合应用\">#</a> 综合应用</h2>\n<p>前述已经介绍了所有操作，本小节是综合应用。当然还涉及到<a href=\"https://forcheetah.github.io/2025/11/06/halide/\">【Halide】调度优化【1】</a>中的知识。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"producer_tile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"consumer_tile\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">*</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">consumer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                  <span class=\"token function\">producer</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">// We'll compute 8x8 of the consumer, in 4x4 tiles.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Var x_outer<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> y_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">tile</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> y_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// Compute the producer per tile of the consumer</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">compute_at</span><span class=\"token punctuation\">(</span>consumer<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// Notice that I wrote my schedule starting from the end of</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// the pipeline (the consumer). This is because the schedule</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// for the producer refers to x_outer, which we introduced</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// when we tiled the consumer. You can write it in the other</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// order, but it tends to be harder to read.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// Turn on tracing.</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>producer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>consumer<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>上述过程切分出  <code>4*4</code>  的小块，然后使用 <code>compute_at(consumer, x_outer)</code>  指令，即获得足够计算 <code>x_outer</code>  的中间数据之后，即开始计算 <code>x_outer</code> 。<br>\n动图示例：</p>\n<p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_08_tile.gif\" alt=\"综合运行示例\"></p>\n<p>等效 C 代码：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">float</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// For every tile of the consumer:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y_outer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y_outer <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> y_outer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_outer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_outer <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> x_outer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">// Compute the x and y coords of the start of this tile.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">int</span> x_base <span class=\"token operator\">=</span> x_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">int</span> y_base <span class=\"token operator\">=</span> y_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// Compute enough of producer to satisfy this tile. A</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// 4x4 tile of the consumer requires a 5x5 tile of the</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// producer.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">float</span> producer_storage<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> py <span class=\"token operator\">=</span> y_base<span class=\"token punctuation\">;</span> py <span class=\"token operator\">&lt;</span> y_base <span class=\"token operator\">+</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> py<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> px <span class=\"token operator\">=</span> x_base<span class=\"token punctuation\">;</span> px <span class=\"token operator\">&lt;</span> x_base <span class=\"token operator\">+</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> px<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                producer_storage<span class=\"token punctuation\">[</span>py <span class=\"token operator\">-</span> y_base<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>px <span class=\"token operator\">-</span> x_base<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">sin</span><span class=\"token punctuation\">(</span>px <span class=\"token operator\">*</span> py<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// Compute this tile of the consumer</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y_inner <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y_inner<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_inner <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x_inner<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> x_base <span class=\"token operator\">+</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> y_base <span class=\"token operator\">+</span> y_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                result<span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    <span class=\"token punctuation\">(</span>producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">-</span> y_base<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> x_base<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                     producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">-</span> y_base <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> x_base<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                     producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">-</span> y_base<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> x_base <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                     producer_storage<span class=\"token punctuation\">[</span>y <span class=\"token operator\">-</span> y_base <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>x <span class=\"token operator\">-</span> x_base <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"最后\"><a class=\"anchor\" href=\"#最后\">#</a> 最后</h1>\n<p>找到优秀的调度方法很难。我们最终在内存带宽、冗余工作和并行性之间进行了三方面的权衡。Halide 不能自动为您做出正确的选择（抱歉）。相反，它试图使您更容易探索各种选项，而不会弄乱您的程序。实际上，Halide 承诺像 compute_root 这样的调度调用不会改变你的算法的含义 —— 无论你如何调度，你都应该得到相同的结果。</p>\n<p>Halide 不仅仅是矢量化和并行化你的代码。这不足以让你走得很远。Halide 为您提供了一些工具，帮助您快速探索局部性、冗余工作和并行性之间的不同权衡，而不会弄乱您试图计算的实际结果。</p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2025/11/06/halide/",
            "url": "https://forcheetah.github.io/2025/11/06/halide/",
            "title": "【Halide】调度优化【1】",
            "date_published": "2025-11-06T13:52:47.745Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇文章介绍 Halide 的 Vectorize, parallelize, unroll , tile 等优化策略。</p>\n<p>本文来自于<a href=\"https://halide-lang.org/tutorials/tutorial_lesson_05_scheduling_1.html\">《Halide 官方教程》</a>，读者可以去阅读原文。所以看本文的价值在于？呃…… 是中文的？（但原文肯定更准确）更简洁？（也许是缺点）画图更清楚？（假的，因为官网图更好，还是动图，我不想画了）。所以我也不知道为啥一定要看这篇文章而不是原文，唯一好处是我挑出了重点？官方教程文章太多，我只挑其中几篇重点，这是第一篇，全当自己记录了。</p>\n<p>仍然建议看原文。</p>\n<p>Halide 的 Vectorize, parallelize, unroll , tile 等优化策略与 TVM 的思路和写法基本相同，也是计算和调度分离的方式，是 AI 编译器中的重要内容。但是 TVM 的软件栈太大，学习较为困难，从 Halide 学习不失为一个好方法。</p>\n<p>参考链接：<a href=\"https://halide-lang.org/tutorials/tutorial_lesson_05_scheduling_1.html\">《Halide 官方教程》</a></p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"halide\"><a class=\"anchor\" href=\"#halide\">#</a> Halide</h1>\n<p>Halide 是一种专门设计的领域特定语言（DSL），主要用于编写高性能的图像处理和数组计算程序。它由 MIT 和 Adobe Research 的研究人员于 2010 年左右开发，并因其在优化复杂图像处理流水线方面的卓越能力而受到广泛关注。Halide 的核心创新在于将算法（What to compute）与调度（How and when to compute it）明确分离。<br>\nHalide 通常作为 C++ 的嵌入式 DSL 使用。你用 C++ 编写程序，在其中定义 Halide 的函数和调度。<br>\nHalide 编译器会将 Halide 代码（算法 + 调度）编译成高效的 C++ 或 GPU 代码（如 CUDA, OpenCL, Metal），然后链接到你的主程序中。<br>\n它拥有一个强大的 JIT（即时编译）和 AOT（提前编译）编译系统。</p>\n<h1 id=\"调度优化\"><a class=\"anchor\" href=\"#调度优化\">#</a> 调度优化</h1>\n<p>Halide 的 Vectorize, parallelize, unroll , tile 等优化策略与 TVM 的思路和写法基本相同。这里依次展示不同优化策略对代码产生的影响。</p>\n<h3 id=\"默认的运行顺序\"><a class=\"anchor\" href=\"#默认的运行顺序\">#</a> 默认的运行顺序</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gradient\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient row-major\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> output <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这是个简单的函数，将输入的  <code>4*4</code>  矩阵每个位置的行坐标和列坐标相加。输出 <code>4*4</code>  的结果。</p>\n<p>默认的执行顺序：计算顺序是 x 为内层循环， y 为外层循环，行主序。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Equivalent C:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>追踪打印计算过程如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">></span> Begin pipeline gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token operator\">></span> Tag gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> tag <span class=\"token operator\">=</span> <span class=\"token string\">\"func_type_and_dim: 1 0 32 1 2 0 4 0 4\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token operator\">></span> Store gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token operator\">></span> End pipeline gradient<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_05_row_major.gif\" alt=\"默认运行示例\"></p>\n<h3 id=\"reorder-variables\"><a class=\"anchor\" href=\"#reorder-variables\">#</a> Reorder variables</h3>\n<p>顺序重排，调整内外层循环的顺序，使用 <code>gradient.reorder(y, x)</code> 。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gradient_col_major\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">reorder</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 调整内外层循环的顺序</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient column-major\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> output <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>使用 C 表示为：其将 y 变成内层循环，x 变成外层循环。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Equivalent C:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_05_col_major.gif\" alt=\"reorder运行示例\"></p>\n<h3 id=\"split\"><a class=\"anchor\" href=\"#split\">#</a> Split</h3>\n<p>拆分，将一个变量拆分长两个。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gradient_split\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Var x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient with x split into x_outer and x_inner \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> output <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><code>gradient.split(x, x_outer, x_inner, 2)</code>  split 将 x 上的循环拆分成两个临近的循环  <code>x_outer, x_inner</code> ，最后一个参数  <code>2</code>  称为拆分因子（split factor），内循环 <code>x_inner</code>  会从 0 循环到拆分因子，外循环 <code>x_outer</code>  会从 0 循环到  <code>x/split factor</code>  。在循环内部，原来的变量 <code>x</code>  被定义为  <code>x_outer * factor + x_inner</code>  从而和原本的变量保持一致。假如旧的循环  <code>x</code>  并不是从 0 开始的，那么新的循环会将偏置单独加上。</p>\n<p>对应的 C 代码如下所示：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Equivalent C:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_outer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_outer <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> x_outer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_inner <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> x_inner<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> x_outer <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"fuse\"><a class=\"anchor\" href=\"#fuse\">#</a> Fuse</h3>\n<p>融合，将两个循环变量融合为一个。拆分的相反操作。它并不改变执行顺序</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gradient_fused\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Var fused<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">fuse</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> fused<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient with x and y fused\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> output <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>上述代码将 x 和 y 循环融合为一个，用 C 可以表示为：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Equivalent C:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> fused <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> fused <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span> <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> fused<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> fused <span class=\"token operator\">/</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> fused <span class=\"token operator\">%</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"evaluating-in-tiles\"><a class=\"anchor\" href=\"#evaluating-in-tiles\">#</a> Evaluating in tiles</h3>\n<p>分块计算。有了 split 和 reorder 之后，就可以进行分块计算了。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Var x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">,</span> y_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// operation 1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">,</span> y_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// operation 2</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">reorder</span><span class=\"token punctuation\">(</span>x_inner<span class=\"token punctuation\">,</span> y_inner<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// operation 3</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient in 4x4 tiles\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> output <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>以上三步操作将 x 和 y 都拆分成连个循环，并通过 reorder 交换  <code>y_inner, x_outer</code>  的循环顺序，使内层循环为  <code>x_inner, y_inner</code> 。</p>\n<p>当然，标准写法是：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">tile</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> y_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>这一行操作等效于上述三步操作。<br>\n用 C 可以表示为：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Equivalent C:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y_outer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y_outer <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> y_outer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_outer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_outer <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> x_outer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y_inner <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y_inner<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_inner <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x_inner<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> x_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> y_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> y_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_05_tiled.gif\" alt=\"tiles运行示例\"></p>\n<h3 id=\"evaluating-in-vectors\"><a class=\"anchor\" href=\"#evaluating-in-vectors\">#</a> Evaluating in vectors.</h3>\n<p>向量化。</p>\n<p>拆分可以使得最内层循环 变成从 0 循环到固定的拆分因子。因此适合进行向量化加速。比如 X86 架构拥有 SIMD 指令，支持一次性计算 4 个数据宽的向量计算，此时就可以将最内层循环拆分成 4 个。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gradient_in_vectors\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Var x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// operation 1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">vectorize</span><span class=\"token punctuation\">(</span>x_inner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// operation 2</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient with x_inner vectorized \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> output <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>上述操作将内层的拆分因子设置为 4，并进行向量化。<br>\n拆分 + 向量化足够常用，所以可以用以下一条指令代替上述两步操作：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">vectorize</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>对应的 C 代码表示  ：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Equivalent C:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_outer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_outer <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> x_outer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// The loop over x_inner has gone away, and has been</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// replaced by a vectorized version of the</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">// expression. On x86 processors, Halide generates SSE</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// for all of this.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">int</span> x_vec<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>x_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                       x_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                       x_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                       x_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> <span class=\"token number\">3</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">int</span> val<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span>x_vec<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> y<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                     x_vec<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> y<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                     x_vec<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> y<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                     x_vec<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> y<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at &lt;%d, %d, %d, %d>, &lt;%d, %d, %d, %d>:\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>               <span class=\"token string\">\" &lt;%d, %d, %d, %d>\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>               x_vec<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> x_vec<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> x_vec<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> x_vec<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>               y<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>               val<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_05_vectors.gif\" alt=\"vector运行示例\"></p>\n<h3 id=\"unrolling-a-loop\"><a class=\"anchor\" href=\"#unrolling-a-loop\">#</a> Unrolling a loop</h3>\n<p>循环展开。</p>\n<p>如果多个像素共享重叠的数据，那么展开计算使共享值只计算或加载一次是有意义的。该做法类似于向量化。拆分一个维度，然后完全展开内部变量的循环。展开不会改变求值的顺序。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gradient_unroll\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Var x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">unroll</span><span class=\"token punctuation\">(</span>x_inner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient unrolled by a factor of two\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> result <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>上述内容将 x 拆分，最内层循环为 2，然后将最内层 完全展开。</p>\n<p>更标准的写法：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">unroll</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>用 C 来表示：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Equivalent C:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_outer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_outer <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> x_outer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// Instead of a for loop over x_inner, we get two</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// copies of the innermost statement.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">int</span> x_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> x_outer <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">int</span> x_inner <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> x_outer <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"splitting-by-factors-that-dont-divide-the-extent\"><a class=\"anchor\" href=\"#splitting-by-factors-that-dont-divide-the-extent\">#</a> Splitting by factors that don't divide the extent.</h3>\n<p>拆分时因子不能除尽的情况。</p>\n<p>假如想要进行 split ，而总循环 x 不能被因子除尽时，会发生什么？</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Var x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient over a 7x2 box with x split by three \\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> output <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>上述例子使用 3 作为拆分因子来拆 x ，显然 7 不能被除尽。<br>\n仔细阅读下述 C 语言表示：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Equivalent C:\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_outer <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_outer <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> x_outer<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token comment\">// Now runs from 0 to 2</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_inner <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> x_inner<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> x_outer <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token comment\">// Before we add x_inner, make sure we don't</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token comment\">// evaluate points outside of the 7x2 box. We'll</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token comment\">// clamp x to be at most 4 (7 minus the split factor).</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">></span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> x <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            x <span class=\"token operator\">+=</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_05_split_7_by_3.gif\" alt=\"split_to_extent运行示例\"></p>\n<p>从 C 代码中可以发现，有部分数据进行了重复计算。一些坐标计算了两次。这通常是可以的，因为纯 Halide 函数没有副作用，所以对同一个点求多次是安全的。</p>\n<p>基本的规则是：</p>\n<p>如果 x 的循环范围 是 [x_min, x_min+x_extent] 的话，则：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// x_outer runs from 0 to (x_extent + factor - 1)/factor</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// x_inner runs from 0 to factor</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// x = min(x_outer * factor, x_extent - factor) + x_inner + x_min</span></pre></td></tr></table></figure><p>然而，如果编写的是具有更新定义的 Halide 函数，那么这种方式就是不安全的。</p>\n<h3 id=\"fusing-tiling-and-parallelizing\"><a class=\"anchor\" href=\"#fusing-tiling-and-parallelizing\">#</a> Fusing, tiling, and parallelizing</h3>\n<p>融合、切块和并行化。</p>\n<p>处理 tile 并行，当你想要跨多个维度并行而不引入嵌套并行时，融合是有帮助的。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gradient_fused_tiles\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">gradient</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">trace_stores</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Var x_outer<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> y_inner<span class=\"token punctuation\">,</span> tile_index<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">tile</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x_outer<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">,</span> x_inner<span class=\"token punctuation\">,</span> y_inner<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">fuse</span><span class=\"token punctuation\">(</span>x_outer<span class=\"token punctuation\">,</span> y_outer<span class=\"token punctuation\">,</span> tile_index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>gradient<span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span>tile_index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating gradient tiles in parallel\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Buffer<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> output <span class=\"token operator\">=</span> gradient<span class=\"token punctuation\">.</span><span class=\"token function\">realize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>以上代码实现了 x 和 y 两个维度的拆分，得到最内层 4*4 的 tile 块。然后将最外层  <code>x_outer, y_outer</code>  进行融合，在融合后的维度上执行并行。</p>\n<p>以下是 C 表示：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// This outermost loop should be a parallel for loop, but that's hard in C.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> tile_index <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> tile_index <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> tile_index<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token comment\">// 该维度并行</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">int</span> y_outer <span class=\"token operator\">=</span> tile_index <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">int</span> x_outer <span class=\"token operator\">=</span> tile_index <span class=\"token operator\">%</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> y_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y_inner <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> y_inner<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x_inner <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x_inner <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> x_inner<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> y_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> y_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> x_outer <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">+</span> x_inner<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Evaluating at x = %d, y = %d: %d\\n\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://halide-lang.org/tutorials/figures/lesson_05_parallel_tiles.gif\" alt=\"parallelizing运行示例\"></p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2025/10/06/tvmByoc02/",
            "url": "https://forcheetah.github.io/2025/10/06/tvmByoc02/",
            "title": "【BYOC】TVM切分子图",
            "date_published": "2025-10-06T08:19:48.714Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇通过举例说明 TVM 切分子图的方法。</p>\n<p>TVM 切分子图，是将整个图中的部分算子拆分出来，包装为一个函数。TVM 把它称为复合函数。切分子图有很多用处，比如算子融合、跨平台优化、做 layergroup 等。TVM 为子图切分提供了好用的工具，本篇文章将结 <a href=\"https://forcheetah.github.io/2025/05/11/tvmByoc01/\">《【BYOC】TVM 添加自定义编译器 ccompiler》</a>，来介绍一下如何使用 TVM 的工具切分子图，令自定义编译器 ccompiler 支持的子图在 ccompiler 执行，不支持的子图在 CPU 运行的。</p>\n<p>参考链接：<a href=\"https://forcheetah.github.io/2025/05/11/tvmByoc01/\">《【BYOC】TVM 添加自定义编译器 ccompiler》</a></p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"tvm工具\"><a class=\"anchor\" href=\"#tvm工具\">#</a> TVM 工具</h1>\n<p>TVM 需要一个注释器，为需要切分的图结构的起止地点标记出来，之后 TVM 就可以帮助将子图切分出来。<br>\n例如 TVM 支持 这个 DNNL 的外部编译器，那么可以使用  <code>mod = transform.AnnotateTarget([&quot;dnnl&quot;])(ref_mod)</code>  这个注释器来标记 DNNL 支持的子图结构（TVM 已经提供了 DNNL 的注释器），然后使用  <code>mod = transform.PartitionGraph()(mod)</code>  将子图切分出来。</p>\n<p>我们以 “将 ccompiler 支持的子图切分出来” 这个目标为例，介绍这个过程。<br>\nccompiler 只支持   <code>+ - *</code>  三个算子，目标是将所有 ccompiler 支持的算子切分成子图，交给 ccompiler 编译和计算，其他算子交给 CPU 计算。<br>\n如下图所示：<br>\n这个图中出现了一个  <code>/</code>  算子，需要将该算子留下来，其余算子切成子图，交给 ccompiler 进行编译和计算。</p>\n<p><img loading=\"lazy\" data-src=\"1759738691631.jpg\" alt=\"含有除法的图结构\"></p>\n<p>原图结构如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>fn <span class=\"token punctuation\">(</span>%x: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %w0: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %w1: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, flot32<span class=\"token punctuation\">]</span>, %w2: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %w3: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %w4: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  %0 <span class=\"token operator\">=</span> add<span class=\"token punctuation\">(</span>%x, %w1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  %1 <span class=\"token operator\">=</span> multiply<span class=\"token punctuation\">(</span>%x, %w0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  %2 <span class=\"token operator\">=</span> subtract<span class=\"token punctuation\">(</span>%0, %w2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  %3 <span class=\"token operator\">=</span> divide<span class=\"token punctuation\">(</span>%1, %2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  %4 <span class=\"token operator\">=</span> add<span class=\"token punctuation\">(</span>%3, %w3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  divide<span class=\"token punctuation\">(</span>%4, %w4<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>接下来需要将 ccompiler 支持的子图结构标记出来，标记原理如图所示：</p>\n<p><img loading=\"lazy\" data-src=\"1759738769337.jpg\" alt=\"标记子图的起始和终止节点\"></p>\n<p>图示比较清楚：将连续的、支持的算子，用 <code>begin</code>  和  <code>end</code>  隔离出来，形成一个子图。注释器的参考写法、调用例子，可以参考 TVM 官方代码。</p>\n<p>添加注释之后的图结构：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>def @main<span class=\"token punctuation\">(</span>%x: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %w0: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %w1: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, flot32<span class=\"token punctuation\">]</span>, %w2: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %w3: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %w4: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  %0 <span class=\"token operator\">=</span> annotation.compiler_begin<span class=\"token punctuation\">(</span>%x, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  %1 <span class=\"token operator\">=</span> annotation.compiler_begin<span class=\"token punctuation\">(</span>%w0, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  %2 <span class=\"token operator\">=</span> multiply<span class=\"token punctuation\">(</span>%0, %1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  %3 <span class=\"token operator\">=</span> annotation.compiler_begin<span class=\"token punctuation\">(</span>%x, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  %4 <span class=\"token operator\">=</span> annotation.compiler_begin<span class=\"token punctuation\">(</span>%w1, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  %5 <span class=\"token operator\">=</span> add<span class=\"token punctuation\">(</span>%3, %4<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  %6 <span class=\"token operator\">=</span> annotation.compiler_begin<span class=\"token punctuation\">(</span>%w2, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  %7 <span class=\"token operator\">=</span> subtract<span class=\"token punctuation\">(</span>%5, %6<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  %8 <span class=\"token operator\">=</span> annotation.compiler_end<span class=\"token punctuation\">(</span>%2, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  %9 <span class=\"token operator\">=</span> annotation.compiler_end<span class=\"token punctuation\">(</span>%7, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  %10 <span class=\"token operator\">=</span> divide<span class=\"token punctuation\">(</span>%8, %9<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  %11 <span class=\"token operator\">=</span> annotation.compiler_begin<span class=\"token punctuation\">(</span>%10, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  %12 <span class=\"token operator\">=</span> annotation.compiler_begin<span class=\"token punctuation\">(</span>%w3, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  %13 <span class=\"token operator\">=</span> add<span class=\"token punctuation\">(</span>%11, %12<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  %14 <span class=\"token operator\">=</span> annotation.compiler_end<span class=\"token punctuation\">(</span>%13, meta<span class=\"token punctuation\">[</span>relay.attrs.CompilerAttrs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  divide<span class=\"token punctuation\">(</span>%14, %w4<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>添加注释之后，直接调用 TVM 的切分工具： <code>mod = transform.PartitionGraph()(mod)</code> ，实现子图切分。</p>\n<p>切分之后的结构：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>def @main<span class=\"token punctuation\">(</span>%x: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %w0: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %w1: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %w2: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %w3: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %w4: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */<span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  %0 <span class=\"token operator\">=</span> @tvmgen_default_ccompiler_main_0<span class=\"token punctuation\">(</span>%x, %w0<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  %1 <span class=\"token operator\">=</span> @tvmgen_default_ccompiler_main_2<span class=\"token punctuation\">(</span>%x, %w1, %w2<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  %2 <span class=\"token operator\">=</span> divide<span class=\"token punctuation\">(</span>%0, %1<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  %3 <span class=\"token operator\">=</span> @tvmgen_default_ccompiler_main_5<span class=\"token punctuation\">(</span>%2, %w3<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  divide<span class=\"token punctuation\">(</span>%3, %w4<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>def @tvmgen_default_ccompiler_main_0<span class=\"token punctuation\">(</span>%ccompiler_0_i0: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %ccompiler_0_i1: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, <span class=\"token assign-left variable\">Compiler</span><span class=\"token operator\">=</span><span class=\"token string\">\"ccompiler\"</span>, <span class=\"token assign-left variable\">Primitive</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">Inline</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">global_symbol</span><span class=\"token operator\">=</span><span class=\"token string\">\"tvmgen_default_ccompiler_main_0\"</span><span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  multiply<span class=\"token punctuation\">(</span>%ccompiler_0_i0, %ccompiler_0_i1<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>def @tvmgen_default_ccompiler_main_2<span class=\"token punctuation\">(</span>%ccompiler_2_i0: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %ccompiler_2_i1: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %ccompiler_2_i2: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, <span class=\"token assign-left variable\">Compiler</span><span class=\"token operator\">=</span><span class=\"token string\">\"ccompiler\"</span>, <span class=\"token assign-left variable\">Primitive</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">Inline</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">global_symbol</span><span class=\"token operator\">=</span><span class=\"token string\">\"tvmgen_default_ccompiler_main_2\"</span><span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  %4 <span class=\"token operator\">=</span> add<span class=\"token punctuation\">(</span>%ccompiler_2_i0, %ccompiler_2_i1<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  subtract<span class=\"token punctuation\">(</span>%4, %ccompiler_2_i2<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>def @tvmgen_default_ccompiler_main_5<span class=\"token punctuation\">(</span>%ccompiler_5_i0: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, %ccompiler_5_i1: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */, <span class=\"token assign-left variable\">Compiler</span><span class=\"token operator\">=</span><span class=\"token string\">\"ccompiler\"</span>, <span class=\"token assign-left variable\">Primitive</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">Inline</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">global_symbol</span><span class=\"token operator\">=</span><span class=\"token string\">\"tvmgen_default_ccompiler_main_5\"</span><span class=\"token punctuation\">)</span> -<span class=\"token operator\">></span> Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  add<span class=\"token punctuation\">(</span>%ccompiler_5_i0, float32<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  add<span class=\"token punctuation\">(</span>%ccompiler_5_i0, %ccompiler_5_i1<span class=\"token punctuation\">)</span> /* <span class=\"token assign-left variable\">ty</span><span class=\"token operator\">=</span>Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span>, <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span> */</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>可以看到三个子图 <code>@tvmgen_default_ccompiler_main_0</code> ， <code>@tvmgen_default_ccompiler_main_2</code> ， <code>@tvmgen_default_ccompiler_main_5</code>  用单独的函数进行包装，在主函数中进行调用。</p>\n<p>可以通过 TVM 官方例子来学习如何写这个注释器。</p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2025/08/31/aicompile05/",
            "url": "https://forcheetah.github.io/2025/08/31/aicompile05/",
            "title": "【AI编译】张量生命周期管理",
            "date_published": "2025-08-31T02:20:00.996Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇文章总结【张量生命周期优化】算法。</p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"介绍\"><a class=\"anchor\" href=\"#介绍\">#</a> 介绍</h1>\n<p>AI 编译器设计中用于神经网络模型推理的内存管理模块， 通常被称为内存分配规划 或 张量生命周期优化。<br>\n为了减少内存占用，提高内存利用率，对 Tensor 的内存分配和生命周期的管理必不可少。</p>\n<p>内存分配就像是个拼图游戏，在二维坐标中，横轴是时间，纵轴是内容空间，然后将神经网络模型推理过程中需要用到的内存块， 拼到这个二维坐标中。</p>\n<p>神经网络模型推理主要涉及三部分 Tensor 内存占用：输入输出 tensor、权重 tensor、临时中间 tensor。将这些 tensor 拼接到如下的坐标轴中，横轴是内存空间，纵轴是周期 TimeStep，合理分配，以最大化内存利用率。</p>\n<p>如下图</p>\n<p><img loading=\"lazy\" data-src=\"1756606612420.jpg\" alt=\"算能无切分情况的分配\"></p>\n<p><a href=\"https://tpumlir.org/developer_manual_zh/10_layergroup.html\">图源 - 无切分情况的分配</a></p>\n<p>按照神经网络的执行顺序（拓扑顺序）来划分周期，以下面一个网络结构为例，周期可以如下划分。</p>\n<p><img loading=\"lazy\" data-src=\"1756606687361.jpg\" alt=\"算能LMEM的ID分配\"></p>\n<p><a href=\"https://tpumlir.org/developer_manual_zh/10_layergroup.html\">图源 - LMEM 的 ID 分配</a></p>\n<p><img loading=\"lazy\" data-src=\"1756606703569.jpg\" alt=\"算能TimeStep分配\"></p>\n<p><a href=\"https://tpumlir.org/developer_manual_zh/10_layergroup.html\">图源 - TimeStep 分配</a></p>\n<h1 id=\"算法\"><a class=\"anchor\" href=\"#算法\">#</a> 算法</h1>\n<p>只考虑静态内存分配。动态内存分配的 tensor 大小不固定、形状不固定，可能需要在推理过程中边推理边分配内存。但是静态情况下，需要开辟的空间时已知的。</p>\n<h2 id=\"贪心算法\"><a class=\"anchor\" href=\"#贪心算法\">#</a> 贪心算法</h2>\n<p>贪心算法的 “贪心” 体现在：在为当前要分配的张量做决策时，算法只着眼于 “当前这一步” 所能找到的最优解（即最能节省当前内存空间的放置位置），而不会为了全局最优（整个推理过程的绝对最低峰值内存）去考虑未来的张量该如何分配。这是一种局部最优（Local Optimal）策略，期望通过每一步的局部最优选择，最终得到一个接近全局最优的可行解。<br>\n1. 生命周期分析：首先，遍历计算图，为每个张量（Tensor）确定其 “出生时间”（定义或计算完成时）和 “死亡时间”（最后一次被使用时）。<br>\n2. 排序：将所有的张量按照其 “出生时间” 排序。<br>\n3. 分配：模拟一个从低地址到高地址的内存空间，可以用一个链表来存放。初始情况下链表中只有一个拥有所有空间、未占用的内存块。按顺序处理每个张量：检查当前所有未分配内存块，找到一个足够大的空闲内存块来存放新张量。张量生命周期结束时，即使释放对应的内存块，如果释放时前后内存连续，可以将其融合为一个大的内存块。<br>\n寻找空闲块的策略：</p>\n<ul>\n<li>首次适应（First-Fit）：从低地址开始扫描，找到第一个足够大的空闲块就分配。</li>\n<li>最佳适应（Best-Fit）：扫描所有空闲块，找到能满足需求且大小最接近的空闲块进行分配，以减少内存碎片。</li>\n<li>最坏适应（Worst-Fit）：总是选择最大的空闲块进行分配，试图避免产生非常小的碎片。</li>\n</ul>\n<p>贪心算法的优点：<br>\n高效：它的决策非常快，通常是 O (n) 或 O (n log n) 的复杂度，适合在编译器中快速完成内存规划。</p>\n<p>有效：对于大多数神经网络计算图，张量的生命周期分布使得这种 “短视” 的策略能得出一个非常不错、甚至是最优的解。</p>\n<p>实现简单：逻辑清晰，易于实现和调试。</p>\n<p>贪心的局限性：</p>\n<p>局部最优：由于缺乏全局视野，它无法保证结果一定是全局最优（峰值内存最低）的。在某些特定的张量生命周期和大小分布下，它可能会产生碎片或做出次优的决策。</p>\n<p>受分配策略影响：使用 First-Fit, Best-Fit, 还是 Worst-Fit，会得到不同的结果，需要根据实际情况进行选择。</p>\n<p>比如贪心算法会造成左图的情况，其显然不如右侧的分配方式好。</p>\n<p><img loading=\"lazy\" data-src=\"1756606721334.jpg\" alt=\"分配示例\"></p>\n<h2 id=\"束搜索算法\"><a class=\"anchor\" href=\"#束搜索算法\">#</a> 束搜索算法</h2>\n<p>束搜索是贪心算法的一种优雅扩展，它在 “每一步的局部最优” 和 “穷举搜索的全局最优” 之间找到了一个非常好的平衡点。</p>\n<ul>\n<li>贪心算法：在每一步，只选择当前看起来最好的一个选项，然后走下去，永不回头。它没有前瞻性。</li>\n<li>穷举搜索：考虑所有可能的路径，最终一定能找到全局最优解，但计算成本无法承受。</li>\n<li>束搜索：是两者的折中。它在每一步不是只保留 1 个候选解，而是保留最好的 k 个候选解（k 称为束宽）。这个 k 是一个可调的参数，k=1 时就是贪心算法，k=∞ 时就是穷举搜索。</li>\n<li></li>\n</ul>\n<p>假设我们按张量的开始时间排序后，得到一个待分配序列 [T1, T2, T3, ..., Tn]，束宽为 k。</p>\n<p>1. 初始化：</p>\n<ul>\n<li>创建一个集合  <code>beam</code> ，它代表当前代的候选状态。初始时，它只包含一个状态：空的内存空间，峰值内存为 0，下一个要分配的是 T1。</li>\n<li>beam = [initial_state]<br>\n 2. 循环（对于每一个要分配的张量）：</li>\n</ul>\n<p>a. 生成候选：对于  <code>beam</code>  中的每一个当前状态，生成所有可能分配下一个张量的方式。每个方式都会产生一个新的后继状态。</p>\n<ul>\n<li>例如，从当前状态 S 出发，分配 Ti 可能有 3 种方式：放入空闲块 A、放入空闲块 B、放到堆顶。这会生成 3 个新的状态 S_A, S_B, S_C。<br>\nb. 排序与剪枝：</li>\n<li>将所有新生成的后继状态（来自  <code>beam</code>  中所有父状态）合并到一个大列表中。</li>\n<li>根据评估函数（即当前的峰值内存）对这个大列表进行排序，选出最好的 k 个状态。</li>\n<li>丢弃掉所有其他状态。</li>\n<li>更新  <code>beam</code>  为这 k 个最好的后继状态。<br>\nc. 前进：处理下一个张量 T (i+1)。<br>\n3. 终止：</li>\n<li>当所有张量都分配完毕后， <code>beam</code>  集合中的 k 个状态就代表了 k 个完整的内存分配方案。</li>\n<li>从中选择峰值内存最小的那个方案作为最终结果。</li>\n</ul>\n<h2 id=\"总结\"><a class=\"anchor\" href=\"#总结\">#</a> 总结：</h2>\n<p>还有很多其他的算法，总结如下：</p>\n<p><img loading=\"lazy\" data-src=\"1756606772058.jpg\" alt=\"算法总结\"></p>\n<h1 id=\"绘图\"><a class=\"anchor\" href=\"#绘图\">#</a> 绘图</h1>\n<p>可以通过绘制甘特图来检查 Tensor 生命周期的分配情况。可以将信息输出为以下 .csv 文件：</p>\n<figure class=\"highlight txt\"><figcaption data-lang=\"txt\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>tensor_name,size,offset,start_time,end_time</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conv1_weight,102400,0,1,10</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>layer1_activation,204800,102400,5,15</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pool1_output,102400,102400,16,25</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>conv2_weight,204800,0,11,30</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>layer2_activation,409600,204800,20,35</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>output,102400,614400,36,40</pre></td></tr></table></figure><p>使用 Python 库来绘制甘特图，如下代码已经将数据进行归一化。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>patches <span class=\"token keyword\">as</span> patches</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 读取 CSV</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>df <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>read_csv<span class=\"token punctuation\">(</span><span class=\"token string\">'memory_plan.csv'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 计算相对比例</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>max_time <span class=\"token operator\">=</span> df<span class=\"token punctuation\">[</span><span class=\"token string\">'end_time'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>max_memory <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">[</span><span class=\"token string\">'offset'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> df<span class=\"token punctuation\">[</span><span class=\"token string\">'size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 归一化到 [0, 1] 范围</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>df<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_start'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> df<span class=\"token punctuation\">[</span><span class=\"token string\">'start_time'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> max_time</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>df<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_end'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> df<span class=\"token punctuation\">[</span><span class=\"token string\">'end_time'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> max_time</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>df<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_offset'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> df<span class=\"token punctuation\">[</span><span class=\"token string\">'offset'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> max_memory</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>df<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_size'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> df<span class=\"token punctuation\">[</span><span class=\"token string\">'size'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> max_memory</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>fig<span class=\"token punctuation\">,</span> ax <span class=\"token operator\">=</span> plt<span class=\"token punctuation\">.</span>subplots<span class=\"token punctuation\">(</span>figsize<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 调整画布大小</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 为每个 Tensor 绘制一个水平矩形条</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>colors <span class=\"token operator\">=</span> plt<span class=\"token punctuation\">.</span>cm<span class=\"token punctuation\">.</span>tab10<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>linspace<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> row <span class=\"token keyword\">in</span> df<span class=\"token punctuation\">.</span>iterrows<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    rect <span class=\"token operator\">=</span> patches<span class=\"token punctuation\">.</span>Rectangle<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_start'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_offset'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># (x, y) 左下角坐标</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_end'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_start'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>      <span class=\"token comment\"># 宽度</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_size'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>                         <span class=\"token comment\"># 高度</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        linewidth<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> edgecolor<span class=\"token operator\">=</span><span class=\"token string\">'black'</span><span class=\"token punctuation\">,</span> facecolor<span class=\"token operator\">=</span>colors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        alpha<span class=\"token operator\">=</span><span class=\"token number\">0.7</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        label<span class=\"token operator\">=</span>row<span class=\"token punctuation\">[</span><span class=\"token string\">'tensor_name'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    ax<span class=\"token punctuation\">.</span>add_patch<span class=\"token punctuation\">(</span>rect<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\"># 在矩形中部添加 Tensor 名称</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    ax<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">(</span>row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_start'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_end'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_offset'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> row<span class=\"token punctuation\">[</span><span class=\"token string\">'norm_size'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">/</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        row<span class=\"token punctuation\">[</span><span class=\"token string\">'tensor_name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        ha<span class=\"token operator\">=</span><span class=\"token string\">'center'</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        va<span class=\"token operator\">=</span><span class=\"token string\">'center'</span><span class=\"token punctuation\">,</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        fontsize<span class=\"token operator\">=</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        bbox<span class=\"token operator\">=</span><span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span>boxstyle<span class=\"token operator\">=</span><span class=\"token string\">\"round,pad=0.3\"</span><span class=\"token punctuation\">,</span> facecolor<span class=\"token operator\">=</span><span class=\"token string\">\"white\"</span><span class=\"token punctuation\">,</span> alpha<span class=\"token operator\">=</span><span class=\"token number\">0.7</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># 设置图表属性</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>ax<span class=\"token punctuation\">.</span>set_xlabel<span class=\"token punctuation\">(</span><span class=\"token string\">'Normalized Time Step'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>ax<span class=\"token punctuation\">.</span>set_ylabel<span class=\"token punctuation\">(</span><span class=\"token string\">'Normalized Memory Address'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>ax<span class=\"token punctuation\">.</span>set_title<span class=\"token punctuation\">(</span><span class=\"token string\">'Neural Network Memory Allocation Timeline\\nPeak Memory: &#123;:,&#125; Bytes'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>max_memory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\"># 添加网格</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>ax<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">(</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> linestyle<span class=\"token operator\">=</span><span class=\"token string\">'--'</span><span class=\"token punctuation\">,</span> alpha<span class=\"token operator\">=</span><span class=\"token number\">0.7</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\"># 添加图例</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>ax<span class=\"token punctuation\">.</span>legend<span class=\"token punctuation\">(</span>bbox_to_anchor<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1.05</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> loc<span class=\"token operator\">=</span><span class=\"token string\">'upper left'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token comment\"># 调整布局</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>plt<span class=\"token punctuation\">.</span>tight_layout<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\"># 保存和显示</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>plt<span class=\"token punctuation\">.</span>savefig<span class=\"token punctuation\">(</span><span class=\"token string\">'memory_timeline_normalized.png'</span><span class=\"token punctuation\">,</span> dpi<span class=\"token operator\">=</span><span class=\"token number\">150</span><span class=\"token punctuation\">,</span> bbox_inches<span class=\"token operator\">=</span><span class=\"token string\">'tight'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>plt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2025/05/11/tvmByoc01/",
            "url": "https://forcheetah.github.io/2025/05/11/tvmByoc01/",
            "title": "【BYOC】TVM添加自定义编译器 ccompiler",
            "date_published": "2025-05-11T12:40:38.618Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇介绍外部编译器：C 语言编译器 ccompiler 是什么。</p>\n<p>一些拓展链接。如果想多了解一些编译相关的内容，提高对 relay IR 的理解，可以学习 <a href=\"https://forcheetah.github.io/2025/03/13/compile01/\">《【编译器】使用 llvm 编译自定义语言【1】构建 AST》</a>，<a href=\"https://forcheetah.github.io/2024/10/13/tvm02/\">《【TVM】通过代码学习编译流程【2】模型转换》</a>，<a href=\"https://forcheetah.github.io/2025/03/28/compile03/\">《【编译器】使用 llvm 编译自定义语言【3】编译 object》</a>，<a href=\"https://llvm.org/docs/tutorial/MyFirstLanguageFrontend/index.html\">《My First Language Frontend with LLVM Tutorial》</a> 等。想了解更多 TVM，可以阅读<a href=\"https://zhuanlan.zhihu.com/p/446976730\">《深度学习编译器 TVM 代码串讲》</a>。</p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"例子\"><a class=\"anchor\" href=\"#例子\">#</a> 例子</h1>\n<p>如何编译 TVM，可以参考文章 [【TVM】通过代码学习编译流程【1】必要知识](<a href=\"https://forcheetah.github.io/2024/10/10/tvm01/%EF%BC%89%E4%B8%AD%E7%9A%84%E7%BC%96%E8%AF%91%E9%83%A8%E5%88%86%E3%80%82%E6%9C%AC%E6%96%87%E9%BB%98%E8%AE%A4%E8%AF%BB%E8%80%85%E5%B7%B2%E7%BB%8F%E8%83%BD%E5%A4%9F%E7%BC%96%E8%AF%91%E5%92%8C%E4%BD%BF%E7%94%A8TVM%E3%80%82\">https://forcheetah.github.io/2024/10/10/tvm01/）中的编译部分。本文默认读者已经能够编译和使用 TVM。</a></p>\n<p>TVM 的外部编译器例子: ccompiler 是一个简单的、仅支持 <code>+ - *</code>  运算的、编译为 C 源码的外部编译器。</p>\n<p>先看看 TVM 对 ccompiler 编译器的注册。位于 <code>src/relay/backend/contrib/codegen_c/target.cc</code> 。</p>\n<p>TVM 在这里注册了能够生成 C 源码，供本地 C 编译器编译的外部 CodeGen ccompiler。而交由 ccompiler 编译的函数需要被标记为 <code>Primitive</code>  和 <code>Compiler=ccompiler</code> ， <code>Primitive</code>  是告诉编译器该函数是原始不可分割的，relay 阶段不要分解和优化。 <code>Compiler=ccompiler</code>  是指定 CodeGen 为 ccompiler。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*!</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * \\brief This demonstration external codegen target emits C/C++ for compilation by the native c</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * compiler on CPU.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *  - Patterns: None, functions must be explicitly marked as \"Primitive\" and \"Compiler=ccompiler\".</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *  - Custom compiler: relay/backend/contrib/codegen_c/codegen.cc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">TVM_REGISTER_TARGET_KIND</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ccompiler\"</span><span class=\"token punctuation\">,</span> kDLCPU<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">set_attr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Bool<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>tvm<span class=\"token double-colon punctuation\">::</span>attr<span class=\"token double-colon punctuation\">::</span>kIsExternalCodegen<span class=\"token punctuation\">,</span> <span class=\"token function\">Bool</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">set_attr</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>relay<span class=\"token double-colon punctuation\">::</span>transform<span class=\"token double-colon punctuation\">::</span>FTVMRelayToTIR<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>tvm<span class=\"token double-colon punctuation\">::</span>attr<span class=\"token double-colon punctuation\">::</span>kRelayToTIR<span class=\"token punctuation\">,</span> <span class=\"token function\">CCompilerPass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// Value is prepended to every output CModule.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">add_attr_option</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"header\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>接下来用一个简单的例子调用 ccompiler 生成 C 语言，并编译和执行。</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> tvm</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> tvm <span class=\"token keyword\">import</span> relay</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> tvm<span class=\"token punctuation\">.</span>contrib <span class=\"token keyword\">import</span> graph_executor</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> collections <span class=\"token keyword\">import</span> OrderedDict</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">update_lib</span><span class=\"token punctuation\">(</span>lib<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># lib : llvmModuleNode   ret_.mod</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    kwargs <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    kwargs<span class=\"token punctuation\">[</span><span class=\"token string\">\"options\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"-O2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"-std=c++17\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    tmp_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/home/xianmu/temp/repare_test/\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    lib_name <span class=\"token operator\">=</span> <span class=\"token string\">\"lib.so\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    lib_path <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>tmp_path<span class=\"token punctuation\">,</span> lib_name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    lib<span class=\"token punctuation\">.</span>export_library<span class=\"token punctuation\">(</span>lib_path<span class=\"token punctuation\">,</span> fcompile<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> workspace_dir<span class=\"token operator\">=</span><span class=\"token string\">'/home/user/tempworkspace'</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    lib <span class=\"token operator\">=</span> tvm<span class=\"token punctuation\">.</span>runtime<span class=\"token punctuation\">.</span>load_module<span class=\"token punctuation\">(</span>lib_path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">return</span> lib</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">set_external_func_attr</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">,</span> compiler<span class=\"token punctuation\">,</span> ext_symbol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    func <span class=\"token operator\">=</span> func<span class=\"token punctuation\">.</span>with_attr<span class=\"token punctuation\">(</span><span class=\"token string\">\"Primitive\"</span><span class=\"token punctuation\">,</span> tvm<span class=\"token punctuation\">.</span>tir<span class=\"token punctuation\">.</span>IntImm<span class=\"token punctuation\">(</span><span class=\"token string\">\"int32\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    func <span class=\"token operator\">=</span> func<span class=\"token punctuation\">.</span>with_attr<span class=\"token punctuation\">(</span><span class=\"token string\">\"Compiler\"</span><span class=\"token punctuation\">,</span> compiler<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    func <span class=\"token operator\">=</span> func<span class=\"token punctuation\">.</span>with_attr<span class=\"token punctuation\">(</span><span class=\"token string\">\"global_symbol\"</span><span class=\"token punctuation\">,</span> ext_symbol<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">return</span> func</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">prepare_graph_lib</span><span class=\"token punctuation\">(</span>base_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    x <span class=\"token operator\">=</span> relay<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">(</span><span class=\"token string\">\"x\"</span><span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span><span class=\"token string\">\"float32\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    y <span class=\"token operator\">=</span> relay<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">(</span><span class=\"token string\">\"y\"</span><span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span><span class=\"token string\">\"float32\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    x0 <span class=\"token operator\">=</span> relay<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">(</span><span class=\"token string\">\"x0\"</span><span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span><span class=\"token string\">\"float32\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    y0 <span class=\"token operator\">=</span> relay<span class=\"token punctuation\">.</span>var<span class=\"token punctuation\">(</span><span class=\"token string\">\"y0\"</span><span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span><span class=\"token string\">\"float32\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    params <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"y0\"</span><span class=\"token punctuation\">:</span> np<span class=\"token punctuation\">.</span>ones<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span><span class=\"token string\">\"float32\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    f <span class=\"token operator\">=</span> relay<span class=\"token punctuation\">.</span>Function<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>x0<span class=\"token punctuation\">,</span> y0<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> x0 <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>x0 <span class=\"token operator\">+</span> y0<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> y0<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    f <span class=\"token operator\">=</span> set_external_func_attr<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ccompiler\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ccompiler_01\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 添加 `Primitive` 和 `Compiler=ccompiler` 标记</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    call <span class=\"token operator\">=</span> relay<span class=\"token punctuation\">.</span>Call<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    mod <span class=\"token operator\">=</span> tvm<span class=\"token punctuation\">.</span>IRModule<span class=\"token punctuation\">.</span>from_expr<span class=\"token punctuation\">(</span>call<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"----------------------------------------------\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>mod<span class=\"token punctuation\">.</span>script<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"----------------------------------------------\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\"># 编译 Relay->TIR</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    target <span class=\"token operator\">=</span> tvm<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>Target<span class=\"token punctuation\">(</span><span class=\"token string\">\"llvm\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">with</span> tvm<span class=\"token punctuation\">.</span>transform<span class=\"token punctuation\">.</span>PassContext<span class=\"token punctuation\">(</span>opt_level<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        compiled_lib <span class=\"token operator\">=</span> relay<span class=\"token punctuation\">.</span>build<span class=\"token punctuation\">(</span>mod<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">,</span> params<span class=\"token operator\">=</span>params<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># const_loader</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"=======================================================================================================\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    device <span class=\"token operator\">=</span> tvm<span class=\"token punctuation\">.</span>cpu<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    lib <span class=\"token operator\">=</span> update_lib<span class=\"token punctuation\">(</span>compiled_lib<span class=\"token punctuation\">.</span>get_lib<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    rt_mod <span class=\"token operator\">=</span> tvm<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>graph_executor<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span>compiled_lib<span class=\"token punctuation\">.</span>get_executor_config<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lib<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># runtime_mod  图执行器</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token comment\"># 模型执行</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    x_data <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>astype<span class=\"token punctuation\">(</span><span class=\"token string\">\"float32\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    y_data <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>random<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>astype<span class=\"token punctuation\">(</span><span class=\"token string\">\"float32\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    inputs <span class=\"token operator\">=</span> OrderedDict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token punctuation\">(</span><span class=\"token string\">\"y\"</span><span class=\"token punctuation\">,</span> y_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token punctuation\">(</span><span class=\"token string\">\"x\"</span><span class=\"token punctuation\">,</span> x_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token keyword\">for</span> name<span class=\"token punctuation\">,</span> data <span class=\"token keyword\">in</span> inputs<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        rt_mod<span class=\"token punctuation\">.</span>set_input<span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    rt_mod<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    out <span class=\"token operator\">=</span> tvm<span class=\"token punctuation\">.</span>nd<span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    out <span class=\"token operator\">=</span> rt_mod<span class=\"token punctuation\">.</span>get_output<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> out<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token comment\"># 保存模型</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    dylib_path <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>base_path<span class=\"token punctuation\">,</span> <span class=\"token string\">\"test_ccompiler.so\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    compiled_lib<span class=\"token punctuation\">.</span>get_lib<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>export_library<span class=\"token punctuation\">(</span>dylib_path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    curr_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/home/xianmu/temp/repare_test/\"</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">[</span><span class=\"token string\">\"TVM_HOME\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"/home/xianmu/TVM/tvm/\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    prepare_graph_lib<span class=\"token punctuation\">(</span>curr_path<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这段代码使用 relay 语言搭建了仅包含加减乘的模型  <code>x*(x+y)-y</code> ，并对其进行编译和调用执行。</p>\n<p>可以看到 <code>set_external_func_attr()</code>  函数为模型添加 <code>Primitive</code>  和 <code>Compiler=ccompiler</code>  标记，以告知 TVM 模型中的该函数使用 ccompiler 生成 code。</p>\n<p>以下是打印模型:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>def @main<span class=\"token punctuation\">(</span>%x: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span>, <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %y: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span>, <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  %2 <span class=\"token operator\">=</span> fn <span class=\"token punctuation\">(</span>%x0: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span>, <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, %y0: Tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span>, <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>, float32<span class=\"token punctuation\">]</span>, <span class=\"token assign-left variable\">Primitive</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, <span class=\"token assign-left variable\">Compiler</span><span class=\"token operator\">=</span><span class=\"token string\">\"ccompiler\"</span>, <span class=\"token assign-left variable\">global_symbol</span><span class=\"token operator\">=</span><span class=\"token string\">\"ccompiler_01\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    %0 <span class=\"token operator\">=</span> add<span class=\"token punctuation\">(</span>%x0, %y0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    %1 <span class=\"token operator\">=</span> multiply<span class=\"token punctuation\">(</span>%x0, %0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    subtract<span class=\"token punctuation\">(</span>%1, %y0<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  %2<span class=\"token punctuation\">(</span>%x, %y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>根据我们构建的模型，输出是个 5*5 的 tensor，不过由于输入都是随机的，所以每次结果也不一样。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>************** result **************</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>-0.2741713   <span class=\"token number\">0.08935148</span> <span class=\"token parameter variable\">-0.04881942</span> <span class=\"token parameter variable\">-0.02653596</span>  <span class=\"token number\">0.6241337</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token punctuation\">[</span> <span class=\"token number\">0.6122713</span>  <span class=\"token parameter variable\">-0.62298256</span>  <span class=\"token number\">0.68201226</span>  <span class=\"token number\">0.37773138</span> <span class=\"token parameter variable\">-0.4962681</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token punctuation\">[</span>-0.5679778   <span class=\"token number\">0.28375486</span>  <span class=\"token number\">0.38151044</span> <span class=\"token parameter variable\">-0.41397965</span> <span class=\"token parameter variable\">-0.3218666</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token punctuation\">[</span>-0.24529386 <span class=\"token parameter variable\">-0.4346298</span>  <span class=\"token parameter variable\">-0.10323387</span> <span class=\"token parameter variable\">-0.6108544</span>  -0.22057068<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token punctuation\">[</span>-0.44894195  <span class=\"token number\">0.16438246</span> <span class=\"token parameter variable\">-0.47126824</span>  <span class=\"token number\">0.546167</span>   <span class=\"token parameter variable\">-0.8994445</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h1 id=\"ccompiler\"><a class=\"anchor\" href=\"#ccompiler\">#</a> ccompiler</h1>\n<p>我们直接从 ccompiler 的 Codegen 结果来了解 ccompiler 这个编译器。</p>\n<p>编译过程中如果没有指定工作空间，TVM 会创建临时空间存放生成的 C 源码，并在用完之后释放掉临时空间。为了看到 ccompiler 生成的 C 源码，需要指定工作空间，即上述 Python 例子中：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>lib<span class=\"token punctuation\">.</span>export_library<span class=\"token punctuation\">(</span>lib_path<span class=\"token punctuation\">,</span> fcompile<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> workspace_dir<span class=\"token operator\">=</span><span class=\"token string\">'/home/user/tempworkspace'</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>工作空间下有三个生成文件： <code>lib0.c</code> 、 <code>lib1.o</code> 、 <code>devc.o</code></p>\n<p>其中 <code>lib1.o</code>  由 <code>ConstLoaderModule</code>  生成，可能用于常量的加载。</p>\n<p><code>devc.o</code>  和后端指定为 llvm 这种设备有关。</p>\n<p><code>lib0.c</code>  就是 ccompiler 生成的 C 源码：</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#include &lt;stdio.h>  // 从 1 到 23 行是固定输出代码（头文件和宏定义）</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#include &lt;stdlib.h></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#include  &lt;string.h></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#include &lt;tvm/runtime/c_runtime_api.h></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#include &lt;tvm/runtime/c_backend_api.h></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">#define CSOURCE_BINARY_OP_1D(p_ID_, p_OP_, p_DIM1_, p_DTYPE)       \\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      void p_ID_<span class=\"token punctuation\">(</span>p_DTYPE<span class=\"token operator\">*</span> a<span class=\"token punctuation\">,</span> p_DTYPE<span class=\"token operator\">*</span> b<span class=\"token punctuation\">,</span> p_DTYPE<span class=\"token operator\">*</span> out<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>    \\</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>int64_t i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> p_DIM1_<span class=\"token punctuation\">;</span> <span class=\"token operator\">+</span><span class=\"token operator\">+</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>                        \\</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          out<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> p_OP_ b<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>                                    \\</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>                                                              \\</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">#define CSOURCE_BINARY_OP_2D(p_ID_, p_OP_, p_DIM1_, p_DIM2_, p_DTYPE)  \\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      void p_ID_<span class=\"token punctuation\">(</span>p_DTYPE<span class=\"token operator\">*</span> a<span class=\"token punctuation\">,</span> p_DTYPE<span class=\"token operator\">*</span> b<span class=\"token punctuation\">,</span> p_DTYPE<span class=\"token operator\">*</span> out<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>        \\</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>int64_t i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> p_DIM1_<span class=\"token punctuation\">;</span> <span class=\"token operator\">+</span><span class=\"token operator\">+</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>                            \\</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>int64_t j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> p_DIM2_<span class=\"token punctuation\">;</span> <span class=\"token operator\">+</span><span class=\"token operator\">+</span>j<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>                          \\</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            int64_t k <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> p_DIM2_ <span class=\"token operator\">+</span> j<span class=\"token punctuation\">;</span>                                   \\</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            out<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> p_OP_ b<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>                                      \\</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span>                                                                \\</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>                                                                  \\</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>CSOURCE_BINARY_OP_2D<span class=\"token punctuation\">(</span>ccompiler_01_0<span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">float</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">//</span> 根据AST生成所有Call调用的函数</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>CSOURCE_BINARY_OP_2D<span class=\"token punctuation\">(</span>ccompiler_01_1<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">float</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>CSOURCE_BINARY_OP_2D<span class=\"token punctuation\">(</span>ccompiler_01_2<span class=\"token punctuation\">,</span> <span class=\"token operator\">+</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">float</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>void ccompiler_01_<span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token operator\">*</span> x0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">float</span><span class=\"token operator\">*</span> y0<span class=\"token punctuation\">,</span> <span class=\"token builtin\">float</span><span class=\"token operator\">*</span> out0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token operator\">//</span> 执行过程</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token builtin\">float</span><span class=\"token operator\">*</span> buf_0 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>malloc<span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token operator\">*</span> <span class=\"token number\">25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token builtin\">float</span><span class=\"token operator\">*</span> buf_1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>malloc<span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token operator\">*</span> <span class=\"token number\">25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token builtin\">float</span><span class=\"token operator\">*</span> buf_2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>malloc<span class=\"token punctuation\">(</span><span class=\"token number\">4</span> <span class=\"token operator\">*</span> <span class=\"token number\">25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  ccompiler_01_2<span class=\"token punctuation\">(</span>x0<span class=\"token punctuation\">,</span> y0<span class=\"token punctuation\">,</span> buf_0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token operator\">//</span> 依次调用函数</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  ccompiler_01_1<span class=\"token punctuation\">(</span>x0<span class=\"token punctuation\">,</span> buf_0<span class=\"token punctuation\">,</span> buf_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  ccompiler_01_0<span class=\"token punctuation\">(</span>buf_1<span class=\"token punctuation\">,</span> y0<span class=\"token punctuation\">,</span> buf_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  memcpy<span class=\"token punctuation\">(</span>out0<span class=\"token punctuation\">,</span> buf_2<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span> <span class=\"token operator\">*</span> <span class=\"token number\">25</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  free<span class=\"token punctuation\">(</span>buf_0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  free<span class=\"token punctuation\">(</span>buf_1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  free<span class=\"token punctuation\">(</span>buf_2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token builtin\">int</span> ccompiler_01_wrapper_<span class=\"token punctuation\">(</span>DLTensor<span class=\"token operator\">*</span> arg0<span class=\"token punctuation\">,</span>  <span class=\"token operator\">//</span> 函数封装</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tDLTensor<span class=\"token operator\">*</span> arg1<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tDLTensor<span class=\"token operator\">*</span> out0<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  ccompiler_01_<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>arg0<span class=\"token operator\">-</span><span class=\"token operator\">></span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>arg1<span class=\"token operator\">-</span><span class=\"token operator\">></span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">(</span><span class=\"token builtin\">float</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>out0<span class=\"token operator\">-</span><span class=\"token operator\">></span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">#ifdef __cplusplus</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>extern <span class=\"token string\">\"C\"</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">#endif</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>TVM_DLL int32_t ccompiler_01<span class=\"token punctuation\">(</span>TVMValue<span class=\"token operator\">*</span> args<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token operator\">*</span> type_code<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span> num_args<span class=\"token punctuation\">,</span> TVMValue<span class=\"token operator\">*</span> out_value<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token operator\">*</span> out_type_code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  DLTensor<span class=\"token operator\">*</span> arg0 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DLTensor<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TVMValue<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>v_handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  DLTensor<span class=\"token operator\">*</span> arg1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DLTensor<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TVMValue<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>v_handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  DLTensor<span class=\"token operator\">*</span> ret2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>DLTensor<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>TVMValue<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>v_handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  ccompiler_01_wrapper_<span class=\"token punctuation\">(</span>arg0<span class=\"token punctuation\">,</span>arg1<span class=\"token punctuation\">,</span>ret2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\">#ifdef __cplusplus</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\">#endif</span></pre></td></tr></table></figure><p>以上就是 ccompiler 编译器根据我们模型而生成的 C 源码。接下来结合 <code>x*(x+y)-y</code>  模型生成的 C 源码学习一下 ccompiler 代码：</p>\n<p><img loading=\"lazy\" data-src=\"1746967106488.jpg\" alt=\"ccompiler调用流程\"></p>\n<p>ccompiler 代码主要位于 <code>src/relay/backend/contrib/codegen_c/codegen.cc</code> ，它由函数 <code>CCompilerImpl()</code>  封装成一个 <code>Pass</code> 。</p>\n<p>从这个流程图中可以知道这个 pass 主要功能位于 <code>builder.VisitExpr()</code>  函数，它通过遍历抽象语法树 AST/Relay IR，生成 C 语言代码字符串。这个类是 <code>CodegenC</code> ，它继承自 TVM 提供的 AST/IR 遍历工具类 <code>ExprFunctor </code> 。</p>\n<p>我们知道遍历抽象语法树是编译器最基本的功能，为了方便，TVM 已经提供了用于遍历的工具类 <code>ExprFunctor </code> ，它主要提供了 VisitExpr 接口，并根据 Expr 的具体类型转发到对应的 VisitExpr_ 。我们只需要继承 <code>ExprFunctor </code> ，并重写 Expr 对应的 VisitExpr_ 方法，就可以方便得实现特定 Expr 的访问、修改等。大家可以阅读<a href=\"https://zhuanlan.zhihu.com/p/446976730\">《深度学习编译器 TVM 代码串讲》</a>以了解更多。</p>\n<p>再回到 ccompiler 编译器，其最主要重写的方法是 <code>VisitExpr_(const CallNode* call)</code> ，也就是将调用 Call 生成对应的 C 源代码。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>Output<span class=\"token operator\">></span> <span class=\"token function\">VisitExpr_</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> CallNode<span class=\"token operator\">*</span> call<span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ostringstream macro_stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ostringstream decl_stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>ostringstream buf_stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>string func_name <span class=\"token operator\">=</span> ext_func_id_ <span class=\"token operator\">+</span> <span class=\"token string\">\"_\"</span> <span class=\"token operator\">+</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span>func_idx<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// Make function declaration</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    macro_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"CSOURCE_BINARY_OP_\"</span> <span class=\"token operator\">&lt;&lt;</span> call<span class=\"token operator\">-></span>args<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"D(\"</span> <span class=\"token operator\">&lt;&lt;</span> func_name <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", \"</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 生成函数 CSOURCE_BINARY_OP_2D (ccompiler_01_0, -, 5, 5, float);</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>backend<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsOp</span><span class=\"token punctuation\">(</span>call<span class=\"token punctuation\">,</span> <span class=\"token string\">\"add\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      macro_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"+\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>backend<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsOp</span><span class=\"token punctuation\">(</span>call<span class=\"token punctuation\">,</span> <span class=\"token string\">\"subtract\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      macro_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"-\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>backend<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IsOp</span><span class=\"token punctuation\">(</span>call<span class=\"token punctuation\">,</span> <span class=\"token string\">\"multiply\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      macro_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>FATAL<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Unrecognized op\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">auto</span> in_shape <span class=\"token operator\">=</span> backend<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetShape</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">-></span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-></span><span class=\"token function\">checked_type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>size_t i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> in_shape<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      macro_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", \"</span> <span class=\"token operator\">&lt;&lt;</span> in_shape<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">auto</span><span class=\"token operator\">*</span> type_node <span class=\"token operator\">=</span> call<span class=\"token operator\">-></span><span class=\"token function\">checked_type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">as</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>TensorTypeNode<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token function\">ICHECK</span><span class=\"token punctuation\">(</span>type_node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;</span> dtype <span class=\"token operator\">=</span> <span class=\"token function\">GetDtypeString</span><span class=\"token punctuation\">(</span>type_node<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    macro_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", \"</span> <span class=\"token operator\">&lt;&lt;</span> dtype<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    macro_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\");\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    func_decl_<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>macro_stream<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\">// Make function call when visiting arguments</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">bool</span> first <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// 生成函数调用：ccompiler_01_2 (x0, y0, buf_0);</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    decl_stream <span class=\"token operator\">&lt;&lt;</span> func_name <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"(\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>size_t i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> call<span class=\"token operator\">-></span>args<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">auto</span> res <span class=\"token operator\">=</span> <span class=\"token function\">VisitExpr</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">-></span>args<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> out <span class=\"token operator\">:</span> res<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>first<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          decl_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", \"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        first <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        decl_stream <span class=\"token operator\">&lt;&lt;</span> out<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>string out <span class=\"token operator\">=</span> <span class=\"token string\">\"buf_\"</span> <span class=\"token operator\">+</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span>buf_idx_<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 生成内存分配 ：  float* buf_0 = (float*) malloc (4 * 25);</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">auto</span> out_shape <span class=\"token operator\">=</span> backend<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GetShape</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">-></span><span class=\"token function\">checked_type</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">int</span> out_size <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>size_t i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> out_shape<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      out_size <span class=\"token operator\">*=</span> out_shape<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    buf_stream <span class=\"token operator\">&lt;&lt;</span> dtype <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"* \"</span> <span class=\"token operator\">&lt;&lt;</span> out <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" = (\"</span> <span class=\"token operator\">&lt;&lt;</span> dtype <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"*)malloc(4 * \"</span> <span class=\"token operator\">&lt;&lt;</span> out_size <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\");\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    buf_decl_<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>buf_stream<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    decl_stream <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\", \"</span> <span class=\"token operator\">&lt;&lt;</span> out <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\");\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    ext_func_body_<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>decl_stream<span class=\"token punctuation\">.</span><span class=\"token function\">str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token comment\">// Update output buffer</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token comment\">// Note C codegen only handles TensorType. Therefore, we don't flatten</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token comment\">// tuples and only return a single vaule.</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    Output output<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    output<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> out<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    output<span class=\"token punctuation\">.</span>dtype <span class=\"token operator\">=</span> dtype<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    output<span class=\"token punctuation\">.</span>need_copy <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    output<span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> out_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">&#123;</span>output<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>VisitExpr_(const CallNode* call)</code>  函数只是将一些 C 源码字符串，分门别类地存储起来，后续会将其整合成完整的 C 源码。比如流程中 <code>Finalize()</code>  函数，添加了头文件宏定义等，并将所有的代码整合起来。</p>\n<h1 id=\"后续编译和执行\"><a class=\"anchor\" href=\"#后续编译和执行\">#</a> 后续编译和执行</h1>\n<p>获得 <code>lib0.c</code> 、 <code>lib1.o</code> 、 <code>devc.o</code>  文件之后的流程：TVM 会生成如下指令，调用系统中的 C 语言编译器，将 <code>lib0.c</code> 、 <code>lib1.o</code> 、 <code>devc.o</code>  编译成动态库。可以见工程 python/tvm/runtime/module.py，函数 <code>export_library()</code>  结尾 <code>fcompile()</code>  函数调用的指令。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token string\">'/usr/bin/g++'</span>, <span class=\"token string\">'-shared'</span>, <span class=\"token string\">'-fPIC'</span>, <span class=\"token string\">'-o'</span>, <span class=\"token string\">'/home/user/tempworkspace/test_ccompiler.so'</span>, <span class=\"token string\">'/home/user/tempworkspace/lib0.c'</span>, <span class=\"token string\">'/home/user/tempworkspace/lib1.o'</span>, <span class=\"token string\">'/home/user/tempworkspace/devc.o'</span>, <span class=\"token string\">'-I/home/user/TVM/include'</span>, <span class=\"token string\">'-I/home/user/TVM/3rdparty/dlpack/include'</span>, <span class=\"token string\">'-I/home/user/TVM/3rdparty/dmlc-core/include'</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>之后 TVM 重新加载动态库，并执行，具体还是见文章开头的 Python 脚本。</p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2025/02/05/aicompile04/",
            "url": "https://forcheetah.github.io/2025/02/05/aicompile04/",
            "title": "【AI编译】如何进行内存分配",
            "date_published": "2025-02-05T11:34:55.219Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本文讲解神经网络推理过程中的内存分配相关内容。</p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"tensor类型\"><a class=\"anchor\" href=\"#tensor类型\">#</a> Tensor 类型</h1>\n<p>不同的 tensor 有着不同的生命周期，神经网络推理过程中主要有三种 Tensor 类型：<br>\n1.<strong> 输入输出 tensor</strong><br>\n 输出 tensor 是下一节点的输入 tensor，它们一体两面，这种类型的 tensor 生命周期起于 “生产节点”，终于最后一个 “消费节点”。<br>\n2.<strong> 权重 tensor</strong><br>\n 权重 tensor 和算子绑定在一起，生命周期随着算子开始，也随算子结束。但也可能存在共享权重的情况，例如 tiling 操作产生的并行算子共享 Weight，<a href=\"https://tpumlir.org/docs/developer_manual/10_layergroup.html#mem\">算能 TPU 选择将 weight 常驻内存</a>。<br>\n3.<strong> 中间 tensor</strong><br>\n 中间 tensor 指的是算子计算时不得不开辟的临时空间，比如用来存储中间结果等，其大小和算子的具体实现有关。中间 tensor 的生命周期和权重 tensor 类似，随着算子开始，也随算子结束，但没有权重 tensor 的共享问题。</p>\n<h1 id=\"原地操作inplace-operation\"><a class=\"anchor\" href=\"#原地操作inplace-operation\">#</a> 原地操作（Inplace Operation）</h1>\n<p>原地覆盖不再需要的数据，不再开辟新的输出 tensor 空间。例如 Element-wise 算子、Relu 算子等可以在原地进行操作。</p>\n<p><img loading=\"lazy\" data-src=\"1738754981561.jpg\" alt=\"图 原地操作举例\"></p>\n<p>如图所示，B、C、D 三个 tensor 可以共用同一个内存空间。</p>\n<p><img loading=\"lazy\" data-src=\"1738755079647.jpg\" alt=\"图 原地操作举例2\"></p>\n<p>如图，当 B 的生命周期未结束时，C 不能共用 B 的内存空间。</p>\n<h1 id=\"内存共享memory-sharing\"><a class=\"anchor\" href=\"#内存共享memory-sharing\">#</a> 内存共享（Memory Sharing）</h1>\n<p>分析张量的生命周期，生命周期结束的张量及时释放，其所占据的空间可以被重复利用。拿算能 TPU 网站的图来举一个例子。如下图所示，这是一段简单的网络，有三个算子，分别是 Conv、Conv、和 Add。两个黑色的圆圈是权重，其余绿色的圆圈是输入输出 tensor 和中间 tensor。</p>\n<p><img loading=\"lazy\" data-src=\"1738755160616.jpg\" alt=\"图 算能TPU网络举例\"></p>\n<p>图源：<a href=\"https://tpumlir.org/docs/developer_manual/10_layergroup.html#mem\">算能 TPU 网络举例</a></p>\n<p><img loading=\"lazy\" data-src=\"1738755172523.jpg\" alt=\"图 算能TPU网络举例2\"></p>\n<p>图源：<a href=\"https://tpumlir.org/docs/developer_manual/10_layergroup.html#mem\">算能 TPU 内存生命周期</a></p>\n<p>上图展示了所有 tensor 的生命周期，三个算子的周期分别标记为 T2，T5 和 T7。</p>\n<ol>\n<li>0 号 tensor 是首个 Conv 节点的输入 tensor，W1 是权重，所以 T2 开始 T2 结束，及时释放；</li>\n<li>3 号 tensor 有两个消费节点，所以需要到 T7 才释放；<br>\n释放后的空间可以重复利用。</li>\n</ol>\n<h1 id=\"简单的分析规则\"><a class=\"anchor\" href=\"#简单的分析规则\">#</a> 简单的分析规则</h1>\n<p><img loading=\"lazy\" data-src=\"1738755220468.jpg\" alt=\"图 分析规则\"></p>\n<p>这里给出一个基本的 Tensor 生命周期分析流程，如图所示。可以通过这个流程来确定输入输出的生命周期。</p>\n<p>先初始化 tensor 的生命周期，它等于 tensor 的出度，也就是后面连着几个 “消费者节点”。<br>\n再按照执行顺序遍历网络结构，①如果当前节点的输入 Input 的生命周期大于 1，意味着它不能被释放，也不能被覆盖，需要为 Ouput 开辟新空间，同时 Input 生命周期减一；②如果当前节点的输入 Input 的生命周期等于 1，则进一步判断是否是 Inplace 节点；③如果不是 Inplace 节点，则仍需要为 Output 开辟空间，计算完成后 Input 可以释放；④是 Inplace 节点，则可以原地计算。</p>\n<h1 id=\"内存拼图游戏\"><a class=\"anchor\" href=\"#内存拼图游戏\">#</a> 内存拼图游戏</h1>\n<p>在完成网络的 Tensor 生命周期分析之后，就要尝试进行实际的内存分配，以确定设备内存是否足够放得下。建立一个坐标系，以横轴为时间 (Time)，纵轴为空间 (Addr)，把所有 tensor 作为一个图块拼进去，图块与图块之间不能有交叠，就像一个拼图游戏。<br>\n下图是算能 TPU 给出的内存分配例子，可供参考。不过这个图是以横轴为空间 (Addr)，纵轴为时间 (Time)。</p>\n<p><img loading=\"lazy\" data-src=\"1738755258225.jpg\" alt=\"图 算能TPU内存分配\"></p>\n<p>图源：<a href=\"https://tpumlir.org/docs/developer_manual/10_layergroup.html#mem\">算能 TPU 内存分配</a></p>\n<p>这个拼图游戏并没有看起来那么容易，当网络结构复杂的时候，tensor 大小多样，拼图的方式也多样。不同的拼图方式可能直接决定内存分配的成功与失败。这里举个简单的例子，如图所示：</p>\n<p><img loading=\"lazy\" data-src=\"1738755278680.jpg\" alt=\"图 内存分配例子\"></p>\n<p>假设有三个内存块需要分配，他们所占空间和生命周期都已经确定。设备内存只有 20 大小。假如按照左图的拼图方式，会发现图块③没有空间存放，超出内存限制。而采用右图的拼图方式，内存分配就顺利实现。</p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2025/01/15/aicompile03/",
            "url": "https://forcheetah.github.io/2025/01/15/aicompile03/",
            "title": "【AI编译】layer-group之后如何tiling",
            "date_published": "2025-01-15T13:12:53.246Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇讲解笔者实现 tiling 算法的一些经验。<br>\n前述文章 <a href=\"https://forcheetah.github.io/2025/01/14/aicompile02/\">《如何进行 layer-group》</a>讲解了 layer group 的内容。<a href=\"https://forcheetah.github.io/2024/10/18/aicompile01/\">《Tiling 操作能优化哪些时间》</a>提到 Tiling 的概念和作用。感兴趣的话可以阅读。</p>\n<p>本篇文章参考过 <a href=\"https://baijiahao.baidu.com/s?id=1787593090401250411&amp;wfr=spider&amp;for=pc\">《超强干货！地平线编译器大牛的编译优化实践总结》</a>，<a href=\"https://github.com/Arm-China/Compass_Optimizer\">《Arm 周易编译器工程》</a>，<a href=\"https://tpumlir.org/docs/developer_manual/10_layergroup.html#group\">《算能 TPU layer group 讲解》</a>，<a href=\"https://www.bilibili.com/video/BV1wo4y1z7AG/\">《算能 TPU 视频讲解》</a> 等文章和工程，欢迎大家参考。</p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"回顾\"><a class=\"anchor\" href=\"#回顾\">#</a> 回顾</h1>\n<p><img loading=\"lazy\" data-src=\"1736946396882.jpg\" alt=\"回顾流程\"></p>\n<p>如图所示，AI 编译优化的基本流程是 1. 图优化 (算子融合，常量折叠等) 2. 拆分 (layer group 和 tiling) 3. 并行和调度。最后得到当前编译的时间消耗。</p>\n<h1 id=\"分支结构tiling\"><a class=\"anchor\" href=\"#分支结构tiling\">#</a> 分支结构 Tiling</h1>\n<p><img loading=\"lazy\" data-src=\"1736946520498.jpg\" alt=\"分支结构\"></p>\n<p>假设现在对某个 layer group 做 tiling，需要对当前这个 layer group 按照 tiling 块数构建平行分支。</p>\n<p>上图来自<a href=\"https://tpumlir.org/docs/developer_manual/10_layergroup.html#group\">《算能 TPU layer group 讲解》</a>。如图所示，含有三个卷积算子的 layer group ，将其 tiling 成四块，则 group 的图结构变成右边的形状，图上也表明了 tiling 之后 tensor 的大小。可以使用 crop 算子完成 tensor 的切分，使用 concat 算子实现 tensor 的合并。图中没有画出 crop 算子和 concat 算子。</p>\n<p>神经网络结构复杂多样，分支结构、多前序节点、多后续节点等给 tiling 的实际操作带来很大困难。根据前述的 layer group 动态搜索划分，我们可能需要在各种各样的结构上进行 tiling 操作。下图是一种较为复杂的分支结构在 tiling 前后的对比图，可以给 tiling 结构的创建带来更直观的感受。</p>\n<p><img loading=\"lazy\" data-src=\"1736946566779.jpg\" alt=\"复杂分支结构tiling\"></p>\n<p>这是一个虚构的、较为复杂的分支结构。中间彩色的五个节点是当前要做 tiling 的 layer group，而上方和下方是当前 layer group 的前序节点和后续节点。<br>\n为方便，只 tiling 成两块。</p>\n<p>tiling 后的结构如图右侧所示，原有彩色算子部分复制成两份；layer group 有几个输出端（当前 group 有两个输出端：Conv 和 Fc）就有几个 concat 节点。layer group 的输入端（Add 节点和 Relu 节点）前面要添加 crop 节点，当输入端有多个前序节点时（Add 有两个前序节点），每个都要添加 crop。</p>\n<p>大致的结构重建就是这个样子。在实际操作中可能还有些不同，例如为保持所有节点都只能有一个输出 tensor 的原则，Crop 节点不能输出两个 tensor。</p>\n<h1 id=\"tiling维度\"><a class=\"anchor\" href=\"#tiling维度\">#</a> Tiling 维度</h1>\n<p>现有方案基本都选择在 N H W，也就是批次、高度、宽度这三个维度上做 tiling。</p>\n<p>N（批次）方向分块是最简单的方案，可以随意划分，对整个网络的运行没有影响。但是也许模型在推理的时候批次只有 1，无法 tiling。所以批次方向不是在所有情况下都适用。</p>\n<p>高度和宽度方向 tiling，比批次方向稍复杂，需要重新 infer shape 和调整参数（下一节讲解），但好在原有的算子推理仍然适用。</p>\n<p>基本上不考虑 C（通道）方向 tiling。通道方向分块，不仅要调整权重偏置 tensor，还需要在算子运算后加减 tensor，破坏了原有算子推理。<br>\n现有方案基本支持批次、高度、宽度这三个维度上做 tiling。</p>\n<h1 id=\"tiling逆向推理\"><a class=\"anchor\" href=\"#tiling逆向推理\">#</a> Tiling 逆向推理</h1>\n<p>上面只完成了 layer group 在 tiling 之后的结构重建。想要实现模型的正确推理，还需要更新好多信息。</p>\n<h2 id=\"逆向shape-推理\"><a class=\"anchor\" href=\"#逆向shape-推理\">#</a> 逆向 shape 推理</h2>\n<p>推理 shape，在 tensor 分块后，维度大小自然需要更新。下图是一个简单的分支结构的 tensor shape 推理例子。</p>\n<p><img loading=\"lazy\" data-src=\"1736946730182.jpg\" alt=\"逆向推理\"></p>\n<p>图①是推理之前的网络结构，仅包含两个卷积算子（均为 3*3，pad=1）。图上已经标明了每个算子的输入输出 tensor 的大小。现在将此 group 从 H（高）维度 tiling 成两份，也就是输出端（Add 节点）的输出 tensor 设置为 5*10。</p>\n<p>从输出端（Add 节点）开始逆序推导各个算子的输入输出 shape。如图②，普通算子如 Add，输入 tensor 的 shape 于输出 tensor 相同。而 Conv 这样的算子，需要根据参数、所在位置、输出 shape 来计算输入 tensor 的 shape。例如图②中 Conv_2 的输入变成 [6,10]，参数中 pad 需要修改为 [1,0,1,1]。</p>\n<p>现在出现一个问题：从 Add 节点直接往前推，Conv_1 的输出应该是 [5,10]，而走 Add-&gt;Conv_2 路径，Conv_1 的输出应该是 [6,10]。Conv_1 不可能同时输出 [6,10] 和 [5,10] 两个 tensor。如何处理当前的歧义呢？</p>\n<p>也许增加一个 crop 节点是个可选的方法。如图③所示，增加一个新的 Crop 节点，将 Conv_1 的输出 tensor 从 [6,10] 变成 [5,10]。</p>\n<h2 id=\"逆向深度优先搜索\"><a class=\"anchor\" href=\"#逆向深度优先搜索\">#</a> 逆向深度优先搜索</h2>\n<p>从逆向 shape 推理过程的分析来看，更新 layer group 的 shape，需要从输出端开始，逆向深度优先搜索每个分支，更新 shape 信息，还得判断采用哪些信息（如上一节中 Conv_1 的输出是 [6,10] 还是 [5,10]）。</p>\n<p>逆向深度优先搜索每个分支的意思如下图所示：从输出端搜索到输入端的每一条通路。下图结构中有四条通路。</p>\n<p><img loading=\"lazy\" data-src=\"1736946743244.jpg\" alt=\"深度优先搜索\"></p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2025/01/14/aicompile02/",
            "url": "https://forcheetah.github.io/2025/01/14/aicompile02/",
            "title": "【AI编译】如何进行layer-group",
            "date_published": "2025-01-14T12:09:18.353Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇介绍 AI 编译领域 layer-group 算法。</p>\n<p>本篇文章参考过 <a href=\"https://baijiahao.baidu.com/s?id=1787593090401250411&amp;wfr=spider&amp;for=pc\">《超强干货！地平线编译器大牛的编译优化实践总结》</a>，<a href=\"https://github.com/Arm-China/Compass_Optimizer\">《Arm 周易编译器工程》</a>，<a href=\"https://tpumlir.org/docs/developer_manual/10_layergroup.html#group\">《算能 TPU layer group 讲解》</a>，<a href=\"https://www.bilibili.com/video/BV1wo4y1z7AG/\">《算能 TPU 视频讲解》</a> 等文章和工程，欢迎大家参考。</p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"layer-group\"><a class=\"anchor\" href=\"#layer-group\">#</a> Layer group</h1>\n<p>如图所示，AI 编译优化的基本流程是 1. 图优化 (算子融合，常量折叠等) 2. 拆分 (layer group 和 tiling) 3. 并行和调度。最后得到当前编译的时间消耗。</p>\n<p><img loading=\"lazy\" data-src=\"1736856461365.jpg\" alt=\"如图1所示\"></p>\n<p>在 AI 编译领域，LayerGroup 指的是将神经网络中的多个层（layers (Operator) ）组合成一个逻辑单元或模块的过程。</p>\n<p>一般而言设备的运行内存很大，比如电脑的运行内存 16GB，但是它的速度比较慢，我们把它叫做 Global Memory。而做神经网络推理的专用 NPU 芯片，它的高速缓存速度很快，但是空间可能只有几 MB，我们把它叫做 Cache。我们无法将网络模型所有 layer 全部加载到 cache 中，那么意味着每个算子都需要 Cache 和外部 Global Memory 的交互，load 输入数据、store 结果。</p>\n<p>所以需要将网络拆分成小的 layer group。一般默认只有进入和退出 layer group 的时候，才需要和外部的 Global Memory 做 Load/Store 操作去交互。把需要的数据 load 进来，将结果数据 store 出去。layer group 减少了 Load/Store 操作，同时 layer group 也是后续 tiling、调度等操作的基本单元，降低了问题复杂度。</p>\n<h1 id=\"动态规划搜索\"><a class=\"anchor\" href=\"#动态规划搜索\">#</a> 动态规划搜索</h1>\n<p><img loading=\"lazy\" data-src=\"1736856461365.jpg\" alt=\"如图1所示\"></p>\n<p>还是这张图，如何划分 layer group 呢？图里面只有四个算子，可以 1,2 划分一组，3,4 划分一组；也可以 1 划为一组，2,3,4 划分另一组；甚至 1,2,3,4 全部划分为一组。不同的划分方式，最后得到的 Cost 也不同。<br>\n为了找到最优的划分方式，不得不搜索所有划分方案。</p>\n<p>假设网络有 n 层，则 n 层中间有 n-1 个间隔。选取 0 个间隔，也就是 n 层全部划分为一组，是 C (n-1, 0)；选取 1 个间隔，也就是分成两组，是 C (n-1,1)；选取 2 个间隔，也就是划分三组，是 C (n-1,2)；以此类推， C (n-1, 0)+C (n-1,1)+C (n-1,2)+……+C (n-1,n-1)，根据二项式定理，需要 2^(n-1) 次搜索。</p>\n<p>指数式增长计算量太大，是不可接受的。</p>\n<p>可以采用动态规划的思想来减少搜索次数。</p>\n<p>我们以 100 层网络为例。设 <code>f(n)</code>  为从第 0 层到达第 n 层最短用时。令  <code>f(-1) = 0</code>  ， <code>cost(x,y)</code>  为从 x 层到 y 层作为一个 group 的开销。则：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">min</span><span class=\"token punctuation\">(</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">;</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">;</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token number\">98</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token function\">cost</span><span class=\"token punctuation\">(</span><span class=\"token number\">99</span><span class=\"token punctuation\">,</span><span class=\"token number\">99</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>这就需要提前计算一个 cost table。</p>\n<p><img loading=\"lazy\" data-src=\"1736856527679.jpg\" alt=\"如图2所示\"></p>\n<p>cost table 如图所示。我们要做的就是以从 x 层到 y 层作为一个 group，计算开销 <code>cost(x,y)</code>  并保存下来。对于一个 n 层的网络来说，需要搜索的 layer group 数量为： 1+2+…+n = n (n+1)/2 。搜索次数从原来的 2^(n-1) 指数函数，已经降到幂函数。</p>\n<p>但是当网络层数过多时，搜索量还是很大，可以限制最大搜索长度，例如最长支持 50 层，那么 cost table 就变成下面这个样子：</p>\n<p><img loading=\"lazy\" data-src=\"1736856542354.jpg\" alt=\"如图3所示\"></p>\n<p>现在对于 n 层网络，搜索数量降到 50*n 。</p>\n<p>还可以启发式的剪枝优化，优化掉明显不会有收益的分支，进一步降低搜索的时间消耗。</p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n<p><code>runtime_mod</code></p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        },
        {
            "id": "https://forcheetah.github.io/2024/10/18/aicompile01/",
            "url": "https://forcheetah.github.io/2024/10/18/aicompile01/",
            "title": "【AI编译】Tiling操作能优化什么时间",
            "date_published": "2024-10-18T13:44:56.351Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>本篇讲解 Tiling 操作为什么能够优化神经网络推理。</p>\n<p>也可以参考 <a href=\"https://www.hiascend.com/developer/techArticles/20240920-1?envFlag=1\">《Ascend C 算子优化实用技巧 04——Tiling 优化》</a></p>\n<p>作为初学者，错误在所难免，还望不吝赐教。</p>\n<h1 id=\"什么是tiling\"><a class=\"anchor\" href=\"#什么是tiling\">#</a> 什么是 tiling</h1>\n<p>无法完整的容纳算子的输入与输出，需要每次搬运一部分输入进行计算然后搬出，再搬运下一部分输入进行计算，直到得到完整的最终结果，这个数据切分、分块计算的过程称之为 Tiling，切分数据的算法称为 Tiling 算法或者 Tiling 策略。</p>\n<h1 id=\"tile算子和tiling的区别\"><a class=\"anchor\" href=\"#tile算子和tiling的区别\">#</a> tile 算子和 tiling 的区别</h1>\n<p>我们先问一问语言大模型两者的区别：</p>\n<h2 id=\"神经网络推理中的tile算子\"><a class=\"anchor\" href=\"#神经网络推理中的tile算子\">#</a> 神经网络推理中的 Tile 算子</h2>\n<p>在神经网络中，会发现 tile 作为一个节点算子出现。Tile 算子（或称为 Tiling 操作）是一种张量操作，它的功能是将输入张量沿着指定的维度重复一定次数。该算子需要指定两个参数：</p>\n<ul>\n<li>1.reps<br>\n（重复次数）：这是一个整数列表，定义了每个维度上的重复次数。列表的长度必须与输入张量的维度相匹配，或者至少与你想要扩展的那些维度相匹配。如果对于某个维度你不希望进行复制，可以设置为 1。</li>\n<li>2.axis<br>\n（轴 / 维度）：虽然某些框架可能不需要显式指定轴，因为它们可以通过 reps 的结构来推断，但有些情况下需要明确指出哪些维度应该被复制。</li>\n</ul>\n<p>例如，假设有一个形状为 (2, 3) 的二维张量，并且你想沿第一个维度（行方向）重复两次，沿第二个维度（列方向）重复三次，那么你可以使用 Tile 算子并设置 reps=[2, 3]。这样操作后，输出张量将会是一个形状为 (4, 9) 的新张量，其中原始张量的内容被按照指定的方式进行了复制。</p>\n<p>在不同的深度学习库中，Tile 算子的实现可能会有所不同。例如，在 TensorFlow 中，它是 tf.tile () 函数；而在 PyTorch 中，则对应的是 torch.tile () 或者 .repeat () 方法。每种实现都有其特定的语法和用法，但核心概念是一致的。</p>\n<h2 id=\"ai编译优化中的tiling操作\"><a class=\"anchor\" href=\"#ai编译优化中的tiling操作\">#</a> AI 编译优化中的 tiling 操作</h2>\n<p>在 AI 编译领域，特别是针对深度学习模型的优化过程中，“tiling”（平铺）操作是指一种将计算任务分解成更小、更易于管理的子任务的技术。这种技术通常用于提高计算效率和内存使用效率，尤其是在处理大规模数据集或高维度张量时。</p>\n<p>Tiling 的主要目的是：</p>\n<ul>\n<li>1. 减少内存访问开销：通过将大块数据划分为较小的 “瓦片”，可以将这些小块数据加载到高速缓存中，从而减少对外部存储器的访问次数。这有助于利用 CPU 或 GPU 的高速缓存来加速计算过程。</li>\n<li>2. 并行化处理：每个 “瓦片” 可以独立处理，这意味着它们可以在多核处理器上并行执行，或者在 GPU 等并行计算架构上高效地分发给不同的线程或流处理器。</li>\n<li>3. 更好地利用硬件资源：通过适当调整瓦片大小，可以确保计算单元能够被充分利用，同时避免因单个任务过大导致的资源浪费。</li>\n<li>4. 改善局部性：合理设置的瓦片尺寸可以帮助保持良好的空间局部性和时间局部性，使得数据在被处理前已经被预取到了更快的存储层次中。</li>\n<li>5. 降低峰值内存需求：对于某些运算来说，一次性加载整个输入可能需要大量的内存。通过 tilling，我们可以仅处理当前所需的那部分数据，从而降低了对系统内存的需求。<br>\n例如，在卷积神经网络 (CNN) 中，一个常见的做法是将图像分割成多个小块，并且只在这些小块上进行卷积运算，而不是在整个图像上进行。这样做不仅可以减少每次计算所需的数据量，还能促进更好的并行化。</li>\n</ul>\n<p>Tiling 策略的选择取决于具体的硬件特性以及所处理数据的特点。在实际应用中，通常需要根据目标平台和具体应用场景来精心设计合适的 tilling 方案。一些自动化的工具和框架如 TensorFlow XLA、TVM (Tensor Virtual Machine) 等提供了高级别的 API 来帮助开发者实现高效的 tilling 优化。</p>\n<h2 id=\"两个tile是完全不同的概念\"><a class=\"anchor\" href=\"#两个tile是完全不同的概念\">#</a> 两个 tile 是完全不同的概念</h2>\n<p>两个 “tile” 概念虽然名字相似，但它们在不同的上下文中使用，并且具有不同的含义和用途：</p>\n<p>1. 神经网络中的 Tile 算子：</p>\n<ul>\n<li>在这个上下文中，Tile 是指一种张量操作，它将输入张量沿着指定维度重复一定次数。</li>\n<li>它主要用于数据处理阶段，例如当你需要复制或扩展张量以匹配某些特定的尺寸要求时。</li>\n<li>例子包括 TensorFlow 中的 tf.tile () 函数或 PyTorch 中的.repeat () 方法。</li>\n</ul>\n<p>2.AI 编译领域的 Tiling（平铺）：</p>\n<ul>\n<li>这里的 Tiling 是一种优化技术，用于将计算任务分解成更小的、可管理的部分，以便于更好地利用硬件资源，如缓存和并行计算能力。</li>\n<li>它通常是在模型优化阶段使用的，目的是提高计算效率、减少内存访问开销、促进并行化处理等。</li>\n<li>Tiling 可以应用于各种类型的运算，比如卷积运算中将图像分割成小块来处理。</li>\n</ul>\n<p>总结来说，尽管两者都涉及到了 “复制” 或 “分块” 的概念，但是神经网络中的 Tile 算子更多地关注于数据结构的操作，而 AI 编译领域的 Tiling 则是一个优化策略，旨在提升程序执行的性能。这两个概念分别属于数据处理和性能优化的不同领域。</p>\n<h1 id=\"案例\"><a class=\"anchor\" href=\"#案例\">#</a> 案例</h1>\n<p>一台电脑的内存很大，现在主流配置 16GB，甚至 32GB，虽然空间很大，但是它的速度比较慢，我们把它叫做 Global Memory。</p>\n<p>专用的 NPU 芯片用来做神经网络推理，它的高速缓存速度很快，但是空间可能只有几 MB，我们把它叫做 Cache。</p>\n<p>为了获取更快的运算速度，tensor 需要加载到 Cache 中进行计算，但是当算子需要占用的空间超过 Cache 的空间时，需要不断的进行数据搬运，导致算子搬入或搬出数据变为算子整个运行过程的性能瓶颈。</p>\n<p><img loading=\"lazy\" data-src=\"1729258859529.jpg\" alt=\"AI\"></p>\n<p>如上图所示：</p>\n<p>假设现在有 300 个数，需要连续经过三个 add 算子进行加操作，分别是 <code>add_1</code> ， <code>add_2</code>  和 <code>add_3</code> ，最终仍然输出 300 个数。</p>\n<p>但是 Cache 只能够存放 100 个数。</p>\n<p>在没有 tiling 操作的情况下：计算 <code>add_1</code>  时，需要将 (0,100) 个数 load 到 Cache，计算完毕后，需要将这 (0,100) store 回 global memory，为下一百个数腾出空间【接下来的计算 Cache 未命中】；然后加载 load (100,200) 的数据，继续计算 <code>add_1</code> 。以此类推，在没有 tiling 操作的情况下，计算完 <code>add_1</code> ， <code>add_2</code>  和 <code>add_3</code>  需要 load 和 store 操作的数据都是 900。</p>\n<p>在 tiling 的情况下，会提前将数据分块，分成 (0,100)，(100,200) 和 (200,300)。加载 (0,100)，接连计算 <code>add_1</code> ， <code>add_2</code>  和 <code>add_3</code> 。计算 <code>add_2</code>  时发现 Cache 中的数据正是所需要的数据【Cache 命中】。计算流程如图所示，整个计算下来，load 和 store 操作的数据都是 300。</p>\n<p><img loading=\"lazy\" data-src=\"a.jpg\" alt=\"图片\"></p>\n<p>tiling 操作提高了 cache 的命中率，避免了频繁搬运带来的时间损耗。<br>\n从图上看，同一 group 中包含的超出 cache 算子越多，tiling 带来的收益越大。</p>\n<h1 id=\"后记\"><a class=\"anchor\" href=\"#后记\">#</a> 后记</h1>\n<p>本博客目前以及可预期的将来都不会支持评论功能。各位大侠如若有指教和问题，可以在我的 <a href=\"https://github.com/ForCheetah/ForCheetah.github.io\">github 项目</a> 或随便一个项目下提出 issue，并指明哪一篇博客，我看到一定及时回复！</p>\n",
            "tags": [
                "compile",
                "AI"
            ]
        }
    ]
}